cscope 15 $HOME/Documents/system_learning/final -q 0000001373 0000185172
	@args.c

1 
	~<¨gs.h
>

2 
	~<°rög.h
>

5 
	$¨g°¨t
(*
¨gc
, **
¨gv
, 
Arg°©e
 *
¨gs
)

7 
¨gs
->
¨gc
 =árgc;

8 
¨gs
->
¨gv
 = (const **)árgv;

9 
¨gs
->
cuørg
 = (*
¨gc
 > 1 && 
¨gv
 ? "" : 0);

10 
¨gs
->
¨gvÆue
 = 0;

11 
	}
}

14 
	$¨g√xt
(
Arg°©e
 *
¨gs
)

16 
¨g
;

18 
¨gs
->
¨gvÆue
 = 0;

21 i‡(
¨gs
->
cuørg
 == 0)

24 i‡(!*
¨gs
->
cuørg
) {

27 i‡(*
¨gs
->
¨gc
 == 1

28 || 
¨gs
->
¨gv
[1][0] != '-'

29 || 
¨gs
->
¨gv
[1][1] == '\0')

30 
ídoÁrgs
;

32 
¨gs
->
cuørg
 =árgs->
¨gv
[1] + 1;

33 
	`memmove
(
¨gs
->
¨gv
 + 1,árgs->¨gv + 2, (c⁄° *Ë* (*¨gs->
¨gc
 - 1));

34 (*
¨gs
->
¨gc
)--;

36 i‡(
¨gs
->
cuørg
[0] == '-' &&árgs->curarg[1] == '\0')

37 
ídoÁrgs
;

40 
¨g
 = (Ë*
¨gs
->
cuørg
;

41 
¨gs
->
cuørg
++;

42  
¨g
;

44 
ídoÁrgs
:

45 
¨gs
->
cuørg
 = 0;

47 
	}
}

50 
	$¨gvÆue
(
Arg°©e
 *
¨gs
)

52  (*Ë(
¨gs
->
¨gvÆue
 ?árgs->¨gvÆuê: 
	`¨g√xtvÆue
(args));

53 
	}
}

56 
	$¨g√xtvÆue
(
Arg°©e
 *
¨gs
)

58 i‡(!
¨gs
->
cuørg
)

60 i‡(*
¨gs
->
cuørg
) {

61 
¨gs
->
¨gvÆue
 =árgs->
cuørg
;

62 
¨gs
->
cuørg
 = "";

63 } i‡(*
¨gs
->
¨gc
 > 1) {

64 
¨gs
->
¨gvÆue
 =árgs->
¨gv
[1];

65 
	`memmove
(
¨gs
->
¨gv
 + 1,árgs->¨gv + 2, (c⁄° *Ë* (*¨gs->
¨gc
 - 1));

66 (*
¨gs
->
¨gc
)--;

68 
¨gs
->
¨gvÆue
 = 0;

69 
¨gs
->
cuørg
 = 0;

71  (*Ë
¨gs
->
¨gvÆue
;

72 
	}
}

	@args.h

1 #i‚de‡
__ARGS


2 
	#__ARGS


	)

5 
	sArg°©e
 {

6 *
	m¨gc
;

7 c⁄° **
	m¨gv
;

8 c⁄° *
	mcuørg
;

9 c⁄° *
	m¨gvÆue
;

15 
¨g°¨t
(*
¨gc
, **
¨gv
, 
Arg°©e
 *
¨gs
);

29 
¨g√xt
(
Arg°©e
 *);

36 *
¨g√xtvÆue
(
Arg°©e
 *);

41 *
¨gvÆue
(
Arg°©e
 *);

	@bootutil.h

1 #i‚de‡
__BOOTUTIL


2 
	#__BOOTUTIL


	)

4 
	#STA_X
 0x8

5 
	#STA_E
 0x4

6 
	#STA_C
 0x4

7 
	#STA_W
 0x2

8 
	#STA_R
 0x2

9 
	#STA_A
 0x1

10 

	)

11 
	#SEG_NULL
 \

12 .
w‹d
 0, 0; \

13 .
byã
 0, 0, 0, 0

	)

14 
	#SEG
(
ty≥
,
ba£
,
lim
) \

15 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

16 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

17 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

	@console.c

1 
	~<x86.h
>

2 
	~<utû.h
>

3 
	~<c⁄sﬁe.h
>

4 
	~<°rög.h
>

5 
	~<°dio.h
>

7 
c⁄s_öå
((*
¥oc
)());

8 
	`c⁄s_putc
(
c
);

12 
	$dñay
()

14 
	`öb
(0x84);

15 
	`öb
(0x84);

16 
	`öb
(0x84);

17 
	`öb
(0x84);

18 
	}
}

22 
	#COM1
 0x3F8

	)

24 
	#COM_RX
 0

25 
	#COM_TX
 0

26 
	#COM_DLL
 0

27 
	#COM_DLM
 1

28 
	#COM_IER
 1

29 
	#COM_IER_RDI
 0x01

30 
	#COM_IIR
 2

31 
	#COM_FCR
 2

32 
	#COM_LCR
 3

33 
	#COM_LCR_DLAB
 0x80

34 
	#COM_LCR_WLEN8
 0x03

35 
	#COM_MCR
 4

36 
	#COM_MCR_RTS
 0x02

37 
	#COM_MCR_DTR
 0x01

38 
	#COM_MCR_OUT2
 0x08

39 
	#COM_LSR
 5

40 
	#COM_LSR_DATA
 0x01

41 
	#COM_LSR_TXRDY
 0x20

42 
	#COM_LSR_TSRE
 0x40

43 

	)

44 
boﬁ
 
	g£rül_exi°s
;

48 
	$£rül_¥oc_d©a
()

50 i‡(!(
	`öb
(
COM1
+
COM_LSR
Ë& 
COM_LSR_DATA
))

52  
	`öb
(
COM1
+
COM_RX
);

53 
	}
}

56 
	$£rül_öå
()

58 i‡(
£rül_exi°s
)

59 
	`c⁄s_öå
(
£rül_¥oc_d©a
);

60 
	}
}

63 
	$£rül_putc
(
c
)

65 
i
;

67 
i
 = 0;

68 !(
	`öb
(
COM1
 + 
COM_LSR
Ë& 
COM_LSR_TXRDY
Ë&& 
i
 < 12800;

69 
i
++)

70 
	`dñay
();

72 i‡(
c
 == '\b') {

73 
	`outb
(
COM1
 + 
COM_TX
, 
c
);

74 
i
 = 0;

75 !(
	`öb
(
COM1
 + 
COM_LSR
Ë& 
COM_LSR_TXRDY
Ë&& 
i
 < 12800;

76 
i
++)

77 
	`dñay
();

78 
	`outb
(
COM1
 + 
COM_TX
, ' ');

79 
i
 = 0;

80 !(
	`öb
(
COM1
 + 
COM_LSR
Ë& 
COM_LSR_TXRDY
Ë&& 
i
 < 12800;

81 
i
++)

82 
	`dñay
();

83 
	`outb
(
COM1
 + 
COM_TX
, 
c
);

87 
	`outb
(
COM1
 + 
COM_TX
, 
c
);

88 
	}
}

91 
	$£rül_öô
()

94 
	`outb
(
COM1
+
COM_FCR
, 0);

97 
	`outb
(
COM1
+
COM_LCR
, 
COM_LCR_DLAB
);

98 
	`outb
(
COM1
+
COM_DLL
, (
uöt8_t
) (115200 / 9600));

99 
	`outb
(
COM1
+
COM_DLM
, 0);

102 
	`outb
(
COM1
+
COM_LCR
, 
COM_LCR_WLEN8
 & ~
COM_LCR_DLAB
);

105 
	`outb
(
COM1
+
COM_MCR
, 0);

107 
	`outb
(
COM1
+
COM_IER
, 
COM_IER_RDI
);

111 
£rül_exi°s
 = (
	`öb
(
COM1
+
COM_LSR
) != 0xFF);

112 (Ë
	`öb
(
COM1
+
COM_IIR
);

113 (Ë
	`öb
(
COM1
+
COM_RX
);

115 
	}
}

118 
	gaddr_6845
;

119 
uöt16_t
 *
	g¸t_buf
;

120 
uöt16_t
 
	g¸t_pos
;

124 
	$cga_öô
()

126 vﬁ©ûê
uöt16_t
 *
˝
;

127 
uöt16_t
 
was
;

128 
pos
;

130 
˝
 = (
uöt16_t
*Ë(
KERNBASE
 + 
CGA_BUF
);

131 
was
 = *
˝
;

132 *
˝
 = (
uöt16_t
) 0xA55A;

133 i‡(*
˝
 != 0xA55A) {

134 
˝
 = (
uöt16_t
*Ë(
KERNBASE
 + 
MONO_BUF
);

135 
addr_6845
 = 
MONO_BASE
;

137 *
˝
 = 
was
;

138 
addr_6845
 = 
CGA_BASE
;

142 
	`outb
(
addr_6845
, 14);

143 
pos
 = 
	`öb
(
addr_6845
 + 1) << 8;

144 
	`outb
(
addr_6845
, 15);

145 
pos
 |
	`öb
(
addr_6845
 + 1);

147 
¸t_buf
 = (
uöt16_t
*Ë
˝
;

148 
¸t_pos
 = 
pos
;

149 
	}
}

152 
	$cga_putc
(
c
)

155 i‡(!(
c
 & ~0xFF))

156 
c
 |= 0x0700;

158 
c
 & 0xff) {

160 i‡(
¸t_pos
 > 0) {

161 
¸t_pos
--;

162 
¸t_buf
[
¸t_pos
] = (
c
 & ~0xff) | ' ';

166 
¸t_pos
 +
CRT_COLS
;

169 
¸t_pos
 -(¸t_po†% 
CRT_COLS
);

172 
	`c⁄s_putc
(' ');

173 
	`c⁄s_putc
(' ');

174 
	`c⁄s_putc
(' ');

175 
	`c⁄s_putc
(' ');

178 
¸t_buf
[
¸t_pos
++] = 
c
;

182 i‡(
¸t_pos
 >
CRT_SIZE
) {

183 
i
;

185 
	`memmove
(
¸t_buf
, cπ_bu‡+ 
CRT_COLS
, (
CRT_SIZE
 - CRT_COLSË* (
uöt16_t
));

186 
i
 = 
CRT_SIZE
 - 
CRT_COLS
; i < CRT_SIZE; i++)

187 
¸t_buf
[
i
] = 0x0700 | ' ';

188 
¸t_pos
 -
CRT_COLS
;

191 
	`outb
(
addr_6845
, 14);

192 
	`outb
(
addr_6845
 + 1, 
¸t_pos
 >> 8);

193 
	`outb
(
addr_6845
, 15);

194 
	`outb
(
addr_6845
 + 1, 
¸t_pos
);

195 
	}
}

199 
	$c⁄s_putc
(
c
)

201 
	`£rül_putc
(
c
);

202 
	`cga_putc
(
c
);

203 
	}
}

206 
	$c⁄s_öô
()

208 
	`cga_öô
();

209 
	`£rül_öô
();

210 
	}
}

214 
	$¥öt°r
(* 
°r
)

216 c⁄° 
max_°r_Àn
 = 100;

217 
˙t
 = 0;

218 *
°r
 && 
˙t
++ < 
max_°r_Àn
)

219 
	`c⁄s_putc
(*(
°r
++));

220 
	}
}

224 
	#NO
 0

	)

226 
	#SHIFT
 (1<<0)

	)

227 
	#CTL
 (1<<1)

	)

228 
	#ALT
 (1<<2)

	)

230 
	#CAPSLOCK
 (1<<3)

	)

231 
	#NUMLOCK
 (1<<4)

	)

232 
	#SCROLLLOCK
 (1<<5)

	)

234 
	#E0ESC
 (1<<6)

	)

236 
uöt8_t
 
	gshi·code
[256] =

238 [0x1D] = 
CTL
,

239 [0x2A] = 
SHIFT
,

240 [0x36] = 
SHIFT
,

241 [0x38] = 
ALT
,

242 [0x9D] = 
CTL
,

243 [0xB8] = 
ALT


246 
uöt8_t
 
	gtoggÀcode
[256] =

248 [0x3A] = 
CAPSLOCK
,

249 [0x45] = 
NUMLOCK
,

250 [0x46] = 
SCROLLLOCK


253 
uöt8_t
 
	gn‹mÆm≠
[256] =

255 
NO
, 0x1B, '1', '2', '3', '4', '5', '6',

258 'o', 'p', '[', ']', '\n', 
NO
, 'a', 's',

260 '\'', '`', 
NO
, '\\', 'z', 'x', 'c', 'v',

261 'b', 'n', 'm', ',', '.', '/', 
NO
, '*',

262 
NO
, ' ', NO, NO, NO, NO, NO, NO,

263 
NO
, NO, NO, NO, NO, NO, NO, '7',

265 '2', '3', '0', '.', 
NO
, NO, NO, NO,

266 [0xC7] = 
KEY_HOME
, [0x9C] = '\n' ,

267 [0xB5] = '/' , [0xC8] = 
KEY_UP
,

268 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

269 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

270 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

271 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


274 
uöt8_t
 
	gshi·m≠
[256] =

276 
NO
, 033, '!', '@', '#', '$', '%', '^',

279 'O', 'P', '{', '}', '\n', 
NO
, 'A', 'S',

281 '"', '~', 
NO
, '|', 'Z', 'X', 'C', 'V',

282 'B', 'N', 'M', '<', '>', '?', 
NO
, '*',

283 
NO
, ' ', NO, NO, NO, NO, NO, NO,

284 
NO
, NO, NO, NO, NO, NO, NO, '7',

286 '2', '3', '0', '.', 
NO
, NO, NO, NO,

287 [0xC7] = 
KEY_HOME
, [0x9C] = '\n' ,

288 [0xB5] = '/' , [0xC8] = 
KEY_UP
,

289 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

290 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

291 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

292 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


295 
	#C
(
x
Ë(x - '@')

	)

297 
uöt8_t
 
	g˘lm≠
[256] =

299 
NO
, NO, NO, NO, NO, NO, NO, NO,

300 
NO
, NO, NO, NO, NO, NO, NO, NO,

301 
C
('Q'), C('W'), C('E'), C('R'), C('T'), C('Y'), C('U'), C('I'),

302 
C
('O'), C('P'), 
NO
, NO, '\r', NO, C('A'), C('S'),

303 
C
('D'), C('F'), C('G'), C('H'), C('J'), C('K'), C('L'), 
NO
,

304 
NO
, NO, NO, 
C
('\\'), C('Z'), C('X'), C('C'), C('V'),

305 
C
('B'), C('N'), C('M'), 
NO
, NO, C('/'), NO, NO,

306 [0x97] = 
KEY_HOME
,

307 [0xB5] = 
C
('/'), [0xC8] = 
KEY_UP
,

308 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

309 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

310 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

311 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


314 
uöt8_t
 *
	gch¨code
[4] = {

315 
n‹mÆm≠
,

316 
shi·m≠
,

317 
˘lm≠
,

318 
˘lm≠


326 
	$kbd_¥oc_d©a
()

328 
c
;

329 
uöt8_t
 
d©a
;

330 
uöt32_t
 
shi·
;

332 i‡((
	`öb
(
KBSTATP
Ë& 
KBS_DIB
) == 0)

335 
d©a
 = 
	`öb
(
KBDATAP
);

337 i‡(
d©a
 == 0xE0) {

339 
shi·
 |
E0ESC
;

341 } i‡(
d©a
 & 0x80) {

343 
d©a
 = (
shi·
 & 
E0ESC
 ? data : data & 0x7F);

344 
shi·
 &~(
shi·code
[
d©a
] | 
E0ESC
);

346 } i‡(
shi·
 & 
E0ESC
) {

348 
d©a
 |= 0x80;

349 
shi·
 &~
E0ESC
;

352 
shi·
 |
shi·code
[
d©a
];

353 
shi·
 ^
toggÀcode
[
d©a
];

355 
c
 = 
ch¨code
[
shi·
 & (
CTL
 | 
SHIFT
)][
d©a
];

356 i‡(
shi·
 & 
CAPSLOCK
) {

357 i‡('a' <
c
 && c <= 'z')

358 
c
 += 'A' - 'a';

359 i‡('A' <
c
 && c <= 'Z')

360 
c
 += 'a' - 'A';

364 i‡(!(~
shi·
 & (
CTL
 | 
ALT
)Ë&& 
c
 =
KEY_DEL
) {

365 
	`¥öt°r
("Rebooting!\n");

366 
	`outb
(0x92, 0x3);

369  
c
;

370 
	}
}

373 
	$kbd_öå
()

375 
	`c⁄s_öå
(
kbd_¥oc_d©a
);

376 
	}
}

385 
	#CONSBUFSIZE
 512

	)

388 
uöt8_t
 
	mbuf
[
CONSBUFSIZE
];

389 
uöt32_t
 
	mΩos
;

390 
uöt32_t
 
	mwpos
;

391 } 
	gc⁄s
;

396 
	$c⁄s_öå
((*
¥oc
)())

398 
c
;

400 (
c
 = (*
¥oc
)()) != -1) {

401 i‡(
c
 == 0)

403 
c⁄s
.
buf
[c⁄s.
wpos
++] = 
c
;

404 i‡(
c⁄s
.
wpos
 =
CONSBUFSIZE
)

405 
c⁄s
.
wpos
 = 0;

407 
	}
}

411 
	$c⁄s_gëc
()

413 
c
;

418 
	`£rül_öå
();

419 
	`kbd_öå
();

422 i‡(
c⁄s
.
Ωos
 !c⁄s.
wpos
) {

423 
c
 = 
c⁄s
.
buf
[c⁄s.
Ωos
++];

424 i‡(
c⁄s
.
Ωos
 =
CONSBUFSIZE
)

425 
c⁄s
.
Ωos
 = 0;

426  
c
;

429 
	}
}

435 
	$˝utch¨
(
c
)

437 
	`c⁄s_putc
(
c
);

438 
	}
}

441 
	$gëch¨
()

443 
c
;

445 (
c
 = 
	`c⁄s_gëc
()) == 0)

447  
c
;

448 
	}
}

453 
	$isc⁄s
(
fdnum
)

457 
	}
}

	@console.h

1 #i‚de‡
__CONSOLE


2 
	#__CONSOLE


	)

4 
	#MONO_BASE
 0x3B4

	)

5 
	#MONO_BUF
 0xB0000

	)

6 
	#CGA_BASE
 0x3D4

	)

7 
	#CGA_BUF
 0xB8000

	)

9 
	#CRT_ROWS
 25

	)

10 
	#CRT_COLS
 80

	)

11 
	#CRT_SIZE
 (
CRT_ROWS
 * 
CRT_COLS
)

	)

13 
c⁄s_öô
();

14 
c⁄s_gëc
();

15 
¥öt°r
(* 
°r
);

17 
kbd_öå
();

18 
£rül_öå
();

20 
isc⁄s
(
fdnum
);

	@damnfs.c

2 
	~<sy¶ib.h
>

4 
	~<damnfs.h
>

5 
	~<ide.h
>

8 vﬁ©ûê
DamnSu≥r
 * 
	gsu≥r
;

9 vﬁ©ûê
DamnInode
 * 
	göodes
;

17 
	$check_su≥r
()

19 i‡(
su≥r
->
magic
 !
DAMN_MAGIC
)

20 
	`∑nic
("bad file system magicÇumber");

22 i‡(
su≥r
->
blk_num
 > 
DISKSIZE
/
BLKSIZE
)

23 
	`∑nic
("file system isÅooÜarge");

25 
	`˝rötf
("superblock is good\n");

26 
	}
}

34 
boﬁ


35 
	$block_is_‰ì
(
uöt16_t
 
blockno
)

37 i‡(
su≥r
 =0 || 
blockno
 >su≥r->
blk_num
)

39 i‡((
su≥r
->
blk_o˝
[
blockno
 / 32] & (1 << (blockno % 32))) == 0)

42 
	}
}

46 
	$‰ì_block
(
uöt16_t
 
blockno
)

49 i‡(
blockno
 == 0)

50 
	`∑nic
("attemptÅo free zero block");

51 
su≥r
->
blk_o˝
[
blockno
/32] &= ~(1<<(blockno%32));

52 
	`Êush_block
(
su≥r
);

53 
	}
}

57 
boﬁ


58 
	$öode_is_‰ì
(
uöt16_t
 
öodío
)

60 i‡(
su≥r
 =0 || 
öodío
 >su≥r->
ö_num
)

62 i‡((
su≥r
->
ö_o˝
[
öodío
 / 32] & (1 << (inodeno % 32))) == 0)

65 
	}
}

69 
	$‰ì_öode
(
uöt16_t
 
öodío
)

72 i‡(
öodío
 == 0)

73 
	`∑nic
("attemptÅo free zero inode");

74 
su≥r
->
ö_o˝
[
öodío
/32] &= ~(1<<(inodeno%32));

75 
	`Êush_block
(
su≥r
);

76 
	}
}

86 
	$Æloc_block
()

91 
blockno
;

92 
blockno
 = 0; blocknÿ< 
su≥r
->
blk_num
; ++blockno)

94 if(
	`block_is_‰ì
(
blockno
))

96 
su≥r
->
blk_o˝
[
blockno
 / 32] |= 1 << (blockno % 32);

97 
	`Êush_block
(
su≥r
);

98  
blockno
;

101  -
E_NO_DISK
;

102 
	}
}

106 
	$Æloc_öode
()

111 
öodío
;

112 
öodío
 = 0; inodíÿ< 
su≥r
->
ö_num
; ++inodeno)

114 if(
	`öode_is_‰ì
(
öodío
))

116 
su≥r
->
ö_o˝
[
öodío
 / 32] |= 1 << (inodeno % 32);

117 
	`Êush_block
(
su≥r
);

118  
öodío
;

121  -
E_NO_INODE
;

122 
	}
}

133 
	$fs_öô
()

137 i‡(
	`ide_¥obe_disk1
())

138 
	`ide_£t_disk
(1);

140 
	`ide_£t_disk
(0);

141 
	`bc_öô
();

144 
su≥r
 = 
	`diskaddr
(0);

145 
su≥r
->
magic
;

147 
	`˝rötf
("FS: superblockÜoaded!\n");

150 
öodes
 = 
	`diskaddr
(1);

151 
öodes
[0];

152 
	`˝rötf
("FS: inodesÜoaded!\n");

153 
	}
}

172 
	$fûe_block_wÆk
(
DamnInode
 * 
öode
, 
uöt16_t
 
blocköd
,

173 
uöt16_t
 **
µdiskbno
)

175 if(
blocköd
 < 
NDIRECT
) {

176 i‡(
µdiskbno
)

177 *
µdiskbno
 = &(
öode
->
blk_öd
[
blocköd
]);

180  -
E_INVAL
;

182 
	}
}

193 
	$fûe_gë_block
(
DamnInode
 * 
öode
, 
uöt16_t
 
blocköd
, **
blk
)

195 
r
;

196 
uöt16_t
 * 
poöãr_to_¶Ÿ
;

197 if((
r
 = 
	`fûe_block_wÆk
(
öode
, 
blocköd
, &
poöãr_to_¶Ÿ
)) < 0)

198  
r
;

199 if((*
poöãr_to_¶Ÿ
) == 0)

201 if((
r
 = 
	`Æloc_block
()) < 0)

202  
r
;

203 *
poöãr_to_¶Ÿ
 = 
r
;

204 
öode
->
blk_u£d
++;

206 *
blk
 = 
	`diskaddr
(*
poöãr_to_¶Ÿ
);

207 
	`Êush_block
(
öode
);

209 
	}
}

216 
	$dú_lookup
(
DamnInode
 *
dú
, c⁄° *
«me
, 
DúE¡ry
 **
íåy
)

218 
r
;

219 
uöt16_t
 
i
, 
j
, 
nblock
;

220 *
blk
;

221 
DúE¡ry
 *
f
;

226 
nblock
 = 
dú
->
blk_u£d
;

227 
i
 = 0; i < 
nblock
; i++)

229 i‡((
r
 = 
	`fûe_gë_block
(
dú
, 
i
, &
blk
)) < 0)

230  
r
;

231 
f
 = (
DúE¡ry
 *Ë
blk
;

232 
j
 = 0; j < 
BLKFILES
; j++)

234 i‡(
	`°rcmp
(
f
[
j
].
f_«me
, 
«me
) == 0)

236 *
íåy
 = &
f
[
j
];

241  -
E_NOT_FOUND
;

242 
	}
}

247 
	$dú_Æloc_íåy
(
DamnInode
 *
dú
, 
DúE¡ry
 **
íåy
)

249 
r
;

250 
uöt16_t
 
nblock
, 
i
, 
j
;

251 *
blk
;

252 
DúE¡ry
 *
f
;

254 
nblock
 = 
dú
->
blk_u£d
;

255 
i
 = 0; i < 
nblock
; i++)

257 i‡((
r
 = 
	`fûe_gë_block
(
dú
, 
i
, &
blk
)) < 0)

258  
r
;

259 
f
 = (
DúE¡ry
*Ë
blk
;

260 
j
 = 0; j < 
BLKFILES
; j++)

261 i‡(
f
[
j
].
f_«me
[0] == '\0')

263 *
íåy
 = &
f
[
j
];

264 
dú
->
size
 +
DIRESIZE
;

268 
dú
->
blk_u£d
 += 1;

269 
dú
->
size
 +
DIRESIZE
;

270 i‡((
r
 = 
	`fûe_gë_block
(
dú
, 
i
, &
blk
)) < 0)

271  
r
;

272 
f
 = (
DúE¡ry
*Ë
blk
;

273 *
íåy
 = &
f
[0];

275 
	}
}

279 
	$skù_¶ash
(c⁄° *
p
)

281 *
p
 == '/')

282 
p
++;

283  
p
;

284 
	}
}

286 
boﬁ


287 
	$«me_is_vÆid
(c⁄° *
«me
)

289 i‡(
	`°æí
(
«me
Ë>
MAXNAMELEN
 || 
	`°rcmp
(name, "..") == 0 || strcmp(name, ".") == 0)

290  
Ál£
;

291 c⁄° *
p
 = 
«me
;

292 *
p
) {

293 i‡(*
p
 == '/' || *p == ' ')

294  
Ál£
;

295 ++
p
;

297  
åue
;

298 
	}
}

307 
	$wÆk_∑th
(c⁄° *
∑th
, 
DamnInode
 **
pdú
, 
DúE¡ry
 **
pf
, *
œ°ñem
)

309 c⁄° *
p
;

310 
«me
[
MAXNAMELEN
];

311 
DamnInode
 *
dú
, *
f
;

312 
DúE¡ry
 *
íåy
;

313 
r
;

316 i‡(*
∑th
 != '/')

317  -
E_BAD_PATH
;

318 
∑th
 = 
	`skù_¶ash
(path);

319 
f
 = &
öodes
[0];

320 
íåy
 = 
NULL
;

321 
dú
 = 0;

322 
«me
[0] = 0;

324 i‡(
pdú
)

325 *
pdú
 = 0;

326 *
pf
 = 0;

327 *
∑th
 != '\0')

329 
dú
 = 
f
;

330 
p
 = 
∑th
;

331 *
∑th
 != '/' && *path != '\0')

332 
∑th
++;

333 i‡(
∑th
 - 
p
 >
MAXNAMELEN
)

334  -
E_BAD_PATH
;

335 
	`memmove
(
«me
, 
p
, 
∑th
 -Ö);

336 
«me
[
∑th
 - 
p
] = '\0';

337 
∑th
 = 
	`skù_¶ash
(path);

339 i‡(
dú
->
ty≥
 !
FTYPE_DIR
)

340  -
E_NOT_FOUND
;

342 i‡((
r
 = 
	`dú_lookup
(
dú
, 
«me
, &
íåy
)) < 0) {

343 i‡(
r
 =-
E_NOT_FOUND
 && *
∑th
 == '\0') {

344 i‡(
pdú
)

345 *
pdú
 = 
dú
;

346 i‡(
œ°ñem
)

347 
	`°r˝y
(
œ°ñem
, 
«me
);

348 *
pf
 = 0;

350  
r
;

352 
f
 = &
öodes
[
íåy
->
ö_öd
];

355 i‡(
pdú
)

356 *
pdú
 = 
dú
;

357 *
pf
 = 
íåy
;

359 
	}
}

368 
	$fûe_¸óã
(c⁄° *
∑th
, 
DúE¡ry
 **
pf
, 
uöt16_t
 
ty≥
)

370 
«me
[
MAXNAMELEN
];

371 
r
;

372 
DamnInode
 *
dú
;

373 
DúE¡ry
 *
íåy
, *
blk
;

374 
uöt16_t
 
öodío
;

376 i‡((
r
 = 
	`wÆk_∑th
(
∑th
, &
dú
, &
íåy
, 
«me
)) == 0)

377  -
E_FILE_EXISTS
;

378 i‡(
r
 !-
E_NOT_FOUND
 || 
dú
 == 0)

379  
r
;

380 i‡(
	`«me_is_vÆid
(
«me
Ë=
Ál£
)

381  -
E_BAD_NAME
;

382 i‡((
r
 = 
	`dú_Æloc_íåy
(
dú
, &
íåy
)) < 0)

383  
r
;

384 i‡((
r
 = 
	`Æloc_öode
()) < 0)

385  
r
;

386 
öodío
 = 
r
;

387 i‡(
ty≥
 =
FTYPE_DIR
) {

388 i‡((
r
 = 
	`fûe_gë_block
(&
öodes
[
öodío
], 0, (**)&
blk
)) < 0) {

389 
	`‰ì_öode
(
öodío
);

390  
r
;

392 
	`°r˝y
(
blk
[0].
f_«me
, "..");

393 
	`°r˝y
(
blk
[1].
f_«me
, ".");

394 
blk
[0].
ö_öd
 = blk[1].ö_öd = 
öodío
;

395 
öodes
[
öodío
].
size
 = 2 * 
DIRESIZE
;

397 
	`°r˝y
(
íåy
->
f_«me
, 
«me
);

398 
íåy
->
ö_öd
 = 
öodío
;

399 
öodes
[
öodío
].
ty≥
 =Åype;

400 i‡(
pf
)

401 *
pf
 = 
íåy
;

403 
	`fûe_Êush
(
íåy
);

405 
	}
}

409 
	$fûe_ªmove
(c⁄° *
∑th
)

411 
r
;

412 
DúE¡ry
 *
f
;

414 i‡((
r
 = 
	`wÆk_∑th
(
∑th
, 0, &
f
, 0)) < 0)

415  
r
;

417 
	`fûe_£t_size
(
f
, 0);

418 
f
->
f_«me
[0] = '\0';

419 
öodes
[
f
->
ö_öd
].
size
 = 0;

420 
	`Êush_block
(
f
);

421 
	`Êush_block
(
öodes
);

423 
	}
}

428 
	$fûe_›í
(c⁄° *
∑th
, 
DúE¡ry
 **
pf
)

431  
	`wÆk_∑th
(
∑th
, 0, 
pf
, 0);

432 
	}
}

437 
ssize_t


438 
	$fûe_ªad
(
DúE¡ry
 *
f
, *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
)

440 
r
, 
bn
;

441 
off_t
 
pos
;

442 *
blk
;

443 
DamnInode
 * 
öode
;

447 
öode
 = &
öodes
[
f
->
ö_öd
];

448 i‡(
off£t
 >
öode
->
size
)

451 
cou¡
 = 
	`MIN
(cou¡, 
öode
->
size
 - 
off£t
);

453 
pos
 = 
off£t
;Öo†< off£à+ 
cou¡
; ) {

454 i‡((
r
 = 
	`fûe_gë_block
(
öode
, 
pos
 / 
BLKSIZE
, &
blk
)) < 0)

455  
r
;

456 
bn
 = 
	`MIN
(
BLKSIZE
 - 
pos
 % BLKSIZE, 
off£t
 + 
cou¡
 -Öos);

457 
	`memmove
(
buf
, 
blk
 + 
pos
 % 
BLKSIZE
, 
bn
);

458 
pos
 +
bn
;

459 
buf
 +
bn
;

462  
cou¡
;

463 
	}
}

471 
	$fûe_wrôe
(
DúE¡ry
 *
f
, c⁄° *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
)

473 
r
, 
bn
;

474 
off_t
 
pos
;

475 *
blk
;

476 
DamnInode
 * 
öode
;

478 
öode
 = &
öodes
[
f
->
ö_öd
];

480 i‡(
off£t
 + 
cou¡
 > 
öode
->
size
)

481 i‡((
r
 = 
	`fûe_£t_size
(
f
, 
off£t
 + 
cou¡
)) < 0)

482  
r
;

484 
pos
 = 
off£t
;Öo†< off£à+ 
cou¡
; ) {

485 i‡((
r
 = 
	`fûe_gë_block
(
öode
, 
pos
 / 
BLKSIZE
, &
blk
)) < 0)

486  
r
;

487 
bn
 = 
	`MIN
(
BLKSIZE
 - 
pos
 % BLKSIZE, 
off£t
 + 
cou¡
 -Öos);

488 
	`memmove
(
blk
 + 
pos
 % 
BLKSIZE
, 
buf
, 
bn
);

489 
pos
 +
bn
;

490 
buf
 +
bn
;

493 
	`fûe_Êush
(
f
);

494  
cou¡
;

495 
	}
}

500 
	$fûe_‰ì_block
(
DúE¡ry
 *
f
, 
uöt16_t
 
blockno
)

502 
r
;

503 
uöt16_t
 *
±r
;

504 
DamnInode
 * 
öode
;

506 
öode
 = &
öodes
[
f
->
ö_öd
];

507 i‡((
r
 = 
	`fûe_block_wÆk
(
öode
, 
blockno
, &
±r
)) < 0)

508  
r
;

509 i‡(*
±r
) {

510 
	`‰ì_block
(*
±r
);

511 *
±r
 = 0;

514 
	}
}

526 
	$fûe_åunˇã_blocks
(
DúE¡ry
 *
f
, 
off_t
 
√wsize
)

528 
r
;

529 
uöt16_t
 
bno
, 
ﬁd_nblocks
, 
√w_nblocks
;

530 
DamnInode
 * 
öode
;

532 
öode
 = &
öodes
[
f
->
ö_öd
];

534 
ﬁd_nblocks
 = (
öode
->
size
 + 
BLKSIZE
 - 1) / BLKSIZE;

535 
√w_nblocks
 = (
√wsize
 + 
BLKSIZE
 - 1) / BLKSIZE;

536 
bno
 = 
√w_nblocks
; bnÿ< 
ﬁd_nblocks
; bno++)

537 i‡((
r
 = 
	`fûe_‰ì_block
(
f
, 
bno
)) < 0)

538 
	`˝rötf
("w¨nög: fûe_‰ì_block: %e", 
r
);

539 
	}
}

543 
	$fûe_£t_size
(
DúE¡ry
 *
f
, 
off_t
 
√wsize
)

545 
DamnInode
 * 
öode
;

547 
öode
 = &
öodes
[
f
->
ö_öd
];

548 i‡(
öode
->
size
 > 
√wsize
)

549 
	`fûe_åunˇã_blocks
(
f
, 
√wsize
);

550 
öode
->
size
 = 
√wsize
;

551 
	`Êush_block
(
f
);

553 
	}
}

560 
	$fûe_Êush
(
DúE¡ry
 *
f
)

562 
i
;

563 
uöt16_t
 *
pdiskbno
;

564 
DamnInode
 * 
öode
;

566 
öode
 = &
öodes
[
f
->
ö_öd
];

567 
i
 = 0; i < (
öode
->
size
 + 
BLKSIZE
 - 1) / BLKSIZE; i++) {

568 i‡(
	`fûe_block_wÆk
(
öode
, 
i
, &
pdiskbno
) < 0 ||

569 
pdiskbno
 =
NULL
 || *pdiskbno == 0)

572 
	`Êush_block
(
	`diskaddr
(*
pdiskbno
));

576 
	`Êush_block
(
öode
);

578 
	`Êush_block
(
f
);

579 
	}
}

584 
	$fs_sync
()

586 
i
;

587 
i
 = 1; i < 
su≥r
->
blk_num
; i++)

588 
	`Êush_block
(
	`diskaddr
(
i
));

589 
	}
}

594 
	$diskaddr
(
uöt32_t
 
blockno
)

596 i‡(
su≥r
 && 
blockno
 >su≥r->
blk_num
)

597 
	`∑nic
("bad blockÇumbî %08x i¿diskaddr", 
blockno
);

598  (*Ë(
DISKMAP
 + 
blockno
 * 
BLKSIZE
);

599 
	}
}

602 
boﬁ


603 
	$va_is_m≠≥d
(*
va
)

605  (
uvpd
[
	`PDX
(
va
)] & 
PTE_P
Ë&& (
uv±
[
	`PGNUM
(va)] & PTE_P);

606 
	}
}

609 
boﬁ


610 
	$va_is_dúty
(*
va
)

612  (
uv±
[
	`PGNUM
(
va
)] & 
PTE_D
) != 0;

613 
	}
}

618 
	$bc_pgÁu…
(
UTøp‰ame
 *
utf
)

620 *
addr
 = (*Ë
utf
->
utf_Áu…_va
;

621 
uöt32_t
 
blockno
 = ((uöt32_t)
addr
 - 
DISKMAP
Ë/ 
BLKSIZE
;

622 
r
;

623 
ívid_t
 
ívid
;

624 *
blkaddr
;

625 
blkaddr
 = 
	`ROUNDDOWN
(
addr
, 
PGSIZE
);

628 i‡(
addr
 < (*)
DISKMAP
 ||ádd∏>(*)(DISKMAP + 
DISKSIZE
))

629 
	`∑nic
("page fault in FS:Éip %08x, va %08x,Érr %04x",

630 
utf
->
utf_eù
, 
addr
, utf->
utf_îr
);

633 i‡(
su≥r
 && 
blockno
 >su≥r->
blk_num
)

634 
	`∑nic
("ªadögÇ⁄-exi°íàblock %08x\n", 
blockno
);

641 i‡(
	`sys_∑ge_Æloc
(0, 
blkaddr
, 
PTE_SYSCALL
) < 0) {

642 
	`∑nic
("bg_pgfault: can'tállocateÇewÖage for disk block\n");

645 i‡(
	`ide_ªad
(
blockno
*
BLKSECTS
, 
blkaddr
, BLKSECTS) < 0) {

646 
	`∑nic
("bg_pgfault: failedÅoÑead disk block\n");

649 i‡(
	`sys_∑ge_m≠
(0, 
blkaddr
, 0, blkaddr, 
PTE_W
 | 
PTE_U
 | 
PTE_SYSCALL
) < 0) {

650 
	`∑nic
("bg_pgfault: failedÅo mark diskÖageásÇon dirty\n");

656 i‡(
su≥r
 && 
	`block_is_‰ì
(
blockno
))

657 
	`∑nic
("ªadög fªêblock %08x\n", 
blockno
);

658 
	}
}

668 
	$Êush_block
(*
addr
)

670 
uöt32_t
 
blockno
 = ((uöt32_t)
addr
 - 
DISKMAP
Ë/ 
BLKSIZE
;

672 i‡(
addr
 < (*)
DISKMAP
 ||ádd∏>(*)(DISKMAP + 
DISKSIZE
))

673 
	`∑nic
("Êush_block o‡bad v®%08x", 
addr
);

675 if(!
	`va_is_m≠≥d
(
addr
Ë|| !
	`va_is_dúty
(addr))

677 
addr
 = 
	`ROUNDDOWN
◊ddr, 
PGSIZE
);

678 
r
;

679 if((
r
 = 
	`ide_wrôe
(
blockno
 * 
BLKSECTS
, 
addr
, BLKSECTS)) < 0)

680 
	`∑nic
("Êush_block : ide_wrôê:Éº‹Çum : %d\n", 
r
);

681 if((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 0,áddr,

682 
uv±
[
	`PGNUM
(
addr
)] & 
PTE_SYSCALL
)) < 0)

683 
	`∑nic
("Êush_block : sys_∑ge_m≠ : %e", 
r
);

685 
	}
}

687 
	ga
[100];

690 
	$bc_öô
()

692 
	`£t_pgÁu…_h™dÀr
(
bc_pgÁu…
);

693 
tmp
;

694 
i
;

695 
i
 = 0; i < 100; ++i)

696 
a
[
i
] = i;

698 
	`memmove
(&
tmp
, 
	`diskaddr
(0), (tmp));

699 
	}
}

	@damnfs.h

1 #i‚de‡
__DAMN_FS


2 
	#__DAMN_FS


	)

4 
	~<x86.h
>

5 
	~<utû.h
>

7 
	#MAXINODENUM
 128

	)

9 
	#MAXBLKNUM
 4096

	)

11 
	#MAXNAMELEN
 16

	)

13 
	#DAMN_MAGIC
 0x89ABCDEF

	)

18 
	#BLKSIZE
 
PGSIZE


	)

19 
	#BLKBITSIZE
 (
BLKSIZE
 * 8)

	)

22 
	#INSIZE
 32

	)

25 
	#DIRESIZE
 (
DúE¡ry
)

	)

28 
	#MAXPATHLEN
 128

	)

31 
	#NDIRECT
 13

	)

33 
	#SECTSIZE
 512

34 
	#BLKSECTS
 (
BLKSIZE
 / 
SECTSIZE
)

35 

	)

37 
	#BLKFILES
 (
BLKSIZE
 / 
DIRESIZE
)

	)

41 
	#DISKMAP
 0x10000000

	)

44 
	#DISKSIZE
 0x11002000

	)

47 
	#FTYPE_REG
 'f'

48 
	#FTYPE_DIR
 'd'

49 

	)

50 
	#MIN
(
a
,
b
Ë((◊)<(b))?◊):(b))

	)

53 
	mFSREQ_OPEN
 = 1,

54 
	mFSREQ_SET_SIZE
,

56 
	mFSREQ_READ
,

57 
	mFSREQ_WRITE
,

59 
	mFSREQ_STAT
,

60 
	mFSREQ_FLUSH
,

61 
	mFSREQ_MKDIR
,

62 
	mFSREQ_REMOVE
,

63 
	mFSREQ_SYNC


66 
	sDamnInode
{

67 
uöt16_t
 
	mty≥
;

68 
uöt16_t
 
	msize
;

69 
uöt16_t
 
	mblk_u£d
;

70 
uöt16_t
 
	mblk_öd
[
NDIRECT
];

71 } 
__©åibuã__
((
∑cked
));

73 
	sDamnSu≥r
{

74 
uöt32_t
 
	mmagic
;

75 
uöt16_t
 
	mö_num
;

76 
uöt16_t
 
	mblk_num
;

77 
uöt16_t
 
	mö_size
;

78 
uöt16_t
 
	mblk_size
;

79 
uöçå_t
 
	mö_íåy
;

80 
uöt32_t
 
	mblk_o˝
[
MAXBLKNUM
/32];

81 
uöt32_t
 
	mö_o˝
[
MAXINODENUM
/32];

82 } 
__©åibuã__
((
Æig√d
(
BLKSIZE
)));

85 
	sDúE¡ry
{

86 
	mf_«me
[
MAXNAMELEN
];

87 
uöt16_t
 
	mö_öd
;

88 } 
__©åibuã__
((
∑cked
));;

91 
	uFsùc
 {

92 
	sF§eq_›í


94 
	mªq_∑th
[
MAXPATHLEN
];

95 
	mªq_omode
;

96 } 
	m›í
;

97 
	sF§eq_£t_size


99 
	mªq_fûeid
;

100 
off_t
 
	mªq_size
;

101 } 
	m£t_size
;

102 
	sF§eq_ªad


104 
	mªq_fûeid
;

105 
size_t
 
	mªq_n
;

106 } 
	mªad
;

107 
	sF§ë_ªad


109 
	mªt_buf
[
PGSIZE
];

110 } 
	mªadRë
;

111 
	sF§eq_wrôe


113 
	mªq_fûeid
;

114 
size_t
 
	mªq_n
;

115 
	mªq_buf
[
PGSIZE
 - ((Ë+ (
size_t
))];

116 } 
	mwrôe
;

117 
	sF§eq_°©


119 
	mªq_fûeid
;

120 } 
	m°©
;

121 
	sF§ë_°©


123 
	mªt_«me
[
MAXNAMELEN
];

124 
off_t
 
	mªt_size
;

125 
	mªt_isdú
;

126 } 
	m°©Rë
;

127 
	sF§eq_Êush


129 
	mªq_fûeid
;

130 } 
	mÊush
;

131 
	sF§eq_ªmove


133 
	mªq_∑th
[
MAXPATHLEN
];

134 } 
	mªmove
;

135 
	sF§eq_mkdú


137 
	mªq_∑th
[
MAXPATHLEN
];

138 } 
	mmkdú
;

141 
	m_∑d
[
PGSIZE
];

144 * 
diskaddr
(
uöt32_t
 
blockno
);

145 
boﬁ
 
va_is_m≠≥d
(*
va
);

146 
boﬁ
 
va_is_dúty
(*
va
);

147 
Êush_block
(*
addr
);

148 
bc_öô
();

150 
boﬁ
 
block_is_‰ì
(
uöt16_t
 
blockno
);

151 
Æloc_block
();

152 
boﬁ
 
öode_is_‰ì
(
uöt16_t
 
öodío
);

153 
Æloc_öode
();

155 
fs_öô
();

156 
fûe_gë_block
(
DamnInode
 * 
öode
, 
uöt16_t
 
blocköd
, **
blk
);

157 
fûe_¸óã
(c⁄° *
∑th
, 
DúE¡ry
 **
pf
, 
uöt16_t
 
ty≥
);

158 
fûe_›í
(c⁄° *
∑th
, 
DúE¡ry
 **
pf
);

159 
ssize_t
 
fûe_ªad
(
DúE¡ry
 *
f
, *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
);

160 
fûe_wrôe
(
DúE¡ry
 *
f
, c⁄° *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
);

161 
fûe_£t_size
(
DúE¡ry
 *
f
, 
off_t
 
√wsize
);

162 
fûe_Êush
(
DúE¡ry
 *
f
);

163 
fûe_ªmove
(c⁄° *
∑th
);

164 
fs_sync
();

	@elf.h

1 
	#ELF_MAGIC
 0x464C457FU

	)

3 
	sElf
 {

4 
uöt32_t
 
	me_magic
;

5 
uöt8_t
 
	me_ñf
[12];

6 
uöt16_t
 
	me_ty≥
;

7 
uöt16_t
 
	me_machöe
;

8 
uöt32_t
 
	me_vîsi⁄
;

9 
uöt32_t
 
	me_íåy
;

10 
uöt32_t
 
	me_phoff
;

11 
uöt32_t
 
	me_shoff
;

12 
uöt32_t
 
	me_Êags
;

13 
uöt16_t
 
	me_ehsize
;

14 
uöt16_t
 
	me_phítsize
;

15 
uöt16_t
 
	me_phnum
;

16 
uöt16_t
 
	me_shítsize
;

17 
uöt16_t
 
	me_shnum
;

18 
uöt16_t
 
	me_sh°∫dx
;

21 
	sProghdr
 {

22 
uöt32_t
 
	mp_ty≥
;

23 
uöt32_t
 
	mp_off£t
;

24 
uöt32_t
 
	mp_va
;

25 
uöt32_t
 
	mp_∑
;

26 
uöt32_t
 
	mp_fûesz
;

27 
uöt32_t
 
	mp_memsz
;

28 
uöt32_t
 
	mp_Êags
;

29 
uöt32_t
 
	mp_Æign
;

32 
	sSe˘hdr
 {

33 
uöt32_t
 
	msh_«me
;

34 
uöt32_t
 
	msh_ty≥
;

35 
uöt32_t
 
	msh_Êags
;

36 
uöt32_t
 
	msh_addr
;

37 
uöt32_t
 
	msh_off£t
;

38 
uöt32_t
 
	msh_size
;

39 
uöt32_t
 
	msh_lök
;

40 
uöt32_t
 
	msh_öfo
;

41 
uöt32_t
 
	msh_addølign
;

42 
uöt32_t
 
	msh_ítsize
;

46 
	#ELF_PROG_LOAD
 1

	)

49 
	#ELF_PROG_FLAG_EXEC
 1

	)

50 
	#ELF_PROG_FLAG_WRITE
 2

	)

51 
	#ELF_PROG_FLAG_READ
 4

	)

54 
	#ELF_SHT_NULL
 0

	)

55 
	#ELF_SHT_PROGBITS
 1

	)

56 
	#ELF_SHT_SYMTAB
 2

	)

57 
	#ELF_SHT_STRTAB
 3

	)

60 
	#ELF_SHN_UNDEF
 0

	)

	@entrypgdir.c

1 
	~<utû.h
>

2 
	~<x86.h
>

4 
±e_t
 
	gíåy_pgèbÀ
[
NPTENTRIES
];

6 
__©åibuã__
((
	$__Æig√d__
(
PGSIZE
)))

7 
pde_t
 
íåy_pgdú
[
NPDENTRIES
] = {

10 ((
uöçå_t
)
íåy_pgèbÀ
 - 
KERNBASE
Ë+ 
PTE_P
,

11 [
KERNBASE
 >> 
PDXSHIFT
]

12 ((
uöçå_t
)
íåy_pgèbÀ
 - 
KERNBASE
Ë+ 
PTE_P
 + 
PTE_W


13 
	}
};

17 
__©åibuã__
((
	$__Æig√d__
(
PGSIZE
)))

18 
±e_t
 
íåy_pgèbÀ
[
NPTENTRIES
] = {

19 0x000000 | 
PTE_P
 | 
PTE_W
,

20 0x001000 | 
PTE_P
 | 
PTE_W
,

21 0x002000 | 
PTE_P
 | 
PTE_W
,

22 0x003000 | 
PTE_P
 | 
PTE_W
,

23 0x004000 | 
PTE_P
 | 
PTE_W
,

24 0x005000 | 
PTE_P
 | 
PTE_W
,

25 0x006000 | 
PTE_P
 | 
PTE_W
,

26 0x007000 | 
PTE_P
 | 
PTE_W
,

27 0x008000 | 
PTE_P
 | 
PTE_W
,

28 0x009000 | 
PTE_P
 | 
PTE_W
,

29 0x00a000 | 
PTE_P
 | 
PTE_W
,

30 0x00b000 | 
PTE_P
 | 
PTE_W
,

31 0x00c000 | 
PTE_P
 | 
PTE_W
,

32 0x00d000 | 
PTE_P
 | 
PTE_W
,

33 0x00e000 | 
PTE_P
 | 
PTE_W
,

34 0x00f000 | 
PTE_P
 | 
PTE_W
,

35 0x010000 | 
PTE_P
 | 
PTE_W
,

36 0x011000 | 
PTE_P
 | 
PTE_W
,

37 0x012000 | 
PTE_P
 | 
PTE_W
,

38 0x013000 | 
PTE_P
 | 
PTE_W
,

39 0x014000 | 
PTE_P
 | 
PTE_W
,

40 0x015000 | 
PTE_P
 | 
PTE_W
,

41 0x016000 | 
PTE_P
 | 
PTE_W
,

42 0x017000 | 
PTE_P
 | 
PTE_W
,

43 0x018000 | 
PTE_P
 | 
PTE_W
,

44 0x019000 | 
PTE_P
 | 
PTE_W
,

45 0x01a000 | 
PTE_P
 | 
PTE_W
,

46 0x01b000 | 
PTE_P
 | 
PTE_W
,

47 0x01c000 | 
PTE_P
 | 
PTE_W
,

48 0x01d000 | 
PTE_P
 | 
PTE_W
,

49 0x01e000 | 
PTE_P
 | 
PTE_W
,

50 0x01f000 | 
PTE_P
 | 
PTE_W
,

51 0x020000 | 
PTE_P
 | 
PTE_W
,

52 0x021000 | 
PTE_P
 | 
PTE_W
,

53 0x022000 | 
PTE_P
 | 
PTE_W
,

54 0x023000 | 
PTE_P
 | 
PTE_W
,

55 0x024000 | 
PTE_P
 | 
PTE_W
,

56 0x025000 | 
PTE_P
 | 
PTE_W
,

57 0x026000 | 
PTE_P
 | 
PTE_W
,

58 0x027000 | 
PTE_P
 | 
PTE_W
,

59 0x028000 | 
PTE_P
 | 
PTE_W
,

60 0x029000 | 
PTE_P
 | 
PTE_W
,

61 0x02a000 | 
PTE_P
 | 
PTE_W
,

62 0x02b000 | 
PTE_P
 | 
PTE_W
,

63 0x02c000 | 
PTE_P
 | 
PTE_W
,

64 0x02d000 | 
PTE_P
 | 
PTE_W
,

65 0x02e000 | 
PTE_P
 | 
PTE_W
,

66 0x02f000 | 
PTE_P
 | 
PTE_W
,

67 0x030000 | 
PTE_P
 | 
PTE_W
,

68 0x031000 | 
PTE_P
 | 
PTE_W
,

69 0x032000 | 
PTE_P
 | 
PTE_W
,

70 0x033000 | 
PTE_P
 | 
PTE_W
,

71 0x034000 | 
PTE_P
 | 
PTE_W
,

72 0x035000 | 
PTE_P
 | 
PTE_W
,

73 0x036000 | 
PTE_P
 | 
PTE_W
,

74 0x037000 | 
PTE_P
 | 
PTE_W
,

75 0x038000 | 
PTE_P
 | 
PTE_W
,

76 0x039000 | 
PTE_P
 | 
PTE_W
,

77 0x03a000 | 
PTE_P
 | 
PTE_W
,

78 0x03b000 | 
PTE_P
 | 
PTE_W
,

79 0x03c000 | 
PTE_P
 | 
PTE_W
,

80 0x03d000 | 
PTE_P
 | 
PTE_W
,

81 0x03e000 | 
PTE_P
 | 
PTE_W
,

82 0x03f000 | 
PTE_P
 | 
PTE_W
,

83 0x040000 | 
PTE_P
 | 
PTE_W
,

84 0x041000 | 
PTE_P
 | 
PTE_W
,

85 0x042000 | 
PTE_P
 | 
PTE_W
,

86 0x043000 | 
PTE_P
 | 
PTE_W
,

87 0x044000 | 
PTE_P
 | 
PTE_W
,

88 0x045000 | 
PTE_P
 | 
PTE_W
,

89 0x046000 | 
PTE_P
 | 
PTE_W
,

90 0x047000 | 
PTE_P
 | 
PTE_W
,

91 0x048000 | 
PTE_P
 | 
PTE_W
,

92 0x049000 | 
PTE_P
 | 
PTE_W
,

93 0x04a000 | 
PTE_P
 | 
PTE_W
,

94 0x04b000 | 
PTE_P
 | 
PTE_W
,

95 0x04c000 | 
PTE_P
 | 
PTE_W
,

96 0x04d000 | 
PTE_P
 | 
PTE_W
,

97 0x04e000 | 
PTE_P
 | 
PTE_W
,

98 0x04f000 | 
PTE_P
 | 
PTE_W
,

99 0x050000 | 
PTE_P
 | 
PTE_W
,

100 0x051000 | 
PTE_P
 | 
PTE_W
,

101 0x052000 | 
PTE_P
 | 
PTE_W
,

102 0x053000 | 
PTE_P
 | 
PTE_W
,

103 0x054000 | 
PTE_P
 | 
PTE_W
,

104 0x055000 | 
PTE_P
 | 
PTE_W
,

105 0x056000 | 
PTE_P
 | 
PTE_W
,

106 0x057000 | 
PTE_P
 | 
PTE_W
,

107 0x058000 | 
PTE_P
 | 
PTE_W
,

108 0x059000 | 
PTE_P
 | 
PTE_W
,

109 0x05a000 | 
PTE_P
 | 
PTE_W
,

110 0x05b000 | 
PTE_P
 | 
PTE_W
,

111 0x05c000 | 
PTE_P
 | 
PTE_W
,

112 0x05d000 | 
PTE_P
 | 
PTE_W
,

113 0x05e000 | 
PTE_P
 | 
PTE_W
,

114 0x05f000 | 
PTE_P
 | 
PTE_W
,

115 0x060000 | 
PTE_P
 | 
PTE_W
,

116 0x061000 | 
PTE_P
 | 
PTE_W
,

117 0x062000 | 
PTE_P
 | 
PTE_W
,

118 0x063000 | 
PTE_P
 | 
PTE_W
,

119 0x064000 | 
PTE_P
 | 
PTE_W
,

120 0x065000 | 
PTE_P
 | 
PTE_W
,

121 0x066000 | 
PTE_P
 | 
PTE_W
,

122 0x067000 | 
PTE_P
 | 
PTE_W
,

123 0x068000 | 
PTE_P
 | 
PTE_W
,

124 0x069000 | 
PTE_P
 | 
PTE_W
,

125 0x06a000 | 
PTE_P
 | 
PTE_W
,

126 0x06b000 | 
PTE_P
 | 
PTE_W
,

127 0x06c000 | 
PTE_P
 | 
PTE_W
,

128 0x06d000 | 
PTE_P
 | 
PTE_W
,

129 0x06e000 | 
PTE_P
 | 
PTE_W
,

130 0x06f000 | 
PTE_P
 | 
PTE_W
,

131 0x070000 | 
PTE_P
 | 
PTE_W
,

132 0x071000 | 
PTE_P
 | 
PTE_W
,

133 0x072000 | 
PTE_P
 | 
PTE_W
,

134 0x073000 | 
PTE_P
 | 
PTE_W
,

135 0x074000 | 
PTE_P
 | 
PTE_W
,

136 0x075000 | 
PTE_P
 | 
PTE_W
,

137 0x076000 | 
PTE_P
 | 
PTE_W
,

138 0x077000 | 
PTE_P
 | 
PTE_W
,

139 0x078000 | 
PTE_P
 | 
PTE_W
,

140 0x079000 | 
PTE_P
 | 
PTE_W
,

141 0x07a000 | 
PTE_P
 | 
PTE_W
,

142 0x07b000 | 
PTE_P
 | 
PTE_W
,

143 0x07c000 | 
PTE_P
 | 
PTE_W
,

144 0x07d000 | 
PTE_P
 | 
PTE_W
,

145 0x07e000 | 
PTE_P
 | 
PTE_W
,

146 0x07f000 | 
PTE_P
 | 
PTE_W
,

147 0x080000 | 
PTE_P
 | 
PTE_W
,

148 0x081000 | 
PTE_P
 | 
PTE_W
,

149 0x082000 | 
PTE_P
 | 
PTE_W
,

150 0x083000 | 
PTE_P
 | 
PTE_W
,

151 0x084000 | 
PTE_P
 | 
PTE_W
,

152 0x085000 | 
PTE_P
 | 
PTE_W
,

153 0x086000 | 
PTE_P
 | 
PTE_W
,

154 0x087000 | 
PTE_P
 | 
PTE_W
,

155 0x088000 | 
PTE_P
 | 
PTE_W
,

156 0x089000 | 
PTE_P
 | 
PTE_W
,

157 0x08a000 | 
PTE_P
 | 
PTE_W
,

158 0x08b000 | 
PTE_P
 | 
PTE_W
,

159 0x08c000 | 
PTE_P
 | 
PTE_W
,

160 0x08d000 | 
PTE_P
 | 
PTE_W
,

161 0x08e000 | 
PTE_P
 | 
PTE_W
,

162 0x08f000 | 
PTE_P
 | 
PTE_W
,

163 0x090000 | 
PTE_P
 | 
PTE_W
,

164 0x091000 | 
PTE_P
 | 
PTE_W
,

165 0x092000 | 
PTE_P
 | 
PTE_W
,

166 0x093000 | 
PTE_P
 | 
PTE_W
,

167 0x094000 | 
PTE_P
 | 
PTE_W
,

168 0x095000 | 
PTE_P
 | 
PTE_W
,

169 0x096000 | 
PTE_P
 | 
PTE_W
,

170 0x097000 | 
PTE_P
 | 
PTE_W
,

171 0x098000 | 
PTE_P
 | 
PTE_W
,

172 0x099000 | 
PTE_P
 | 
PTE_W
,

173 0x09a000 | 
PTE_P
 | 
PTE_W
,

174 0x09b000 | 
PTE_P
 | 
PTE_W
,

175 0x09c000 | 
PTE_P
 | 
PTE_W
,

176 0x09d000 | 
PTE_P
 | 
PTE_W
,

177 0x09e000 | 
PTE_P
 | 
PTE_W
,

178 0x09f000 | 
PTE_P
 | 
PTE_W
,

179 0x0a0000 | 
PTE_P
 | 
PTE_W
,

180 0x0a1000 | 
PTE_P
 | 
PTE_W
,

181 0x0a2000 | 
PTE_P
 | 
PTE_W
,

182 0x0a3000 | 
PTE_P
 | 
PTE_W
,

183 0x0a4000 | 
PTE_P
 | 
PTE_W
,

184 0x0a5000 | 
PTE_P
 | 
PTE_W
,

185 0x0a6000 | 
PTE_P
 | 
PTE_W
,

186 0x0a7000 | 
PTE_P
 | 
PTE_W
,

187 0x0a8000 | 
PTE_P
 | 
PTE_W
,

188 0x0a9000 | 
PTE_P
 | 
PTE_W
,

189 0x0Ø000 | 
PTE_P
 | 
PTE_W
,

190 0x0ab000 | 
PTE_P
 | 
PTE_W
,

191 0x0ac000 | 
PTE_P
 | 
PTE_W
,

192 0x0ad000 | 
PTE_P
 | 
PTE_W
,

193 0x0´000 | 
PTE_P
 | 
PTE_W
,

194 0x0af000 | 
PTE_P
 | 
PTE_W
,

195 0x0b0000 | 
PTE_P
 | 
PTE_W
,

196 0x0b1000 | 
PTE_P
 | 
PTE_W
,

197 0x0b2000 | 
PTE_P
 | 
PTE_W
,

198 0x0b3000 | 
PTE_P
 | 
PTE_W
,

199 0x0b4000 | 
PTE_P
 | 
PTE_W
,

200 0x0b5000 | 
PTE_P
 | 
PTE_W
,

201 0x0b6000 | 
PTE_P
 | 
PTE_W
,

202 0x0b7000 | 
PTE_P
 | 
PTE_W
,

203 0x0b8000 | 
PTE_P
 | 
PTE_W
,

204 0x0b9000 | 
PTE_P
 | 
PTE_W
,

205 0x0ba000 | 
PTE_P
 | 
PTE_W
,

206 0x0bb000 | 
PTE_P
 | 
PTE_W
,

207 0x0bc000 | 
PTE_P
 | 
PTE_W
,

208 0x0bd000 | 
PTE_P
 | 
PTE_W
,

209 0x0be000 | 
PTE_P
 | 
PTE_W
,

210 0x0bf000 | 
PTE_P
 | 
PTE_W
,

211 0x0c0000 | 
PTE_P
 | 
PTE_W
,

212 0x0c1000 | 
PTE_P
 | 
PTE_W
,

213 0x0c2000 | 
PTE_P
 | 
PTE_W
,

214 0x0c3000 | 
PTE_P
 | 
PTE_W
,

215 0x0c4000 | 
PTE_P
 | 
PTE_W
,

216 0x0c5000 | 
PTE_P
 | 
PTE_W
,

217 0x0c6000 | 
PTE_P
 | 
PTE_W
,

218 0x0c7000 | 
PTE_P
 | 
PTE_W
,

219 0x0c8000 | 
PTE_P
 | 
PTE_W
,

220 0x0c9000 | 
PTE_P
 | 
PTE_W
,

221 0x0ˇ000 | 
PTE_P
 | 
PTE_W
,

222 0x0cb000 | 
PTE_P
 | 
PTE_W
,

223 0x0cc000 | 
PTE_P
 | 
PTE_W
,

224 0x0cd000 | 
PTE_P
 | 
PTE_W
,

225 0x0˚000 | 
PTE_P
 | 
PTE_W
,

226 0x0cf000 | 
PTE_P
 | 
PTE_W
,

227 0x0d0000 | 
PTE_P
 | 
PTE_W
,

228 0x0d1000 | 
PTE_P
 | 
PTE_W
,

229 0x0d2000 | 
PTE_P
 | 
PTE_W
,

230 0x0d3000 | 
PTE_P
 | 
PTE_W
,

231 0x0d4000 | 
PTE_P
 | 
PTE_W
,

232 0x0d5000 | 
PTE_P
 | 
PTE_W
,

233 0x0d6000 | 
PTE_P
 | 
PTE_W
,

234 0x0d7000 | 
PTE_P
 | 
PTE_W
,

235 0x0d8000 | 
PTE_P
 | 
PTE_W
,

236 0x0d9000 | 
PTE_P
 | 
PTE_W
,

237 0x0da000 | 
PTE_P
 | 
PTE_W
,

238 0x0db000 | 
PTE_P
 | 
PTE_W
,

239 0x0dc000 | 
PTE_P
 | 
PTE_W
,

240 0x0dd000 | 
PTE_P
 | 
PTE_W
,

241 0x0de000 | 
PTE_P
 | 
PTE_W
,

242 0x0df000 | 
PTE_P
 | 
PTE_W
,

243 0x0e0000 | 
PTE_P
 | 
PTE_W
,

244 0x0e1000 | 
PTE_P
 | 
PTE_W
,

245 0x0e2000 | 
PTE_P
 | 
PTE_W
,

246 0x0e3000 | 
PTE_P
 | 
PTE_W
,

247 0x0e4000 | 
PTE_P
 | 
PTE_W
,

248 0x0e5000 | 
PTE_P
 | 
PTE_W
,

249 0x0e6000 | 
PTE_P
 | 
PTE_W
,

250 0x0e7000 | 
PTE_P
 | 
PTE_W
,

251 0x0e8000 | 
PTE_P
 | 
PTE_W
,

252 0x0e9000 | 
PTE_P
 | 
PTE_W
,

253 0x0ó000 | 
PTE_P
 | 
PTE_W
,

254 0x0eb000 | 
PTE_P
 | 
PTE_W
,

255 0x0ec000 | 
PTE_P
 | 
PTE_W
,

256 0x0ed000 | 
PTE_P
 | 
PTE_W
,

257 0x0ì000 | 
PTE_P
 | 
PTE_W
,

258 0x0ef000 | 
PTE_P
 | 
PTE_W
,

259 0x0f0000 | 
PTE_P
 | 
PTE_W
,

260 0x0f1000 | 
PTE_P
 | 
PTE_W
,

261 0x0f2000 | 
PTE_P
 | 
PTE_W
,

262 0x0f3000 | 
PTE_P
 | 
PTE_W
,

263 0x0f4000 | 
PTE_P
 | 
PTE_W
,

264 0x0f5000 | 
PTE_P
 | 
PTE_W
,

265 0x0f6000 | 
PTE_P
 | 
PTE_W
,

266 0x0f7000 | 
PTE_P
 | 
PTE_W
,

267 0x0f8000 | 
PTE_P
 | 
PTE_W
,

268 0x0f9000 | 
PTE_P
 | 
PTE_W
,

269 0x0Á000 | 
PTE_P
 | 
PTE_W
,

270 0x0fb000 | 
PTE_P
 | 
PTE_W
,

271 0x0fc000 | 
PTE_P
 | 
PTE_W
,

272 0x0fd000 | 
PTE_P
 | 
PTE_W
,

273 0x0„000 | 
PTE_P
 | 
PTE_W
,

274 0x0ff000 | 
PTE_P
 | 
PTE_W
,

275 0x100000 | 
PTE_P
 | 
PTE_W
,

276 0x101000 | 
PTE_P
 | 
PTE_W
,

277 0x102000 | 
PTE_P
 | 
PTE_W
,

278 0x103000 | 
PTE_P
 | 
PTE_W
,

279 0x104000 | 
PTE_P
 | 
PTE_W
,

280 0x105000 | 
PTE_P
 | 
PTE_W
,

281 0x106000 | 
PTE_P
 | 
PTE_W
,

282 0x107000 | 
PTE_P
 | 
PTE_W
,

283 0x108000 | 
PTE_P
 | 
PTE_W
,

284 0x109000 | 
PTE_P
 | 
PTE_W
,

285 0x10a000 | 
PTE_P
 | 
PTE_W
,

286 0x10b000 | 
PTE_P
 | 
PTE_W
,

287 0x10c000 | 
PTE_P
 | 
PTE_W
,

288 0x10d000 | 
PTE_P
 | 
PTE_W
,

289 0x10e000 | 
PTE_P
 | 
PTE_W
,

290 0x10f000 | 
PTE_P
 | 
PTE_W
,

291 0x110000 | 
PTE_P
 | 
PTE_W
,

292 0x111000 | 
PTE_P
 | 
PTE_W
,

293 0x112000 | 
PTE_P
 | 
PTE_W
,

294 0x113000 | 
PTE_P
 | 
PTE_W
,

295 0x114000 | 
PTE_P
 | 
PTE_W
,

296 0x115000 | 
PTE_P
 | 
PTE_W
,

297 0x116000 | 
PTE_P
 | 
PTE_W
,

298 0x117000 | 
PTE_P
 | 
PTE_W
,

299 0x118000 | 
PTE_P
 | 
PTE_W
,

300 0x119000 | 
PTE_P
 | 
PTE_W
,

301 0x11a000 | 
PTE_P
 | 
PTE_W
,

302 0x11b000 | 
PTE_P
 | 
PTE_W
,

303 0x11c000 | 
PTE_P
 | 
PTE_W
,

304 0x11d000 | 
PTE_P
 | 
PTE_W
,

305 0x11e000 | 
PTE_P
 | 
PTE_W
,

306 0x11f000 | 
PTE_P
 | 
PTE_W
,

307 0x120000 | 
PTE_P
 | 
PTE_W
,

308 0x121000 | 
PTE_P
 | 
PTE_W
,

309 0x122000 | 
PTE_P
 | 
PTE_W
,

310 0x123000 | 
PTE_P
 | 
PTE_W
,

311 0x124000 | 
PTE_P
 | 
PTE_W
,

312 0x125000 | 
PTE_P
 | 
PTE_W
,

313 0x126000 | 
PTE_P
 | 
PTE_W
,

314 0x127000 | 
PTE_P
 | 
PTE_W
,

315 0x128000 | 
PTE_P
 | 
PTE_W
,

316 0x129000 | 
PTE_P
 | 
PTE_W
,

317 0x12a000 | 
PTE_P
 | 
PTE_W
,

318 0x12b000 | 
PTE_P
 | 
PTE_W
,

319 0x12c000 | 
PTE_P
 | 
PTE_W
,

320 0x12d000 | 
PTE_P
 | 
PTE_W
,

321 0x12e000 | 
PTE_P
 | 
PTE_W
,

322 0x12f000 | 
PTE_P
 | 
PTE_W
,

323 0x130000 | 
PTE_P
 | 
PTE_W
,

324 0x131000 | 
PTE_P
 | 
PTE_W
,

325 0x132000 | 
PTE_P
 | 
PTE_W
,

326 0x133000 | 
PTE_P
 | 
PTE_W
,

327 0x134000 | 
PTE_P
 | 
PTE_W
,

328 0x135000 | 
PTE_P
 | 
PTE_W
,

329 0x136000 | 
PTE_P
 | 
PTE_W
,

330 0x137000 | 
PTE_P
 | 
PTE_W
,

331 0x138000 | 
PTE_P
 | 
PTE_W
,

332 0x139000 | 
PTE_P
 | 
PTE_W
,

333 0x13a000 | 
PTE_P
 | 
PTE_W
,

334 0x13b000 | 
PTE_P
 | 
PTE_W
,

335 0x13c000 | 
PTE_P
 | 
PTE_W
,

336 0x13d000 | 
PTE_P
 | 
PTE_W
,

337 0x13e000 | 
PTE_P
 | 
PTE_W
,

338 0x13f000 | 
PTE_P
 | 
PTE_W
,

339 0x140000 | 
PTE_P
 | 
PTE_W
,

340 0x141000 | 
PTE_P
 | 
PTE_W
,

341 0x142000 | 
PTE_P
 | 
PTE_W
,

342 0x143000 | 
PTE_P
 | 
PTE_W
,

343 0x144000 | 
PTE_P
 | 
PTE_W
,

344 0x145000 | 
PTE_P
 | 
PTE_W
,

345 0x146000 | 
PTE_P
 | 
PTE_W
,

346 0x147000 | 
PTE_P
 | 
PTE_W
,

347 0x148000 | 
PTE_P
 | 
PTE_W
,

348 0x149000 | 
PTE_P
 | 
PTE_W
,

349 0x14a000 | 
PTE_P
 | 
PTE_W
,

350 0x14b000 | 
PTE_P
 | 
PTE_W
,

351 0x14c000 | 
PTE_P
 | 
PTE_W
,

352 0x14d000 | 
PTE_P
 | 
PTE_W
,

353 0x14e000 | 
PTE_P
 | 
PTE_W
,

354 0x14f000 | 
PTE_P
 | 
PTE_W
,

355 0x150000 | 
PTE_P
 | 
PTE_W
,

356 0x151000 | 
PTE_P
 | 
PTE_W
,

357 0x152000 | 
PTE_P
 | 
PTE_W
,

358 0x153000 | 
PTE_P
 | 
PTE_W
,

359 0x154000 | 
PTE_P
 | 
PTE_W
,

360 0x155000 | 
PTE_P
 | 
PTE_W
,

361 0x156000 | 
PTE_P
 | 
PTE_W
,

362 0x157000 | 
PTE_P
 | 
PTE_W
,

363 0x158000 | 
PTE_P
 | 
PTE_W
,

364 0x159000 | 
PTE_P
 | 
PTE_W
,

365 0x15a000 | 
PTE_P
 | 
PTE_W
,

366 0x15b000 | 
PTE_P
 | 
PTE_W
,

367 0x15c000 | 
PTE_P
 | 
PTE_W
,

368 0x15d000 | 
PTE_P
 | 
PTE_W
,

369 0x15e000 | 
PTE_P
 | 
PTE_W
,

370 0x15f000 | 
PTE_P
 | 
PTE_W
,

371 0x160000 | 
PTE_P
 | 
PTE_W
,

372 0x161000 | 
PTE_P
 | 
PTE_W
,

373 0x162000 | 
PTE_P
 | 
PTE_W
,

374 0x163000 | 
PTE_P
 | 
PTE_W
,

375 0x164000 | 
PTE_P
 | 
PTE_W
,

376 0x165000 | 
PTE_P
 | 
PTE_W
,

377 0x166000 | 
PTE_P
 | 
PTE_W
,

378 0x167000 | 
PTE_P
 | 
PTE_W
,

379 0x168000 | 
PTE_P
 | 
PTE_W
,

380 0x169000 | 
PTE_P
 | 
PTE_W
,

381 0x16a000 | 
PTE_P
 | 
PTE_W
,

382 0x16b000 | 
PTE_P
 | 
PTE_W
,

383 0x16c000 | 
PTE_P
 | 
PTE_W
,

384 0x16d000 | 
PTE_P
 | 
PTE_W
,

385 0x16e000 | 
PTE_P
 | 
PTE_W
,

386 0x16f000 | 
PTE_P
 | 
PTE_W
,

387 0x170000 | 
PTE_P
 | 
PTE_W
,

388 0x171000 | 
PTE_P
 | 
PTE_W
,

389 0x172000 | 
PTE_P
 | 
PTE_W
,

390 0x173000 | 
PTE_P
 | 
PTE_W
,

391 0x174000 | 
PTE_P
 | 
PTE_W
,

392 0x175000 | 
PTE_P
 | 
PTE_W
,

393 0x176000 | 
PTE_P
 | 
PTE_W
,

394 0x177000 | 
PTE_P
 | 
PTE_W
,

395 0x178000 | 
PTE_P
 | 
PTE_W
,

396 0x179000 | 
PTE_P
 | 
PTE_W
,

397 0x17a000 | 
PTE_P
 | 
PTE_W
,

398 0x17b000 | 
PTE_P
 | 
PTE_W
,

399 0x17c000 | 
PTE_P
 | 
PTE_W
,

400 0x17d000 | 
PTE_P
 | 
PTE_W
,

401 0x17e000 | 
PTE_P
 | 
PTE_W
,

402 0x17f000 | 
PTE_P
 | 
PTE_W
,

403 0x180000 | 
PTE_P
 | 
PTE_W
,

404 0x181000 | 
PTE_P
 | 
PTE_W
,

405 0x182000 | 
PTE_P
 | 
PTE_W
,

406 0x183000 | 
PTE_P
 | 
PTE_W
,

407 0x184000 | 
PTE_P
 | 
PTE_W
,

408 0x185000 | 
PTE_P
 | 
PTE_W
,

409 0x186000 | 
PTE_P
 | 
PTE_W
,

410 0x187000 | 
PTE_P
 | 
PTE_W
,

411 0x188000 | 
PTE_P
 | 
PTE_W
,

412 0x189000 | 
PTE_P
 | 
PTE_W
,

413 0x18a000 | 
PTE_P
 | 
PTE_W
,

414 0x18b000 | 
PTE_P
 | 
PTE_W
,

415 0x18c000 | 
PTE_P
 | 
PTE_W
,

416 0x18d000 | 
PTE_P
 | 
PTE_W
,

417 0x18e000 | 
PTE_P
 | 
PTE_W
,

418 0x18f000 | 
PTE_P
 | 
PTE_W
,

419 0x190000 | 
PTE_P
 | 
PTE_W
,

420 0x191000 | 
PTE_P
 | 
PTE_W
,

421 0x192000 | 
PTE_P
 | 
PTE_W
,

422 0x193000 | 
PTE_P
 | 
PTE_W
,

423 0x194000 | 
PTE_P
 | 
PTE_W
,

424 0x195000 | 
PTE_P
 | 
PTE_W
,

425 0x196000 | 
PTE_P
 | 
PTE_W
,

426 0x197000 | 
PTE_P
 | 
PTE_W
,

427 0x198000 | 
PTE_P
 | 
PTE_W
,

428 0x199000 | 
PTE_P
 | 
PTE_W
,

429 0x19a000 | 
PTE_P
 | 
PTE_W
,

430 0x19b000 | 
PTE_P
 | 
PTE_W
,

431 0x19c000 | 
PTE_P
 | 
PTE_W
,

432 0x19d000 | 
PTE_P
 | 
PTE_W
,

433 0x19e000 | 
PTE_P
 | 
PTE_W
,

434 0x19f000 | 
PTE_P
 | 
PTE_W
,

435 0x1a0000 | 
PTE_P
 | 
PTE_W
,

436 0x1a1000 | 
PTE_P
 | 
PTE_W
,

437 0x1a2000 | 
PTE_P
 | 
PTE_W
,

438 0x1a3000 | 
PTE_P
 | 
PTE_W
,

439 0x1a4000 | 
PTE_P
 | 
PTE_W
,

440 0x1a5000 | 
PTE_P
 | 
PTE_W
,

441 0x1a6000 | 
PTE_P
 | 
PTE_W
,

442 0x1a7000 | 
PTE_P
 | 
PTE_W
,

443 0x1a8000 | 
PTE_P
 | 
PTE_W
,

444 0x1a9000 | 
PTE_P
 | 
PTE_W
,

445 0x1Ø000 | 
PTE_P
 | 
PTE_W
,

446 0x1ab000 | 
PTE_P
 | 
PTE_W
,

447 0x1ac000 | 
PTE_P
 | 
PTE_W
,

448 0x1ad000 | 
PTE_P
 | 
PTE_W
,

449 0x1´000 | 
PTE_P
 | 
PTE_W
,

450 0x1af000 | 
PTE_P
 | 
PTE_W
,

451 0x1b0000 | 
PTE_P
 | 
PTE_W
,

452 0x1b1000 | 
PTE_P
 | 
PTE_W
,

453 0x1b2000 | 
PTE_P
 | 
PTE_W
,

454 0x1b3000 | 
PTE_P
 | 
PTE_W
,

455 0x1b4000 | 
PTE_P
 | 
PTE_W
,

456 0x1b5000 | 
PTE_P
 | 
PTE_W
,

457 0x1b6000 | 
PTE_P
 | 
PTE_W
,

458 0x1b7000 | 
PTE_P
 | 
PTE_W
,

459 0x1b8000 | 
PTE_P
 | 
PTE_W
,

460 0x1b9000 | 
PTE_P
 | 
PTE_W
,

461 0x1ba000 | 
PTE_P
 | 
PTE_W
,

462 0x1bb000 | 
PTE_P
 | 
PTE_W
,

463 0x1bc000 | 
PTE_P
 | 
PTE_W
,

464 0x1bd000 | 
PTE_P
 | 
PTE_W
,

465 0x1be000 | 
PTE_P
 | 
PTE_W
,

466 0x1bf000 | 
PTE_P
 | 
PTE_W
,

467 0x1c0000 | 
PTE_P
 | 
PTE_W
,

468 0x1c1000 | 
PTE_P
 | 
PTE_W
,

469 0x1c2000 | 
PTE_P
 | 
PTE_W
,

470 0x1c3000 | 
PTE_P
 | 
PTE_W
,

471 0x1c4000 | 
PTE_P
 | 
PTE_W
,

472 0x1c5000 | 
PTE_P
 | 
PTE_W
,

473 0x1c6000 | 
PTE_P
 | 
PTE_W
,

474 0x1c7000 | 
PTE_P
 | 
PTE_W
,

475 0x1c8000 | 
PTE_P
 | 
PTE_W
,

476 0x1c9000 | 
PTE_P
 | 
PTE_W
,

477 0x1ˇ000 | 
PTE_P
 | 
PTE_W
,

478 0x1cb000 | 
PTE_P
 | 
PTE_W
,

479 0x1cc000 | 
PTE_P
 | 
PTE_W
,

480 0x1cd000 | 
PTE_P
 | 
PTE_W
,

481 0x1˚000 | 
PTE_P
 | 
PTE_W
,

482 0x1cf000 | 
PTE_P
 | 
PTE_W
,

483 0x1d0000 | 
PTE_P
 | 
PTE_W
,

484 0x1d1000 | 
PTE_P
 | 
PTE_W
,

485 0x1d2000 | 
PTE_P
 | 
PTE_W
,

486 0x1d3000 | 
PTE_P
 | 
PTE_W
,

487 0x1d4000 | 
PTE_P
 | 
PTE_W
,

488 0x1d5000 | 
PTE_P
 | 
PTE_W
,

489 0x1d6000 | 
PTE_P
 | 
PTE_W
,

490 0x1d7000 | 
PTE_P
 | 
PTE_W
,

491 0x1d8000 | 
PTE_P
 | 
PTE_W
,

492 0x1d9000 | 
PTE_P
 | 
PTE_W
,

493 0x1da000 | 
PTE_P
 | 
PTE_W
,

494 0x1db000 | 
PTE_P
 | 
PTE_W
,

495 0x1dc000 | 
PTE_P
 | 
PTE_W
,

496 0x1dd000 | 
PTE_P
 | 
PTE_W
,

497 0x1de000 | 
PTE_P
 | 
PTE_W
,

498 0x1df000 | 
PTE_P
 | 
PTE_W
,

499 0x1e0000 | 
PTE_P
 | 
PTE_W
,

500 0x1e1000 | 
PTE_P
 | 
PTE_W
,

501 0x1e2000 | 
PTE_P
 | 
PTE_W
,

502 0x1e3000 | 
PTE_P
 | 
PTE_W
,

503 0x1e4000 | 
PTE_P
 | 
PTE_W
,

504 0x1e5000 | 
PTE_P
 | 
PTE_W
,

505 0x1e6000 | 
PTE_P
 | 
PTE_W
,

506 0x1e7000 | 
PTE_P
 | 
PTE_W
,

507 0x1e8000 | 
PTE_P
 | 
PTE_W
,

508 0x1e9000 | 
PTE_P
 | 
PTE_W
,

509 0x1ó000 | 
PTE_P
 | 
PTE_W
,

510 0x1eb000 | 
PTE_P
 | 
PTE_W
,

511 0x1ec000 | 
PTE_P
 | 
PTE_W
,

512 0x1ed000 | 
PTE_P
 | 
PTE_W
,

513 0x1ì000 | 
PTE_P
 | 
PTE_W
,

514 0x1ef000 | 
PTE_P
 | 
PTE_W
,

515 0x1f0000 | 
PTE_P
 | 
PTE_W
,

516 0x1f1000 | 
PTE_P
 | 
PTE_W
,

517 0x1f2000 | 
PTE_P
 | 
PTE_W
,

518 0x1f3000 | 
PTE_P
 | 
PTE_W
,

519 0x1f4000 | 
PTE_P
 | 
PTE_W
,

520 0x1f5000 | 
PTE_P
 | 
PTE_W
,

521 0x1f6000 | 
PTE_P
 | 
PTE_W
,

522 0x1f7000 | 
PTE_P
 | 
PTE_W
,

523 0x1f8000 | 
PTE_P
 | 
PTE_W
,

524 0x1f9000 | 
PTE_P
 | 
PTE_W
,

525 0x1Á000 | 
PTE_P
 | 
PTE_W
,

526 0x1fb000 | 
PTE_P
 | 
PTE_W
,

527 0x1fc000 | 
PTE_P
 | 
PTE_W
,

528 0x1fd000 | 
PTE_P
 | 
PTE_W
,

529 0x1„000 | 
PTE_P
 | 
PTE_W
,

530 0x1ff000 | 
PTE_P
 | 
PTE_W
,

531 0x200000 | 
PTE_P
 | 
PTE_W
,

532 0x201000 | 
PTE_P
 | 
PTE_W
,

533 0x202000 | 
PTE_P
 | 
PTE_W
,

534 0x203000 | 
PTE_P
 | 
PTE_W
,

535 0x204000 | 
PTE_P
 | 
PTE_W
,

536 0x205000 | 
PTE_P
 | 
PTE_W
,

537 0x206000 | 
PTE_P
 | 
PTE_W
,

538 0x207000 | 
PTE_P
 | 
PTE_W
,

539 0x208000 | 
PTE_P
 | 
PTE_W
,

540 0x209000 | 
PTE_P
 | 
PTE_W
,

541 0x20a000 | 
PTE_P
 | 
PTE_W
,

542 0x20b000 | 
PTE_P
 | 
PTE_W
,

543 0x20c000 | 
PTE_P
 | 
PTE_W
,

544 0x20d000 | 
PTE_P
 | 
PTE_W
,

545 0x20e000 | 
PTE_P
 | 
PTE_W
,

546 0x20f000 | 
PTE_P
 | 
PTE_W
,

547 0x210000 | 
PTE_P
 | 
PTE_W
,

548 0x211000 | 
PTE_P
 | 
PTE_W
,

549 0x212000 | 
PTE_P
 | 
PTE_W
,

550 0x213000 | 
PTE_P
 | 
PTE_W
,

551 0x214000 | 
PTE_P
 | 
PTE_W
,

552 0x215000 | 
PTE_P
 | 
PTE_W
,

553 0x216000 | 
PTE_P
 | 
PTE_W
,

554 0x217000 | 
PTE_P
 | 
PTE_W
,

555 0x218000 | 
PTE_P
 | 
PTE_W
,

556 0x219000 | 
PTE_P
 | 
PTE_W
,

557 0x21a000 | 
PTE_P
 | 
PTE_W
,

558 0x21b000 | 
PTE_P
 | 
PTE_W
,

559 0x21c000 | 
PTE_P
 | 
PTE_W
,

560 0x21d000 | 
PTE_P
 | 
PTE_W
,

561 0x21e000 | 
PTE_P
 | 
PTE_W
,

562 0x21f000 | 
PTE_P
 | 
PTE_W
,

563 0x220000 | 
PTE_P
 | 
PTE_W
,

564 0x221000 | 
PTE_P
 | 
PTE_W
,

565 0x222000 | 
PTE_P
 | 
PTE_W
,

566 0x223000 | 
PTE_P
 | 
PTE_W
,

567 0x224000 | 
PTE_P
 | 
PTE_W
,

568 0x225000 | 
PTE_P
 | 
PTE_W
,

569 0x226000 | 
PTE_P
 | 
PTE_W
,

570 0x227000 | 
PTE_P
 | 
PTE_W
,

571 0x228000 | 
PTE_P
 | 
PTE_W
,

572 0x229000 | 
PTE_P
 | 
PTE_W
,

573 0x22a000 | 
PTE_P
 | 
PTE_W
,

574 0x22b000 | 
PTE_P
 | 
PTE_W
,

575 0x22c000 | 
PTE_P
 | 
PTE_W
,

576 0x22d000 | 
PTE_P
 | 
PTE_W
,

577 0x22e000 | 
PTE_P
 | 
PTE_W
,

578 0x22f000 | 
PTE_P
 | 
PTE_W
,

579 0x230000 | 
PTE_P
 | 
PTE_W
,

580 0x231000 | 
PTE_P
 | 
PTE_W
,

581 0x232000 | 
PTE_P
 | 
PTE_W
,

582 0x233000 | 
PTE_P
 | 
PTE_W
,

583 0x234000 | 
PTE_P
 | 
PTE_W
,

584 0x235000 | 
PTE_P
 | 
PTE_W
,

585 0x236000 | 
PTE_P
 | 
PTE_W
,

586 0x237000 | 
PTE_P
 | 
PTE_W
,

587 0x238000 | 
PTE_P
 | 
PTE_W
,

588 0x239000 | 
PTE_P
 | 
PTE_W
,

589 0x23a000 | 
PTE_P
 | 
PTE_W
,

590 0x23b000 | 
PTE_P
 | 
PTE_W
,

591 0x23c000 | 
PTE_P
 | 
PTE_W
,

592 0x23d000 | 
PTE_P
 | 
PTE_W
,

593 0x23e000 | 
PTE_P
 | 
PTE_W
,

594 0x23f000 | 
PTE_P
 | 
PTE_W
,

595 0x240000 | 
PTE_P
 | 
PTE_W
,

596 0x241000 | 
PTE_P
 | 
PTE_W
,

597 0x242000 | 
PTE_P
 | 
PTE_W
,

598 0x243000 | 
PTE_P
 | 
PTE_W
,

599 0x244000 | 
PTE_P
 | 
PTE_W
,

600 0x245000 | 
PTE_P
 | 
PTE_W
,

601 0x246000 | 
PTE_P
 | 
PTE_W
,

602 0x247000 | 
PTE_P
 | 
PTE_W
,

603 0x248000 | 
PTE_P
 | 
PTE_W
,

604 0x249000 | 
PTE_P
 | 
PTE_W
,

605 0x24a000 | 
PTE_P
 | 
PTE_W
,

606 0x24b000 | 
PTE_P
 | 
PTE_W
,

607 0x24c000 | 
PTE_P
 | 
PTE_W
,

608 0x24d000 | 
PTE_P
 | 
PTE_W
,

609 0x24e000 | 
PTE_P
 | 
PTE_W
,

610 0x24f000 | 
PTE_P
 | 
PTE_W
,

611 0x250000 | 
PTE_P
 | 
PTE_W
,

612 0x251000 | 
PTE_P
 | 
PTE_W
,

613 0x252000 | 
PTE_P
 | 
PTE_W
,

614 0x253000 | 
PTE_P
 | 
PTE_W
,

615 0x254000 | 
PTE_P
 | 
PTE_W
,

616 0x255000 | 
PTE_P
 | 
PTE_W
,

617 0x256000 | 
PTE_P
 | 
PTE_W
,

618 0x257000 | 
PTE_P
 | 
PTE_W
,

619 0x258000 | 
PTE_P
 | 
PTE_W
,

620 0x259000 | 
PTE_P
 | 
PTE_W
,

621 0x25a000 | 
PTE_P
 | 
PTE_W
,

622 0x25b000 | 
PTE_P
 | 
PTE_W
,

623 0x25c000 | 
PTE_P
 | 
PTE_W
,

624 0x25d000 | 
PTE_P
 | 
PTE_W
,

625 0x25e000 | 
PTE_P
 | 
PTE_W
,

626 0x25f000 | 
PTE_P
 | 
PTE_W
,

627 0x260000 | 
PTE_P
 | 
PTE_W
,

628 0x261000 | 
PTE_P
 | 
PTE_W
,

629 0x262000 | 
PTE_P
 | 
PTE_W
,

630 0x263000 | 
PTE_P
 | 
PTE_W
,

631 0x264000 | 
PTE_P
 | 
PTE_W
,

632 0x265000 | 
PTE_P
 | 
PTE_W
,

633 0x266000 | 
PTE_P
 | 
PTE_W
,

634 0x267000 | 
PTE_P
 | 
PTE_W
,

635 0x268000 | 
PTE_P
 | 
PTE_W
,

636 0x269000 | 
PTE_P
 | 
PTE_W
,

637 0x26a000 | 
PTE_P
 | 
PTE_W
,

638 0x26b000 | 
PTE_P
 | 
PTE_W
,

639 0x26c000 | 
PTE_P
 | 
PTE_W
,

640 0x26d000 | 
PTE_P
 | 
PTE_W
,

641 0x26e000 | 
PTE_P
 | 
PTE_W
,

642 0x26f000 | 
PTE_P
 | 
PTE_W
,

643 0x270000 | 
PTE_P
 | 
PTE_W
,

644 0x271000 | 
PTE_P
 | 
PTE_W
,

645 0x272000 | 
PTE_P
 | 
PTE_W
,

646 0x273000 | 
PTE_P
 | 
PTE_W
,

647 0x274000 | 
PTE_P
 | 
PTE_W
,

648 0x275000 | 
PTE_P
 | 
PTE_W
,

649 0x276000 | 
PTE_P
 | 
PTE_W
,

650 0x277000 | 
PTE_P
 | 
PTE_W
,

651 0x278000 | 
PTE_P
 | 
PTE_W
,

652 0x279000 | 
PTE_P
 | 
PTE_W
,

653 0x27a000 | 
PTE_P
 | 
PTE_W
,

654 0x27b000 | 
PTE_P
 | 
PTE_W
,

655 0x27c000 | 
PTE_P
 | 
PTE_W
,

656 0x27d000 | 
PTE_P
 | 
PTE_W
,

657 0x27e000 | 
PTE_P
 | 
PTE_W
,

658 0x27f000 | 
PTE_P
 | 
PTE_W
,

659 0x280000 | 
PTE_P
 | 
PTE_W
,

660 0x281000 | 
PTE_P
 | 
PTE_W
,

661 0x282000 | 
PTE_P
 | 
PTE_W
,

662 0x283000 | 
PTE_P
 | 
PTE_W
,

663 0x284000 | 
PTE_P
 | 
PTE_W
,

664 0x285000 | 
PTE_P
 | 
PTE_W
,

665 0x286000 | 
PTE_P
 | 
PTE_W
,

666 0x287000 | 
PTE_P
 | 
PTE_W
,

667 0x288000 | 
PTE_P
 | 
PTE_W
,

668 0x289000 | 
PTE_P
 | 
PTE_W
,

669 0x28a000 | 
PTE_P
 | 
PTE_W
,

670 0x28b000 | 
PTE_P
 | 
PTE_W
,

671 0x28c000 | 
PTE_P
 | 
PTE_W
,

672 0x28d000 | 
PTE_P
 | 
PTE_W
,

673 0x28e000 | 
PTE_P
 | 
PTE_W
,

674 0x28f000 | 
PTE_P
 | 
PTE_W
,

675 0x290000 | 
PTE_P
 | 
PTE_W
,

676 0x291000 | 
PTE_P
 | 
PTE_W
,

677 0x292000 | 
PTE_P
 | 
PTE_W
,

678 0x293000 | 
PTE_P
 | 
PTE_W
,

679 0x294000 | 
PTE_P
 | 
PTE_W
,

680 0x295000 | 
PTE_P
 | 
PTE_W
,

681 0x296000 | 
PTE_P
 | 
PTE_W
,

682 0x297000 | 
PTE_P
 | 
PTE_W
,

683 0x298000 | 
PTE_P
 | 
PTE_W
,

684 0x299000 | 
PTE_P
 | 
PTE_W
,

685 0x29a000 | 
PTE_P
 | 
PTE_W
,

686 0x29b000 | 
PTE_P
 | 
PTE_W
,

687 0x29c000 | 
PTE_P
 | 
PTE_W
,

688 0x29d000 | 
PTE_P
 | 
PTE_W
,

689 0x29e000 | 
PTE_P
 | 
PTE_W
,

690 0x29f000 | 
PTE_P
 | 
PTE_W
,

691 0x2a0000 | 
PTE_P
 | 
PTE_W
,

692 0x2a1000 | 
PTE_P
 | 
PTE_W
,

693 0x2a2000 | 
PTE_P
 | 
PTE_W
,

694 0x2a3000 | 
PTE_P
 | 
PTE_W
,

695 0x2a4000 | 
PTE_P
 | 
PTE_W
,

696 0x2a5000 | 
PTE_P
 | 
PTE_W
,

697 0x2a6000 | 
PTE_P
 | 
PTE_W
,

698 0x2a7000 | 
PTE_P
 | 
PTE_W
,

699 0x2a8000 | 
PTE_P
 | 
PTE_W
,

700 0x2a9000 | 
PTE_P
 | 
PTE_W
,

701 0x2Ø000 | 
PTE_P
 | 
PTE_W
,

702 0x2ab000 | 
PTE_P
 | 
PTE_W
,

703 0x2ac000 | 
PTE_P
 | 
PTE_W
,

704 0x2ad000 | 
PTE_P
 | 
PTE_W
,

705 0x2´000 | 
PTE_P
 | 
PTE_W
,

706 0x2af000 | 
PTE_P
 | 
PTE_W
,

707 0x2b0000 | 
PTE_P
 | 
PTE_W
,

708 0x2b1000 | 
PTE_P
 | 
PTE_W
,

709 0x2b2000 | 
PTE_P
 | 
PTE_W
,

710 0x2b3000 | 
PTE_P
 | 
PTE_W
,

711 0x2b4000 | 
PTE_P
 | 
PTE_W
,

712 0x2b5000 | 
PTE_P
 | 
PTE_W
,

713 0x2b6000 | 
PTE_P
 | 
PTE_W
,

714 0x2b7000 | 
PTE_P
 | 
PTE_W
,

715 0x2b8000 | 
PTE_P
 | 
PTE_W
,

716 0x2b9000 | 
PTE_P
 | 
PTE_W
,

717 0x2ba000 | 
PTE_P
 | 
PTE_W
,

718 0x2bb000 | 
PTE_P
 | 
PTE_W
,

719 0x2bc000 | 
PTE_P
 | 
PTE_W
,

720 0x2bd000 | 
PTE_P
 | 
PTE_W
,

721 0x2be000 | 
PTE_P
 | 
PTE_W
,

722 0x2bf000 | 
PTE_P
 | 
PTE_W
,

723 0x2c0000 | 
PTE_P
 | 
PTE_W
,

724 0x2c1000 | 
PTE_P
 | 
PTE_W
,

725 0x2c2000 | 
PTE_P
 | 
PTE_W
,

726 0x2c3000 | 
PTE_P
 | 
PTE_W
,

727 0x2c4000 | 
PTE_P
 | 
PTE_W
,

728 0x2c5000 | 
PTE_P
 | 
PTE_W
,

729 0x2c6000 | 
PTE_P
 | 
PTE_W
,

730 0x2c7000 | 
PTE_P
 | 
PTE_W
,

731 0x2c8000 | 
PTE_P
 | 
PTE_W
,

732 0x2c9000 | 
PTE_P
 | 
PTE_W
,

733 0x2ˇ000 | 
PTE_P
 | 
PTE_W
,

734 0x2cb000 | 
PTE_P
 | 
PTE_W
,

735 0x2cc000 | 
PTE_P
 | 
PTE_W
,

736 0x2cd000 | 
PTE_P
 | 
PTE_W
,

737 0x2˚000 | 
PTE_P
 | 
PTE_W
,

738 0x2cf000 | 
PTE_P
 | 
PTE_W
,

739 0x2d0000 | 
PTE_P
 | 
PTE_W
,

740 0x2d1000 | 
PTE_P
 | 
PTE_W
,

741 0x2d2000 | 
PTE_P
 | 
PTE_W
,

742 0x2d3000 | 
PTE_P
 | 
PTE_W
,

743 0x2d4000 | 
PTE_P
 | 
PTE_W
,

744 0x2d5000 | 
PTE_P
 | 
PTE_W
,

745 0x2d6000 | 
PTE_P
 | 
PTE_W
,

746 0x2d7000 | 
PTE_P
 | 
PTE_W
,

747 0x2d8000 | 
PTE_P
 | 
PTE_W
,

748 0x2d9000 | 
PTE_P
 | 
PTE_W
,

749 0x2da000 | 
PTE_P
 | 
PTE_W
,

750 0x2db000 | 
PTE_P
 | 
PTE_W
,

751 0x2dc000 | 
PTE_P
 | 
PTE_W
,

752 0x2dd000 | 
PTE_P
 | 
PTE_W
,

753 0x2de000 | 
PTE_P
 | 
PTE_W
,

754 0x2df000 | 
PTE_P
 | 
PTE_W
,

755 0x2e0000 | 
PTE_P
 | 
PTE_W
,

756 0x2e1000 | 
PTE_P
 | 
PTE_W
,

757 0x2e2000 | 
PTE_P
 | 
PTE_W
,

758 0x2e3000 | 
PTE_P
 | 
PTE_W
,

759 0x2e4000 | 
PTE_P
 | 
PTE_W
,

760 0x2e5000 | 
PTE_P
 | 
PTE_W
,

761 0x2e6000 | 
PTE_P
 | 
PTE_W
,

762 0x2e7000 | 
PTE_P
 | 
PTE_W
,

763 0x2e8000 | 
PTE_P
 | 
PTE_W
,

764 0x2e9000 | 
PTE_P
 | 
PTE_W
,

765 0x2ó000 | 
PTE_P
 | 
PTE_W
,

766 0x2eb000 | 
PTE_P
 | 
PTE_W
,

767 0x2ec000 | 
PTE_P
 | 
PTE_W
,

768 0x2ed000 | 
PTE_P
 | 
PTE_W
,

769 0x2ì000 | 
PTE_P
 | 
PTE_W
,

770 0x2ef000 | 
PTE_P
 | 
PTE_W
,

771 0x2f0000 | 
PTE_P
 | 
PTE_W
,

772 0x2f1000 | 
PTE_P
 | 
PTE_W
,

773 0x2f2000 | 
PTE_P
 | 
PTE_W
,

774 0x2f3000 | 
PTE_P
 | 
PTE_W
,

775 0x2f4000 | 
PTE_P
 | 
PTE_W
,

776 0x2f5000 | 
PTE_P
 | 
PTE_W
,

777 0x2f6000 | 
PTE_P
 | 
PTE_W
,

778 0x2f7000 | 
PTE_P
 | 
PTE_W
,

779 0x2f8000 | 
PTE_P
 | 
PTE_W
,

780 0x2f9000 | 
PTE_P
 | 
PTE_W
,

781 0x2Á000 | 
PTE_P
 | 
PTE_W
,

782 0x2fb000 | 
PTE_P
 | 
PTE_W
,

783 0x2fc000 | 
PTE_P
 | 
PTE_W
,

784 0x2fd000 | 
PTE_P
 | 
PTE_W
,

785 0x2„000 | 
PTE_P
 | 
PTE_W
,

786 0x2ff000 | 
PTE_P
 | 
PTE_W
,

787 0x300000 | 
PTE_P
 | 
PTE_W
,

788 0x301000 | 
PTE_P
 | 
PTE_W
,

789 0x302000 | 
PTE_P
 | 
PTE_W
,

790 0x303000 | 
PTE_P
 | 
PTE_W
,

791 0x304000 | 
PTE_P
 | 
PTE_W
,

792 0x305000 | 
PTE_P
 | 
PTE_W
,

793 0x306000 | 
PTE_P
 | 
PTE_W
,

794 0x307000 | 
PTE_P
 | 
PTE_W
,

795 0x308000 | 
PTE_P
 | 
PTE_W
,

796 0x309000 | 
PTE_P
 | 
PTE_W
,

797 0x30a000 | 
PTE_P
 | 
PTE_W
,

798 0x30b000 | 
PTE_P
 | 
PTE_W
,

799 0x30c000 | 
PTE_P
 | 
PTE_W
,

800 0x30d000 | 
PTE_P
 | 
PTE_W
,

801 0x30e000 | 
PTE_P
 | 
PTE_W
,

802 0x30f000 | 
PTE_P
 | 
PTE_W
,

803 0x310000 | 
PTE_P
 | 
PTE_W
,

804 0x311000 | 
PTE_P
 | 
PTE_W
,

805 0x312000 | 
PTE_P
 | 
PTE_W
,

806 0x313000 | 
PTE_P
 | 
PTE_W
,

807 0x314000 | 
PTE_P
 | 
PTE_W
,

808 0x315000 | 
PTE_P
 | 
PTE_W
,

809 0x316000 | 
PTE_P
 | 
PTE_W
,

810 0x317000 | 
PTE_P
 | 
PTE_W
,

811 0x318000 | 
PTE_P
 | 
PTE_W
,

812 0x319000 | 
PTE_P
 | 
PTE_W
,

813 0x31a000 | 
PTE_P
 | 
PTE_W
,

814 0x31b000 | 
PTE_P
 | 
PTE_W
,

815 0x31c000 | 
PTE_P
 | 
PTE_W
,

816 0x31d000 | 
PTE_P
 | 
PTE_W
,

817 0x31e000 | 
PTE_P
 | 
PTE_W
,

818 0x31f000 | 
PTE_P
 | 
PTE_W
,

819 0x320000 | 
PTE_P
 | 
PTE_W
,

820 0x321000 | 
PTE_P
 | 
PTE_W
,

821 0x322000 | 
PTE_P
 | 
PTE_W
,

822 0x323000 | 
PTE_P
 | 
PTE_W
,

823 0x324000 | 
PTE_P
 | 
PTE_W
,

824 0x325000 | 
PTE_P
 | 
PTE_W
,

825 0x326000 | 
PTE_P
 | 
PTE_W
,

826 0x327000 | 
PTE_P
 | 
PTE_W
,

827 0x328000 | 
PTE_P
 | 
PTE_W
,

828 0x329000 | 
PTE_P
 | 
PTE_W
,

829 0x32a000 | 
PTE_P
 | 
PTE_W
,

830 0x32b000 | 
PTE_P
 | 
PTE_W
,

831 0x32c000 | 
PTE_P
 | 
PTE_W
,

832 0x32d000 | 
PTE_P
 | 
PTE_W
,

833 0x32e000 | 
PTE_P
 | 
PTE_W
,

834 0x32f000 | 
PTE_P
 | 
PTE_W
,

835 0x330000 | 
PTE_P
 | 
PTE_W
,

836 0x331000 | 
PTE_P
 | 
PTE_W
,

837 0x332000 | 
PTE_P
 | 
PTE_W
,

838 0x333000 | 
PTE_P
 | 
PTE_W
,

839 0x334000 | 
PTE_P
 | 
PTE_W
,

840 0x335000 | 
PTE_P
 | 
PTE_W
,

841 0x336000 | 
PTE_P
 | 
PTE_W
,

842 0x337000 | 
PTE_P
 | 
PTE_W
,

843 0x338000 | 
PTE_P
 | 
PTE_W
,

844 0x339000 | 
PTE_P
 | 
PTE_W
,

845 0x33a000 | 
PTE_P
 | 
PTE_W
,

846 0x33b000 | 
PTE_P
 | 
PTE_W
,

847 0x33c000 | 
PTE_P
 | 
PTE_W
,

848 0x33d000 | 
PTE_P
 | 
PTE_W
,

849 0x33e000 | 
PTE_P
 | 
PTE_W
,

850 0x33f000 | 
PTE_P
 | 
PTE_W
,

851 0x340000 | 
PTE_P
 | 
PTE_W
,

852 0x341000 | 
PTE_P
 | 
PTE_W
,

853 0x342000 | 
PTE_P
 | 
PTE_W
,

854 0x343000 | 
PTE_P
 | 
PTE_W
,

855 0x344000 | 
PTE_P
 | 
PTE_W
,

856 0x345000 | 
PTE_P
 | 
PTE_W
,

857 0x346000 | 
PTE_P
 | 
PTE_W
,

858 0x347000 | 
PTE_P
 | 
PTE_W
,

859 0x348000 | 
PTE_P
 | 
PTE_W
,

860 0x349000 | 
PTE_P
 | 
PTE_W
,

861 0x34a000 | 
PTE_P
 | 
PTE_W
,

862 0x34b000 | 
PTE_P
 | 
PTE_W
,

863 0x34c000 | 
PTE_P
 | 
PTE_W
,

864 0x34d000 | 
PTE_P
 | 
PTE_W
,

865 0x34e000 | 
PTE_P
 | 
PTE_W
,

866 0x34f000 | 
PTE_P
 | 
PTE_W
,

867 0x350000 | 
PTE_P
 | 
PTE_W
,

868 0x351000 | 
PTE_P
 | 
PTE_W
,

869 0x352000 | 
PTE_P
 | 
PTE_W
,

870 0x353000 | 
PTE_P
 | 
PTE_W
,

871 0x354000 | 
PTE_P
 | 
PTE_W
,

872 0x355000 | 
PTE_P
 | 
PTE_W
,

873 0x356000 | 
PTE_P
 | 
PTE_W
,

874 0x357000 | 
PTE_P
 | 
PTE_W
,

875 0x358000 | 
PTE_P
 | 
PTE_W
,

876 0x359000 | 
PTE_P
 | 
PTE_W
,

877 0x35a000 | 
PTE_P
 | 
PTE_W
,

878 0x35b000 | 
PTE_P
 | 
PTE_W
,

879 0x35c000 | 
PTE_P
 | 
PTE_W
,

880 0x35d000 | 
PTE_P
 | 
PTE_W
,

881 0x35e000 | 
PTE_P
 | 
PTE_W
,

882 0x35f000 | 
PTE_P
 | 
PTE_W
,

883 0x360000 | 
PTE_P
 | 
PTE_W
,

884 0x361000 | 
PTE_P
 | 
PTE_W
,

885 0x362000 | 
PTE_P
 | 
PTE_W
,

886 0x363000 | 
PTE_P
 | 
PTE_W
,

887 0x364000 | 
PTE_P
 | 
PTE_W
,

888 0x365000 | 
PTE_P
 | 
PTE_W
,

889 0x366000 | 
PTE_P
 | 
PTE_W
,

890 0x367000 | 
PTE_P
 | 
PTE_W
,

891 0x368000 | 
PTE_P
 | 
PTE_W
,

892 0x369000 | 
PTE_P
 | 
PTE_W
,

893 0x36a000 | 
PTE_P
 | 
PTE_W
,

894 0x36b000 | 
PTE_P
 | 
PTE_W
,

895 0x36c000 | 
PTE_P
 | 
PTE_W
,

896 0x36d000 | 
PTE_P
 | 
PTE_W
,

897 0x36e000 | 
PTE_P
 | 
PTE_W
,

898 0x36f000 | 
PTE_P
 | 
PTE_W
,

899 0x370000 | 
PTE_P
 | 
PTE_W
,

900 0x371000 | 
PTE_P
 | 
PTE_W
,

901 0x372000 | 
PTE_P
 | 
PTE_W
,

902 0x373000 | 
PTE_P
 | 
PTE_W
,

903 0x374000 | 
PTE_P
 | 
PTE_W
,

904 0x375000 | 
PTE_P
 | 
PTE_W
,

905 0x376000 | 
PTE_P
 | 
PTE_W
,

906 0x377000 | 
PTE_P
 | 
PTE_W
,

907 0x378000 | 
PTE_P
 | 
PTE_W
,

908 0x379000 | 
PTE_P
 | 
PTE_W
,

909 0x37a000 | 
PTE_P
 | 
PTE_W
,

910 0x37b000 | 
PTE_P
 | 
PTE_W
,

911 0x37c000 | 
PTE_P
 | 
PTE_W
,

912 0x37d000 | 
PTE_P
 | 
PTE_W
,

913 0x37e000 | 
PTE_P
 | 
PTE_W
,

914 0x37f000 | 
PTE_P
 | 
PTE_W
,

915 0x380000 | 
PTE_P
 | 
PTE_W
,

916 0x381000 | 
PTE_P
 | 
PTE_W
,

917 0x382000 | 
PTE_P
 | 
PTE_W
,

918 0x383000 | 
PTE_P
 | 
PTE_W
,

919 0x384000 | 
PTE_P
 | 
PTE_W
,

920 0x385000 | 
PTE_P
 | 
PTE_W
,

921 0x386000 | 
PTE_P
 | 
PTE_W
,

922 0x387000 | 
PTE_P
 | 
PTE_W
,

923 0x388000 | 
PTE_P
 | 
PTE_W
,

924 0x389000 | 
PTE_P
 | 
PTE_W
,

925 0x38a000 | 
PTE_P
 | 
PTE_W
,

926 0x38b000 | 
PTE_P
 | 
PTE_W
,

927 0x38c000 | 
PTE_P
 | 
PTE_W
,

928 0x38d000 | 
PTE_P
 | 
PTE_W
,

929 0x38e000 | 
PTE_P
 | 
PTE_W
,

930 0x38f000 | 
PTE_P
 | 
PTE_W
,

931 0x390000 | 
PTE_P
 | 
PTE_W
,

932 0x391000 | 
PTE_P
 | 
PTE_W
,

933 0x392000 | 
PTE_P
 | 
PTE_W
,

934 0x393000 | 
PTE_P
 | 
PTE_W
,

935 0x394000 | 
PTE_P
 | 
PTE_W
,

936 0x395000 | 
PTE_P
 | 
PTE_W
,

937 0x396000 | 
PTE_P
 | 
PTE_W
,

938 0x397000 | 
PTE_P
 | 
PTE_W
,

939 0x398000 | 
PTE_P
 | 
PTE_W
,

940 0x399000 | 
PTE_P
 | 
PTE_W
,

941 0x39a000 | 
PTE_P
 | 
PTE_W
,

942 0x39b000 | 
PTE_P
 | 
PTE_W
,

943 0x39c000 | 
PTE_P
 | 
PTE_W
,

944 0x39d000 | 
PTE_P
 | 
PTE_W
,

945 0x39e000 | 
PTE_P
 | 
PTE_W
,

946 0x39f000 | 
PTE_P
 | 
PTE_W
,

947 0x3a0000 | 
PTE_P
 | 
PTE_W
,

948 0x3a1000 | 
PTE_P
 | 
PTE_W
,

949 0x3a2000 | 
PTE_P
 | 
PTE_W
,

950 0x3a3000 | 
PTE_P
 | 
PTE_W
,

951 0x3a4000 | 
PTE_P
 | 
PTE_W
,

952 0x3a5000 | 
PTE_P
 | 
PTE_W
,

953 0x3a6000 | 
PTE_P
 | 
PTE_W
,

954 0x3a7000 | 
PTE_P
 | 
PTE_W
,

955 0x3a8000 | 
PTE_P
 | 
PTE_W
,

956 0x3a9000 | 
PTE_P
 | 
PTE_W
,

957 0x3Ø000 | 
PTE_P
 | 
PTE_W
,

958 0x3ab000 | 
PTE_P
 | 
PTE_W
,

959 0x3ac000 | 
PTE_P
 | 
PTE_W
,

960 0x3ad000 | 
PTE_P
 | 
PTE_W
,

961 0x3´000 | 
PTE_P
 | 
PTE_W
,

962 0x3af000 | 
PTE_P
 | 
PTE_W
,

963 0x3b0000 | 
PTE_P
 | 
PTE_W
,

964 0x3b1000 | 
PTE_P
 | 
PTE_W
,

965 0x3b2000 | 
PTE_P
 | 
PTE_W
,

966 0x3b3000 | 
PTE_P
 | 
PTE_W
,

967 0x3b4000 | 
PTE_P
 | 
PTE_W
,

968 0x3b5000 | 
PTE_P
 | 
PTE_W
,

969 0x3b6000 | 
PTE_P
 | 
PTE_W
,

970 0x3b7000 | 
PTE_P
 | 
PTE_W
,

971 0x3b8000 | 
PTE_P
 | 
PTE_W
,

972 0x3b9000 | 
PTE_P
 | 
PTE_W
,

973 0x3ba000 | 
PTE_P
 | 
PTE_W
,

974 0x3bb000 | 
PTE_P
 | 
PTE_W
,

975 0x3bc000 | 
PTE_P
 | 
PTE_W
,

976 0x3bd000 | 
PTE_P
 | 
PTE_W
,

977 0x3be000 | 
PTE_P
 | 
PTE_W
,

978 0x3bf000 | 
PTE_P
 | 
PTE_W
,

979 0x3c0000 | 
PTE_P
 | 
PTE_W
,

980 0x3c1000 | 
PTE_P
 | 
PTE_W
,

981 0x3c2000 | 
PTE_P
 | 
PTE_W
,

982 0x3c3000 | 
PTE_P
 | 
PTE_W
,

983 0x3c4000 | 
PTE_P
 | 
PTE_W
,

984 0x3c5000 | 
PTE_P
 | 
PTE_W
,

985 0x3c6000 | 
PTE_P
 | 
PTE_W
,

986 0x3c7000 | 
PTE_P
 | 
PTE_W
,

987 0x3c8000 | 
PTE_P
 | 
PTE_W
,

988 0x3c9000 | 
PTE_P
 | 
PTE_W
,

989 0x3ˇ000 | 
PTE_P
 | 
PTE_W
,

990 0x3cb000 | 
PTE_P
 | 
PTE_W
,

991 0x3cc000 | 
PTE_P
 | 
PTE_W
,

992 0x3cd000 | 
PTE_P
 | 
PTE_W
,

993 0x3˚000 | 
PTE_P
 | 
PTE_W
,

994 0x3cf000 | 
PTE_P
 | 
PTE_W
,

995 0x3d0000 | 
PTE_P
 | 
PTE_W
,

996 0x3d1000 | 
PTE_P
 | 
PTE_W
,

997 0x3d2000 | 
PTE_P
 | 
PTE_W
,

998 0x3d3000 | 
PTE_P
 | 
PTE_W
,

999 0x3d4000 | 
PTE_P
 | 
PTE_W
,

1000 0x3d5000 | 
PTE_P
 | 
PTE_W
,

1001 0x3d6000 | 
PTE_P
 | 
PTE_W
,

1002 0x3d7000 | 
PTE_P
 | 
PTE_W
,

1003 0x3d8000 | 
PTE_P
 | 
PTE_W
,

1004 0x3d9000 | 
PTE_P
 | 
PTE_W
,

1005 0x3da000 | 
PTE_P
 | 
PTE_W
,

1006 0x3db000 | 
PTE_P
 | 
PTE_W
,

1007 0x3dc000 | 
PTE_P
 | 
PTE_W
,

1008 0x3dd000 | 
PTE_P
 | 
PTE_W
,

1009 0x3de000 | 
PTE_P
 | 
PTE_W
,

1010 0x3df000 | 
PTE_P
 | 
PTE_W
,

1011 0x3e0000 | 
PTE_P
 | 
PTE_W
,

1012 0x3e1000 | 
PTE_P
 | 
PTE_W
,

1013 0x3e2000 | 
PTE_P
 | 
PTE_W
,

1014 0x3e3000 | 
PTE_P
 | 
PTE_W
,

1015 0x3e4000 | 
PTE_P
 | 
PTE_W
,

1016 0x3e5000 | 
PTE_P
 | 
PTE_W
,

1017 0x3e6000 | 
PTE_P
 | 
PTE_W
,

1018 0x3e7000 | 
PTE_P
 | 
PTE_W
,

1019 0x3e8000 | 
PTE_P
 | 
PTE_W
,

1020 0x3e9000 | 
PTE_P
 | 
PTE_W
,

1021 0x3ó000 | 
PTE_P
 | 
PTE_W
,

1022 0x3eb000 | 
PTE_P
 | 
PTE_W
,

1023 0x3ec000 | 
PTE_P
 | 
PTE_W
,

1024 0x3ed000 | 
PTE_P
 | 
PTE_W
,

1025 0x3ì000 | 
PTE_P
 | 
PTE_W
,

1026 0x3ef000 | 
PTE_P
 | 
PTE_W
,

1027 0x3f0000 | 
PTE_P
 | 
PTE_W
,

1028 0x3f1000 | 
PTE_P
 | 
PTE_W
,

1029 0x3f2000 | 
PTE_P
 | 
PTE_W
,

1030 0x3f3000 | 
PTE_P
 | 
PTE_W
,

1031 0x3f4000 | 
PTE_P
 | 
PTE_W
,

1032 0x3f5000 | 
PTE_P
 | 
PTE_W
,

1033 0x3f6000 | 
PTE_P
 | 
PTE_W
,

1034 0x3f7000 | 
PTE_P
 | 
PTE_W
,

1035 0x3f8000 | 
PTE_P
 | 
PTE_W
,

1036 0x3f9000 | 
PTE_P
 | 
PTE_W
,

1037 0x3Á000 | 
PTE_P
 | 
PTE_W
,

1038 0x3fb000 | 
PTE_P
 | 
PTE_W
,

1039 0x3fc000 | 
PTE_P
 | 
PTE_W
,

1040 0x3fd000 | 
PTE_P
 | 
PTE_W
,

1041 0x3„000 | 
PTE_P
 | 
PTE_W
,

1042 0x3ff000 | 
PTE_P
 | 
PTE_W
,

1043 
	}
};

	@env.c

1 
	~<x86.h
>

2 
	~<utû.h
>

3 
	~<°rög.h
>

4 
	~<ñf.h
>

5 
	~<°dio.h
>

7 
	~<ív.h
>

8 
	~<pm≠.h
>

9 
	~<å≠.h
>

10 
	~<m⁄ô‹.h
>

11 
	~<sched.h
>

12 
	~<•ölock.h
>

14 
Env
 *
	gívs
 = 
NULL
;

15 
Env
 *
	gcuªnv
 = 
NULL
;

16 
Env
 *
	gív_‰ì_li°
;

19 
	#ENVGENSHIFT
 12

20 

	)

36 
Segdesc
 
	ggdt
[] =

39 
SEG_NULL
,

42 [
GD_KT
 >> 3] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xffffffff, 0),

45 [
GD_KD
 >> 3] = 
SEG
(
STA_W
, 0x0, 0xffffffff, 0),

48 [
GD_UT
 >> 3] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xffffffff, 3),

51 [
GD_UD
 >> 3] = 
SEG
(
STA_W
, 0x0, 0xffffffff, 3),

54 [
GD_TSS0
 >> 3] = 
SEG_NULL


57 
P£udodesc
 
	ggdt_pd
 = {

58 (
gdt
) - 1, () gdt

72 
	$ívid2ív
(
ívid_t
 
ívid
, 
Env
 **
ív_°‹e
, 
boﬁ
 
check≥rm
)

74 
Env
 *
e
;

77 i‡(
ívid
 == 0) {

78 *
ív_°‹e
 = 
cuªnv
;

87 
e
 = &
ívs
[
	`ENVX
(
ívid
)];

88 i‡(
e
->
ív_°©us
 =
ENV_FREE
 ||É->
ív_id
 !
ívid
) {

89 *
ív_°‹e
 = 0;

90  -
E_BAD_ENV
;

98 i‡(
check≥rm
 && 
e
 !
cuªnv
 &&É->
ív_∑ª¡_id
 !cuªnv->
ív_id
) {

99 *
ív_°‹e
 = 0;

100  -
E_BAD_ENV
;

103 *
ív_°‹e
 = 
e
;

105 
	}
}

114 
	$ív_öô
()

117 
i
 = 
NENV
 - 1;

118 ; 
i
 >= 0; --i)

120 
ívs
[
i
].
ív_id
 = 0;

121 
ívs
[
i
].
ív_°©us
 = 
ENV_FREE
;

122 
ívs
[
i
].
ív_lök
 = 
ív_‰ì_li°
;

123 
ív_‰ì_li°
 = &
ívs
[
i
];

127 
	`ív_öô_≥r˝u
();

128 
	}
}

132 
	$ív_öô_≥r˝u
()

134 
	`lgdt
(&
gdt_pd
);

137 
asm
 vﬁ©ûe("movw %%ax,%%gs" :: "a" (
GD_UD
|3));

138 
asm
 vﬁ©ûe("movw %%ax,%%fs" :: "a" (
GD_UD
|3));

141 
asm
 vﬁ©ûe("movw %%ax,%%es" :: "a" (
GD_KD
));

142 
asm
 vﬁ©ûe("movw %%ax,%%ds" :: "a" (
GD_KD
));

143 
asm
 vﬁ©ûe("movw %%ax,%%ss" :: "a" (
GD_KD
));

145 
asm
 vﬁ©ûe("ljm∞%0,$1f\¿1:\n" :: "i" (
GD_KT
));

148 
	`Œdt
(0);

149 
	}
}

162 
	$ív_£tup_vm
(
Env
 *
e
)

164 
PageInfo
 *
p
 = 
NULL
;

167 i‡(!(
p
 = 
	`∑ge_Æloc
(
ALLOC_ZERO
)))

168  -
E_NO_MEM
;

184 
e
->
ív_pgdú
 = (
pde_t
 *)
	`∑ge2kva
(
p
);

185 
	`mem˝y
(
e
->
ív_pgdú
, 
kîn_pgdú
, 
PGSIZE
);

186 
p
->
µ_ªf
++;

190 
e
->
ív_pgdú
[
	`PDX
(
UVPT
)] = 
	`PADDR
”->ív_pgdúË| 
PTE_P
 | 
PTE_U
;

193 
	}
}

209 
	$ív_Æloc
(
Env
 **
√wív_°‹e
, 
ívid_t
 
∑ª¡_id
)

211 
öt32_t
 
gíî©i⁄
;

212 
r
;

213 
Env
 *
e
;

215 i‡(!(
e
 = 
ív_‰ì_li°
))

216  -
E_NO_FREE_ENV
;

219 i‡((
r
 = 
	`ív_£tup_vm
(
e
)) < 0)

220  
r
;

223 
gíî©i⁄
 = (
e
->
ív_id
 + (1 << 
ENVGENSHIFT
)Ë& ~(
NENV
 - 1);

224 i‡(
gíî©i⁄
 <= 0)

225 
gíî©i⁄
 = 1 << 
ENVGENSHIFT
;

226 
e
->
ív_id
 = 
gíî©i⁄
 | (ê- 
ívs
);

229 
e
->
ív_∑ª¡_id
 = 
∑ª¡_id
;

230 
e
->
ív_ty≥
 = 
ENV_TYPE_USER
;

231 
e
->
ív_°©us
 = 
ENV_RUNNABLE
;

232 
e
->
ív_runs
 = 0;

238 
	`mem£t
(&
e
->
ív_tf
, 0, (e->env_tf));

248 
e
->
ív_tf
.
tf_ds
 = 
GD_UD
 | 3;

249 
e
->
ív_tf
.
tf_es
 = 
GD_UD
 | 3;

250 
e
->
ív_tf
.
tf_ss
 = 
GD_UD
 | 3;

251 
e
->
ív_tf
.
tf_e•
 = 
USTACKTOP
;

252 
e
->
ív_tf
.
tf_cs
 = 
GD_UT
 | 3;

256 
e
->
ív_tf
.
tf_eÊags
 |
FL_IF
;

259 
e
->
ív_pgÁu…_upˇŒ
 = 0;

262 
e
->
ív_ùc_ªcvög
 = 0;

265 
ív_‰ì_li°
 = 
e
->
ív_lök
;

266 *
√wív_°‹e
 = 
e
;

268 
	`˝rötf
("[%08x]ÇewÉnv %08x\n", 
cuªnv
 ? cuªnv->
ív_id
 : 0, 
e
->env_id);

270 
	}
}

280 
	$ªgi⁄_Æloc
(
Env
 *
e
, *
va
, 
size_t
 
Àn
)

287 
	`ROUNDDOWN
(
va
, 
PGSIZE
);

288 
	`ROUNDUP
(
Àn
, 
PGSIZE
);

290 
PageInfo
 * 
ãmp_∑ge
;

291 
size_t
 
i
 = 0;

292 
i
 = 0; i < 
Àn
; i +
PGSIZE
)

294 
ãmp_∑ge
 = 
	`∑ge_Æloc
(!
ALLOC_ZERO
);

295 i‡(!
ãmp_∑ge
)

296 
	`∑nic
("region_alloc failsÅoállocÖage");

297 
	`∑ge_ö£π
(
e
->
ív_pgdú
, 
ãmp_∑ge
, 
va
 + 
i
, 
PTE_P
 | 
PTE_W
 | 
PTE_U
);

299 
	}
}

325 
	$lﬂd_icode
(
Env
 *
e
, 
uöt8_t
 *
bö¨y
)

349 
Elf
 * 
ãmp_ñf
 = (El‡*)
bö¨y
;

350 
Proghdr
 * 
ph
 = (Proghd∏*)((
uöt8_t
 *)
ãmp_ñf
 +Åemp_ñf->
e_phoff
);

351 
Proghdr
 * 
ph_íd
 = 
ph
 + 
ãmp_ñf
->
e_phnum
;

354 
	`l¸3
(
	`PADDR
(
e
->
ív_pgdú
));

356 ; 
ph
 < 
ph_íd
; ++ph)

358 if(
ph
->
p_ty≥
 !
ELF_PROG_LOAD
)

360 
	`ªgi⁄_Æloc
(
e
, (*)
ph
->
p_va
,Öh->
p_memsz
);

361 
	`mem£t
((*)
ph
->
p_va
, 0,Öh->
p_memsz
);

362 
	`mem˝y
((*)
ph
->
p_va
, 
bö¨y
 +Öh->
p_off£t
,Öh->
p_fûesz
);

365 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

367 
e
->
ív_tf
.
tf_eù
 = 
ãmp_ñf
->
e_íåy
;

372 
	`ªgi⁄_Æloc
(
e
, (*)
USTACKTOP
 - 
PGSIZE
, PGSIZE);

375 
	}
}

385 
	$ív_¸óã
(
uöt8_t
 *
bö¨y
, 
EnvTy≥
 
ty≥
)

387 
Env
 * 
√w_ív
;

388 
	`ív_Æloc
(&
√w_ív
, 0);

389 if(
ty≥
 =
ENV_TYPE_FS
)

390 
√w_ív
->
ív_tf
.
tf_eÊags
 |
FL_IOPL_MASK
;

391 
√w_ív
->
ív_tf
.
tf_eÊags
 ^
FL_IF
;

392 
	`lﬂd_icode
(
√w_ív
, 
bö¨y
);

393 
√w_ív
->
ív_ty≥
 = 
ty≥
;

394 
	}
}

400 
	$ív_‰ì
(
Env
 *
e
)

402 
±e_t
 *
±
;

403 
uöt32_t
 
pdío
, 
±ío
;

404 
phyßddr_t
 
∑
;

409 i‡(
e
 =
cuªnv
)

410 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

413 
	`˝rötf
("[%08x] fªêív %08x\n", 
cuªnv
 ? cuªnv->
ív_id
 : 0, 
e
->env_id);

416 
pdío
 = 0;Ödíÿ< 
	`PDX
(
UTOP
);Ödeno++) {

419 i‡(!(
e
->
ív_pgdú
[
pdío
] & 
PTE_P
))

423 
∑
 = 
	`PTE_ADDR
(
e
->
ív_pgdú
[
pdío
]);

424 
±
 = (
±e_t
*Ë
	`KADDR
(
∑
);

427 
±ío
 = 0;Öãnÿ<
	`PTX
(~0);Öteno++) {

428 i‡(
±
[
±ío
] & 
PTE_P
)

429 
	`∑ge_ªmove
(
e
->
ív_pgdú
, 
	`PGADDR
(
pdío
, 
±ío
, 0));

433 
e
->
ív_pgdú
[
pdío
] = 0;

434 
	`∑ge_de¸ef
(
	`∑2∑ge
(
∑
));

438 
∑
 = 
	`PADDR
(
e
->
ív_pgdú
);

439 
e
->
ív_pgdú
 = 0;

440 
	`∑ge_de¸ef
(
	`∑2∑ge
(
∑
));

443 
e
->
ív_°©us
 = 
ENV_FREE
;

444 
e
->
ív_lök
 = 
ív_‰ì_li°
;

445 
ív_‰ì_li°
 = 
e
;

446 
	}
}

452 
	$ív_de°roy
(
Env
 *
e
)

454 i‡(
e
->
ív_°©us
 =
ENV_RUNNING
 && 
cuªnv
 !=É) {

455 
e
->
ív_°©us
 = 
ENV_DYING
;

459 
	`ív_‰ì
(
e
);

461 i‡(
cuªnv
 =
e
) {

462 
cuªnv
 = 
NULL
;

463 
	`sched_yõld
();

465 
	}
}

475 
	$ív_p›_tf
(
Tøp‰ame
 *
tf
)

477 
__asm
 
	`__vﬁ©ûe
("movl %0,%%esp\n"

484 : "g" (
tf
)

486 
	`∑nic
("iret failed");

487 
	}
}

496 
	$ív_run
(
Env
 *
e
)

515 i‡(
cuªnv
 !
e
)

517 i‡(
cuªnv
 && cuªnv->
ív_°©us
 =
ENV_RUNNING
)

518 
cuªnv
->
ív_°©us
 = 
ENV_RUNNABLE
;

519 
cuªnv
 = 
e
;

521 
e
->
ív_°©us
 = 
ENV_RUNNING
;

522 
e
->
ív_runs
++;

527 
	`l¸3
(
	`PADDR
(
e
->
ív_pgdú
));

529 
	`u∆ock_kî√l
();

530 
	`ív_p›_tf
(&(
e
->
ív_tf
));

532 
	}
}

	@env.h

1 #i‚de‡
__ENV


2 
	#__ENV


	)

4 
	~<x86.h
>

5 
	~<utû.h
>

6 
	~<å≠.h
>

25 
	#LOG2NENV
 10

	)

27 
	#NENV
 (1 << 
LOG2NENV
)

	)

28 
	#ENVX
(
ívid
Ë(”nvidË& (
NENV
 - 1))

	)

32 
	mENV_FREE
 = 0,

33 
	mENV_DYING
,

34 
	mENV_RUNNABLE
,

35 
	mENV_RUNNING
,

36 
	mENV_NOT_RUNNABLE


40 
	eEnvTy≥
 {

41 
	mENV_TYPE_USER
 = 0,

42 
	mENV_TYPE_FS
,

45 
	sEnv
 {

46 
Tøp‰ame
 
	mív_tf
;

47 
Env
 *
	mív_lök
;

48 
ívid_t
 
	mív_id
;

49 
ívid_t
 
	mív_∑ª¡_id
;

50 
EnvTy≥
 
	mív_ty≥
;

51 
	mív_°©us
;

52 
uöt32_t
 
	mív_runs
;

53 
	mív_˝unum
;

56 
pde_t
 *
	mív_pgdú
;

59 *
	mív_pgÁu…_upˇŒ
;

61 
boﬁ
 
	mív_ùc_ªcvög
;

62 *
	mív_ùc_d°va
;

63 
uöt32_t
 
	mív_ùc_vÆue
;

64 
ívid_t
 
	mív_ùc_‰om
;

65 
	mív_ùc_≥rm
;

68 #i‚def 
__FOR_USER__


70 
Env
 *
ívs
;

71 
Env
 *
cuªnv
;

72 
Segdesc
 
gdt
[];

74 
ív_öô
();

75 
ív_öô_≥r˝u
();

76 
ív_Æloc
(
Env
 **
e
, 
ívid_t
 
∑ª¡_id
);

77 
ív_‰ì
(
Env
 *
e
);

78 
ív_¸óã
(
uöt8_t
 *
bö¨y
, 
EnvTy≥
 
ty≥
);

79 
ív_de°roy
(
Env
 *
e
);

81 
ívid2ív
(
ívid_t
 
ívid
, 
Env
 **
ív_°‹e
, 
boﬁ
 
check≥rm
);

84 
	$ív_run
(
Env
 *
e
Ë
	`__©åibuã__
((
n‹ëu∫
));

85 
	$ív_p›_tf
(
Tøp‰ame
 *
tf
Ë
	`__©åibuã__
((
n‹ëu∫
));

88 
	`ív_shô_¸óã
(
uöçå_t
 
íåy
);

92 
	#ENV_PASTE3
(
x
, 
y
, 
z
Ëx ## y ## 
	)
z

94 
	#ENV_CREATE
(
x
, 
ty≥
) \

96 
uöt8_t
 
	`ENV_PASTE3
(
_bö¨y_
, 
x
, 
_°¨t
)[]; \

97 
	`ív_¸óã
(
	`ENV_PASTE3
(
_bö¨y_
, 
x
, 
_°¨t
), \

98 
ty≥
); \

99 
	}
} 0)

	)

	@error.h

1 #i‚de‡
__ERROR


2 
	#__ERROR


	)

6 
	mE_UNSPECIFIED
 = 1,

7 
	mE_BAD_ENV
 ,

9 
	mE_INVAL
 ,

10 
	mE_NO_MEM
 ,

11 
	mE_NO_FREE_ENV
 ,

13 
	mE_FAULT
 ,

15 
	mE_IPC_NOT_RECV
 ,

16 
	mE_EOF
 ,

19 
	mE_NO_DISK
 ,

20 
	mE_NO_INODE
 ,

21 
	mE_MAX_OPEN
 ,

22 
	mE_NOT_FOUND
 ,

23 
	mE_BAD_PATH
 ,

24 
	mE_BAD_NAME
 ,

25 
	mE_FILE_EXISTS
 ,

26 
	mE_NOT_EXEC
 ,

27 
	mE_NOT_SUPP
 ,

29 
	mMAXERROR


	@exit.c

2 
	~<sy¶ib.h
>

5 
	$exô
()

7 
	`˛o£_Æl
();

8 
	`sys_ív_de°roy
(0);

9 
	}
}

	@fd.c

1 
	~<sy¶ib.h
>

2 
	~<fd.h
>

3 
	~<°dio.h
>

6 
	#debug
 0

	)

9 
	#MAXFD
 32

	)

11 
	#FDTABLE
 0x20000000

	)

14 
	#FILEDATA
 (
FDTABLE
 + 
MAXFD
*
PGSIZE
)

	)

17 
	#INDEX2FD
(
i
Ë((
Fd
*Ë(
FDTABLE
 + (i)*
PGSIZE
))

	)

19 
	#INDEX2DATA
(
i
Ë((*Ë(
FILEDATA
 + (i)*
PGSIZE
))

	)

27 
	$fd2num
(
Fd
 *
fd
)

29  ((
uöçå_t
Ë
fd
 - 
FDTABLE
Ë/ 
PGSIZE
;

30 
	}
}

33 
	$fd2d©a
(
Fd
 *
fd
)

35  
	`INDEX2DATA
(
	`fd2num
(
fd
));

36 
	}
}

54 
	$fd_Æloc
(
Fd
 **
fd_°‹e
)

56 
i
;

57 
Fd
 *
fd
;

59 
i
 = 0; i < 
MAXFD
; i++) {

60 
fd
 = 
	`INDEX2FD
(
i
);

61 i‡((
uvpd
[
	`PDX
(
fd
)] & 
PTE_P
Ë=0 || (
uv±
[
	`PGNUM
(fd)] & PTE_P) == 0) {

62 *
fd_°‹e
 = 
fd
;

66 *
fd_°‹e
 = 0;

67  -
E_MAX_OPEN
;

68 
	}
}

77 
	$fd_lookup
(
fdnum
, 
Fd
 **
fd_°‹e
)

79 
Fd
 *
fd
;

81 i‡(
fdnum
 < 0 || fdnum >
MAXFD
) {

82 i‡(
debug
)

83 
	`˝rötf
("[%08x] bad fd %d\n", 
thi£nv
->
ív_id
, 
fdnum
);

84  -
E_INVAL
;

86 
fd
 = 
	`INDEX2FD
(
fdnum
);

87 i‡(!(
uvpd
[
	`PDX
(
fd
)] & 
PTE_P
Ë|| !(
uv±
[
	`PGNUM
(fd)] & PTE_P)) {

88 i‡(
debug
)

89 
	`˝rötf
("[%08x] clo£d fd %d\n", 
thi£nv
->
ív_id
, 
fdnum
);

90  -
E_INVAL
;

92 *
fd_°‹e
 = 
fd
;

94 
	}
}

104 
	$fd_˛o£
(
Fd
 *
fd
, 
boﬁ
 
mu°_exi°
)

106 
Fd
 *
fd2
;

107 
Dev
 *
dev
;

108 
r
;

109 i‡((
r
 = 
	`fd_lookup
(
	`fd2num
(
fd
), &
fd2
)) < 0

110 || 
fd
 !
fd2
)

111  (
mu°_exi°
 ? 
r
 : 0);

112 i‡((
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) >= 0) {

113 i‡(
dev
->
dev_˛o£
)

114 
r
 = (*
dev
->
dev_˛o£
)(
fd
);

116 
r
 = 0;

120 (Ë
	`sys_∑ge_unm≠
(0, 
fd
);

121  
r
;

122 
	}
}

129 
Dev
 *
	gdevèb
[] =

131 &
devfûe
,

132 &
devpùe
,

133 &
devc⁄s
,

138 
	$dev_lookup
(
dev_id
, 
Dev
 **
dev
)

140 
i
;

141 
i
 = 0; 
devèb
[i]; i++)

142 i‡(
devèb
[
i
]->
dev_id
 == dev_id) {

143 *
dev
 = 
devèb
[
i
];

146 
	`˝rötf
("[%08x] unknow¿devi˚Åy≥ %d\n", 
thi£nv
->
ív_id
, 
dev_id
);

147 *
dev
 = 0;

148  -
E_INVAL
;

149 
	}
}

152 
	$˛o£
(
fdnum
)

154 
Fd
 *
fd
;

155 
r
;

157 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

158  
r
;

160  
	`fd_˛o£
(
fd
, 1);

161 
	}
}

164 
	$˛o£_Æl
()

166 
i
;

167 
i
 = 0; i < 
MAXFD
; i++)

168 
	`˛o£
(
i
);

169 
	}
}

177 
	$dup
(
ﬁdfdnum
, 
√wfdnum
)

179 
r
;

180 *
ova
, *
nva
;

181 
Fd
 *
ﬁdfd
, *
√wfd
;

183 i‡((
r
 = 
	`fd_lookup
(
ﬁdfdnum
, &
ﬁdfd
)) < 0)

184  
r
;

185 
	`˛o£
(
√wfdnum
);

187 
√wfd
 = 
	`INDEX2FD
(
√wfdnum
);

188 
ova
 = 
	`fd2d©a
(
ﬁdfd
);

189 
nva
 = 
	`fd2d©a
(
√wfd
);

191 i‡((
uvpd
[
	`PDX
(
ova
)] & 
PTE_P
Ë&& (
uv±
[
	`PGNUM
(ova)] & PTE_P))

192 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
ova
, 0, 
nva
, 
uv±
[
	`PGNUM
(ova)] & 
PTE_SYSCALL
)) < 0)

193 
îr
;

194 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
ﬁdfd
, 0, 
√wfd
, 
uv±
[
	`PGNUM
(ﬁdfd)] & 
PTE_SYSCALL
)) < 0)

195 
îr
;

197  
√wfdnum
;

199 
îr
:

200 
	`sys_∑ge_unm≠
(0, 
√wfd
);

201 
	`sys_∑ge_unm≠
(0, 
nva
);

202  
r
;

203 
	}
}

205 
ssize_t


206 
	$ªad
(
fdnum
, *
buf
, 
size_t
 
n
)

208 
r
;

209 
Dev
 *
dev
;

210 
Fd
 *
fd
;

212 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

213 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

214  
r
;

215 i‡((
fd
->
fd_omode
 & 
O_ACCMODE
Ë=
O_WRONLY
) {

216 
	`˝rötf
("[%08x]Ñód %d -- bad mode\n", 
thi£nv
->
ív_id
, 
fdnum
);

217  -
E_INVAL
;

219 i‡(!
dev
->
dev_ªad
)

220  -
E_NOT_SUPP
;

221  (*
dev
->
dev_ªad
)(
fd
, 
buf
, 
n
);

222 
	}
}

224 
ssize_t


225 
	$ªadn
(
fdnum
, *
buf
, 
size_t
 
n
)

227 
m
, 
tŸ
;

229 
tŸ
 = 0;ÅŸ < 
n
;ÅŸ +
m
) {

230 
m
 = 
	`ªad
(
fdnum
, (*)
buf
 + 
tŸ
, 
n
 -Åot);

231 i‡(
m
 < 0)

232  
m
;

233 i‡(
m
 == 0)

236  
tŸ
;

237 
	}
}

239 
ssize_t


240 
	$wrôe
(
fdnum
, c⁄° *
buf
, 
size_t
 
n
)

242 
r
;

243 
Dev
 *
dev
;

244 
Fd
 *
fd
;

246 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

247 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

248  
r
;

249 i‡((
fd
->
fd_omode
 & 
O_ACCMODE
Ë=
O_RDONLY
) {

250 
	`˝rötf
("[%08x] wrôê%d -- bad mode\n", 
thi£nv
->
ív_id
, 
fdnum
);

251  -
E_INVAL
;

253 i‡(
debug
)

254 
	`˝rötf
("write %d %p %d via dev %s\n",

255 
fdnum
, 
buf
, 
n
, 
dev
->
dev_«me
);

256 i‡(!
dev
->
dev_wrôe
)

257  -
E_NOT_SUPP
;

258  (*
dev
->
dev_wrôe
)(
fd
, 
buf
, 
n
);

259 
	}
}

262 
	$£ek
(
fdnum
, 
off_t
 
off£t
)

264 
r
;

265 
Fd
 *
fd
;

267 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

268  
r
;

269 
fd
->
fd_off£t
 = 
off£t
;

271 
	}
}

274 
	$·runˇã
(
fdnum
, 
off_t
 
√wsize
)

276 
r
;

277 
Dev
 *
dev
;

278 
Fd
 *
fd
;

279 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

280 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

281  
r
;

282 i‡((
fd
->
fd_omode
 & 
O_ACCMODE
Ë=
O_RDONLY
) {

283 
	`˝rötf
("[%08x] ftruncate %d -- bad mode\n",

284 
thi£nv
->
ív_id
, 
fdnum
);

285  -
E_INVAL
;

287 i‡(!
dev
->
dev_åunc
)

288  -
E_NOT_SUPP
;

289  (*
dev
->
dev_åunc
)(
fd
, 
√wsize
);

290 
	}
}

293 
	$f°©
(
fdnum
, 
Sèt
 *
°©
)

295 
r
;

296 
Dev
 *
dev
;

297 
Fd
 *
fd
;

299 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

300 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

301  
r
;

302 i‡(!
dev
->
dev_°©
)

303  -
E_NOT_SUPP
;

304 
°©
->
°_«me
[0] = 0;

305 
°©
->
°_size
 = 0;

306 
°©
->
°_isdú
 = 0;

307 
°©
->
°_dev
 = 
dev
;

308  (*
dev
->
dev_°©
)(
fd
, 
°©
);

309 
	}
}

312 
	$°©
(c⁄° *
∑th
, 
Sèt
 *
°©
)

314 
fd
, 
r
;

316 i‡((
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
)) < 0)

317  
fd
;

318 
r
 = 
	`f°©
(
fd
, 
°©
);

319 
	`˛o£
(
fd
);

320  
r
;

321 
	}
}

	@fd.h

5 #i‚de‡
__FD


6 
	#__FD


	)

8 
	~<x86.h
>

9 
	~<damnfs.h
>

11 
	gFd
;

12 
	gSèt
;

13 
	gDev
;

16 
	sDev
 {

17 
	mdev_id
;

18 c⁄° *
	mdev_«me
;

19 
ssize_t
 (*
dev_ªad
)(
Fd
 *
	mfd
, *
	mbuf
, 
size_t
 
	mÀn
);

20 
ssize_t
 (*
dev_wrôe
)(
Fd
 *
	mfd
, c⁄° *
	mbuf
, 
size_t
 
	mÀn
);

21 (*
	mdev_˛o£
)(
Fd
 *
	mfd
);

22 (*
	mdev_°©
)(
Fd
 *
	mfd
, 
Sèt
 *
	m°©
);

23 (*
	mdev_åunc
)(
Fd
 *
	mfd
, 
off_t
 
	mÀngth
);

26 
	sFdFûe
 {

27 
	mid
;

30 
	sFd
 {

31 
	mfd_dev_id
;

32 
off_t
 
	mfd_off£t
;

33 
	mfd_omode
;

36 
FdFûe
 
	mfd_fûe
;

40 
	sSèt
 {

41 
	m°_«me
[
MAXNAMELEN
];

42 
off_t
 
	m°_size
;

43 
	m°_isdú
;

44 
Dev
 *
	m°_dev
;

47 * 
fd2d©a
(
Fd
 *
fd
);

48 
fd2num
(
Fd
 *
fd
);

49 
fd_Æloc
(
Fd
 **
fd_°‹e
);

50 
fd_˛o£
(
Fd
 *
fd
, 
boﬁ
 
mu°_exi°
);

51 
fd_lookup
(
fdnum
, 
Fd
 **
fd_°‹e
);

52 
dev_lookup
(
devid
, 
Dev
 **
dev_°‹e
);

54 
Dev
 
devfûe
;

55 
Dev
 
devc⁄s
;

56 
Dev
 
devpùe
;

	@file.c

1 
	~<sy¶ib.h
>

2 
	~<damnfs.h
>

3 
	~<°rög.h
>

5 
	#debug
 0

	)

7 
Fsùc
 
fsùcbuf
 
__©åibuã__
((
Æig√d
(
PGSIZE
)));

16 
	$fsùc
(
ty≥
, *
d°va
)

18 
ívid_t
 
f£nv
;

19 i‡(
f£nv
 == 0)

20 
f£nv
 = 
	`ùc_föd_ív
(
ENV_TYPE_FS
);

24 i‡(
debug
)

25 
	`˝rötf
("[%08x] fsipc %d %08x\n",

26 
thi£nv
->
ív_id
, 
ty≥
, *(
uöt32_t
 *)&
fsùcbuf
);

28 
	`ùc_£nd
(
f£nv
, 
ty≥
, &
fsùcbuf
, 
PTE_P
 | 
PTE_W
 | 
PTE_U
);

29  
	`ùc_ªcv
(
NULL
, 
d°va
, NULL);

30 
	}
}

32 
devfûe_Êush
(
Fd
 *
fd
);

33 
ssize_t
 
devfûe_ªad
(
Fd
 *
fd
, *
buf
, 
size_t
 
n
);

34 
ssize_t
 
devfûe_wrôe
(
Fd
 *
fd
, c⁄° *
buf
, 
size_t
 
n
);

35 
devfûe_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
);

36 
devfûe_åunc
(
Fd
 *
fd
, 
off_t
 
√wsize
);

38 
Dev
 
	gdevfûe
 =

40 .
dev_id
 = 'f',

41 .
	gdev_«me
 = "file",

42 .
	gdev_ªad
 = 
devfûe_ªad
,

43 .
	gdev_˛o£
 = 
devfûe_Êush
,

44 .
	gdev_°©
 = 
devfûe_°©
,

45 .
	gdev_wrôe
 = 
devfûe_wrôe
,

46 .
	gdev_åunc
 = 
devfûe_åunc


56 
	$›í
(c⁄° *
∑th
, 
mode
)

72 
r
;

73 
Fd
 *
fd
;

75 i‡(
	`°æí
(
∑th
Ë>
MAXPATHLEN
)

76  -
E_BAD_PATH
;

78 i‡((
r
 = 
	`fd_Æloc
(&
fd
)) < 0)

79  
r
;

81 
	`°r˝y
(
fsùcbuf
.
›í
.
ªq_∑th
, 
∑th
);

82 
fsùcbuf
.
›í
.
ªq_omode
 = 
mode
;

84 i‡((
r
 = 
	`fsùc
(
FSREQ_OPEN
, 
fd
)) < 0) {

85 
	`fd_˛o£
(
fd
, 0);

86  
r
;

89  
	`fd2num
(
fd
);

90 
	}
}

94 
	$makedú
(c⁄° *
∑th
)

110 
r
;

111 
Fd
 *
fd
;

113 i‡(
	`°æí
(
∑th
Ë>
MAXPATHLEN
)

114  -
E_BAD_PATH
;

116 i‡((
r
 = 
	`fd_Æloc
(&
fd
)) < 0)

117  
r
;

119 
	`°r˝y
(
fsùcbuf
.
›í
.
ªq_∑th
, 
∑th
);

121 i‡((
r
 = 
	`fsùc
(
FSREQ_MKDIR
, 
fd
)) < 0) {

122 
	`fd_˛o£
(
fd
, 0);

123  
r
;

125 
	`fd_˛o£
(
fd
, 0);

127 
	}
}

130 
	$ªmove
(c⁄° *
∑th
)

146 
r
;

147 
Fd
 *
fd
;

149 i‡(
	`°æí
(
∑th
Ë>
MAXPATHLEN
)

150  -
E_BAD_PATH
;

152 i‡((
r
 = 
	`fd_Æloc
(&
fd
)) < 0)

153  
r
;

155 
	`°r˝y
(
fsùcbuf
.
›í
.
ªq_∑th
, 
∑th
);

157 i‡((
r
 = 
	`fsùc
(
FSREQ_REMOVE
, 
fd
)) < 0) {

158 
	`fd_˛o£
(
fd
, 0);

159  
r
;

161 
	`fd_˛o£
(
fd
, 0);

163 
	}
}

174 
	$devfûe_Êush
(
Fd
 *
fd
)

176 
fsùcbuf
.
Êush
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

177  
	`fsùc
(
FSREQ_FLUSH
, 
NULL
);

178 
	}
}

185 
ssize_t


186 
	$devfûe_ªad
(
Fd
 *
fd
, *
buf
, 
size_t
 
n
)

192 
r
;

194 
fsùcbuf
.
ªad
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

195 
fsùcbuf
.
ªad
.
ªq_n
 = 
n
;

196 i‡((
r
 = 
	`fsùc
(
FSREQ_READ
, 
NULL
)) < 0)

197  
r
;

198 
	`memmove
(
buf
, 
fsùcbuf
.
ªadRë
.
ªt_buf
, 
r
);

199  
r
;

200 
	}
}

208 
ssize_t


209 
	$devfûe_wrôe
(
Fd
 *
fd
, c⁄° *
buf
, 
size_t
 
n
)

216 
max
 = 
PGSIZE
 - ((Ë+ (
size_t
));

217 
n
 =Ç > 
max
 ? max :Ç;

218 
fsùcbuf
.
wrôe
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

219 
fsùcbuf
.
wrôe
.
ªq_n
 = 
n
;

220 
	`memmove
(
fsùcbuf
.
wrôe
.
ªq_buf
, 
buf
, 
n
);

221  
	`fsùc
(
FSREQ_WRITE
, 
NULL
);

222 
	}
}

225 
	$devfûe_°©
(
Fd
 *
fd
, 
Sèt
 *
°
)

227 
r
;

229 
fsùcbuf
.
°©
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

230 i‡((
r
 = 
	`fsùc
(
FSREQ_STAT
, 
NULL
)) < 0)

231  
r
;

232 
	`°r˝y
(
°
->
°_«me
, 
fsùcbuf
.
°©Rë
.
ªt_«me
);

233 
°
->
°_size
 = 
fsùcbuf
.
°©Rë
.
ªt_size
;

234 
°
->
°_isdú
 = 
fsùcbuf
.
°©Rë
.
ªt_isdú
;

236 
	}
}

240 
	$devfûe_åunc
(
Fd
 *
fd
, 
off_t
 
√wsize
)

242 
fsùcbuf
.
£t_size
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

243 
fsùcbuf
.
£t_size
.
ªq_size
 = 
√wsize
;

244  
	`fsùc
(
FSREQ_SET_SIZE
, 
NULL
);

245 
	}
}

250 
	$sync
()

255  
	`fsùc
(
FSREQ_SYNC
, 
NULL
);

256 
	}
}

	@fork.c

3 
	~<°rög.h
>

4 
	~<sy¶ib.h
>

8 
	#PTE_COW
 0x800

	)

15 
	$pgÁu…
(
UTøp‰ame
 *
utf
)

17 *
addr
 = 
	`ROUNDDOWN
((*Ë
utf
->
utf_Áu…_va
, 
PGSIZE
);

18 
uöt32_t
 
îr
 = 
utf
->
utf_îr
;

19 
r
;

25 if(!(
utf
->
utf_îr
 & 
FEC_WR
Ë&& !(
uv±
[
	`PGNUM
(utf->
utf_Áu…_va
)] & 
PTE_COW
))

26 
	`∑nic
("pgfault checkáccess fails");

31 if((
r
 = 
	`sys_∑ge_Æloc
(0, 
PFTEMP
, 
PTE_W
|
PTE_U
|
PTE_P
)) < 0)

32 
	`∑nic
("pgÁu… : sys_∑ge_Ælo¯: %e" ,
r
);

33 
	`mem˝y
(
PFTEMP
, 
addr
, 
PGSIZE
);

34 if((
r
 = 
	`sys_∑ge_m≠
(0, 
PFTEMP
, 0, 
addr
, 
PTE_W
|
PTE_U
|
PTE_P
)) < 0)

35 
	`∑nic
("pgÁu… : sys_∑ge_m≠ : %e" ,
r
);

36 if((
r
 = 
	`sys_∑ge_unm≠
(0, 
PFTEMP
)) < 0)

37 
	`∑nic
("pgÁu… : sys_∑ge_unm≠ : %e" ,
r
);

38 
	}
}

52 
	$duµage
(
ívid_t
 
ívid
, 
≤
)

54 
r
;

56 * 
addr
 = (*)(
≤
 * 
PGSIZE
);

57 if(
uv±
[
≤
] & 
PTE_SHARE
)

59 if((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 
ívid
,áddr,

60 
PTE_SHARE
 | 
PTE_SYSCALL
)) < 0)

61 
	`∑nic
("duµagê: sys_∑ge_m≠ : %e", 
r
);

63 if((
uv±
[
≤
] & 
PTE_W
Ë|| (uv±[≤] & 
PTE_COW
))

65 if((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 
ívid
,áddr, 
PTE_COW
|
PTE_U
|
PTE_P
)) < 0)

66 
	`∑nic
("duµagê: sys_∑ge_m≠ : %e", 
r
);

67 if((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 0,áddr, 
PTE_COW
|
PTE_U
|
PTE_P
)) < 0)

68 
	`∑nic
("duµagê: sys_∑ge_m≠ : %e", 
r
);

72 if((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 
ívid
,áddr, 
PTE_U
|
PTE_P
)) < 0)

73 
	`∑nic
("duµagê: sys_∑ge_m≠ : %e", 
r
);

78 
	}
}

96 
ívid_t


97 
	$f‹k
()

99 
r
;

103 
	`£t_pgÁu…_h™dÀr
(
pgÁu…
);

105 
ívid_t
 
chûd
 = 
	`sys_exof‹k
();

107 if(
chûd
 == 0)

110 
thi£nv
 = &
ívs
[
	`ENVX
(
	`sys_gëívid
())];

114 
uöt32_t
 
i
;

115 
i
 = 0; i < 
USTACKTOP
; i +
PGSIZE
)

117 if((
uvpd
[
	`PDX
(
i
)] & 
PTE_P
) &&

118 (
uv±
[
	`PGNUM
(
i
)] & 
PTE_P
) &&

119 (
uv±
[
	`PGNUM
(
i
)] & 
PTE_U
))

120 
	`duµage
(
chûd
, 
	`PGNUM
(
i
));

124 if((
r
 = 
	`sys_∑ge_Æloc
(
chûd
, (*)(
UXSTACKTOP
 - 
PGSIZE
),

125 
PTE_W
|
PTE_U
|
PTE_P
)) < 0)

126 
	`∑nic
("f‹k : sys_∑ge_Ælo¯: %e", 
r
);

129 
	`_pgÁu…_upˇŒ
();

130 if((
r
 = 
	`sys_ív_£t_pgÁu…_upˇŒ
(
chûd
, 
_pgÁu…_upˇŒ
)) < 0)

131 
	`∑nic
("f‹k : sys_ív_£t_pgÁu…_upˇŒ : %e", 
r
);

134 i‡((
r
 = 
	`sys_ív_£t_°©us
(
chûd
, 
ENV_RUNNABLE
)) < 0)

135 
	`∑nic
("sys_ív_£t_°©us: %e", 
r
);

137  
chûd
;

138 
	}
}

	@ide.c

1 
	~<x86.h
>

2 
	~<ide.h
>

3 
	~<sy¶ib.h
>

6 
	#SECTSIZE
 512

	)

8 
	gdiskno
 = 1;

11 
	$ide_waô_ªady
(
boﬁ
 
check_îr‹
)

13 
r
;

15 ((
r
 = 
	`öb
(0x1F7)Ë& (
IDE_BSY
|
IDE_DRDY
)) != IDE_DRDY)

18 i‡(
check_îr‹
 && (
r
 & (
IDE_DF
|
IDE_ERR
)) != 0)

21 
	}
}

23 
boﬁ


24 
	$ide_¥obe_disk1
()

26 
r
, 
x
;

29 
	`ide_waô_ªady
(0);

32 
	`outb
(0x1F6, 0xE0 | (1<<4));

35 
x
 = 0;

36 
x
 < 1000 && ((
r
 = 
	`öb
(0x1F7)Ë& (
IDE_BSY
|
IDE_DF
|
IDE_ERR
)) != 0;

37 
x
++)

41 
	`outb
(0x1F6, 0xE0 | (0<<4));

43 
	`˝rötf
("FS: Devi˚ 1Öª£n˚: %d\n", (
x
 < 1000));

44  (
x
 < 1000);

45 
	}
}

48 
	$ide_£t_disk
(
d
)

50 i‡(
d
 != 0 && d != 1)

51 
	`∑nic
("bad diskÇumber");

52 
diskno
 = 
d
;

53 
	}
}

57 
	$ide_ªad
(
uöt32_t
 
£˙o
, *
d°
, 
size_t
 
n£cs
)

59 
r
;

62 
	`ide_waô_ªady
(0);

64 
	`outb
(0x1F2, 
n£cs
);

65 
	`outb
(0x1F3, 
£˙o
 & 0xFF);

66 
	`outb
(0x1F4, (
£˙o
 >> 8) & 0xFF);

67 
	`outb
(0x1F5, (
£˙o
 >> 16) & 0xFF);

68 
	`outb
(0x1F6, 0xE0 | ((
diskno
&1)<<4Ë| ((
£˙o
>>24)&0x0F));

69 
	`outb
(0x1F7, 0x20);

71 ; 
n£cs
 > 0;Ç£cs--, 
d°
 +
SECTSIZE
) {

72 i‡((
r
 = 
	`ide_waô_ªady
(1)) < 0)

73  
r
;

74 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
/4);

78 
	}
}

81 
	$ide_wrôe
(
uöt32_t
 
£˙o
, c⁄° *
§c
, 
size_t
 
n£cs
)

83 
r
;

86 
	`ide_waô_ªady
(0);

88 
	`outb
(0x1F2, 
n£cs
);

89 
	`outb
(0x1F3, 
£˙o
 & 0xFF);

90 
	`outb
(0x1F4, (
£˙o
 >> 8) & 0xFF);

91 
	`outb
(0x1F5, (
£˙o
 >> 16) & 0xFF);

92 
	`outb
(0x1F6, 0xE0 | ((
diskno
&1)<<4Ë| ((
£˙o
>>24)&0x0F));

93 
	`outb
(0x1F7, 0x30);

95 ; 
n£cs
 > 0;Ç£cs--, 
§c
 +
SECTSIZE
) {

96 i‡((
r
 = 
	`ide_waô_ªady
(1)) < 0)

97  
r
;

98 
	`out¶
(0x1F0, 
§c
, 
SECTSIZE
/4);

102 
	}
}

	@ide.h

1 #i‚de‡
__IDE


2 
	#__IDE


	)

3 
	~<x86.h
>

5 
	#IDE_BSY
 0x80

	)

6 
	#IDE_DRDY
 0x40

	)

7 
	#IDE_DF
 0x20

	)

8 
	#IDE_ERR
 0x01

	)

11 
boﬁ
 
ide_¥obe_disk1
();

13 
ide_£t_disk
(
d
);

15 
ide_ªad
(
uöt32_t
 
£˙o
, *
d°
, 
size_t
 
n£cs
);

17 
ide_wrôe
(
uöt32_t
 
£˙o
, c⁄° *
§c
, 
size_t
 
n£cs
);

	@init.c

1 
	~<x86.h
>

2 
	~<utû.h
>

3 
	~<°rög.h
>

4 
	~<°dio.h
>

6 
	~<c⁄sﬁe.h
>

7 
	~<pm≠.h
>

8 
	~<m⁄ô‹.h
>

9 
	~<å≠.h
>

10 
	~<ív.h
>

11 
	~<picúq.h
>

12 
	~<sched.h
>

13 
	~<•ölock.h
>

17 
	$i386_öô
()

19 
ed©a
[], 
íd
[];

21 
	`mem£t
(
ed©a
, 0, 
íd
 -Édata);

23 
	`c⁄s_öô
();

25 
	`mem_öô
();

27 
	`ív_öô
();

28 
	`å≠_öô
();

30 
	`pic_öô
();

32 
	`ENV_CREATE
(
damnfs
, 
ENV_TYPE_FS
);

33 
	`ENV_CREATE
(
sh
, 
ENV_TYPE_USER
);

35 
	`sched_yõld
();

37 
	`hÆt
();

38 
	}
}

	@initsh.c

1 
	~<sy¶ib.h
>

4 
	mmsg1
[5000];

5 
	mmsg2
[1000];

6 } 
	gd©a
 = {

11 
	gbss
[6000];

14 
	$sum
(c⁄° *
s
, 
n
)

16 
i
, 
tŸ
 = 0;

17 
i
 = 0; i < 
n
; i++)

18 
tŸ
 ^
i
 * 
s
[i];

19  
tŸ
;

20 
	}
}

23 
	$umaö
(
¨gc
, **
¨gv
)

25 
i
, 
r
, 
x
, 
w™t
;

26 
¨gs
[256];

28 
	`˝rötf
("init:Ñunning\n");

30 
w™t
 = 0xf989e;

31 i‡((
x
 = 
	`sum
((*)&
d©a
,  d©a)Ë!
w™t
)

32 
	`˝rötf
("init: data isÇot initialized: got sum %08x wanted %08x\n",

33 
x
, 
w™t
);

35 
	`˝rötf
("init: data seems okay\n");

36 i‡((
x
 = 
	`sum
(
bss
,  bss)) != 0)

37 
	`˝rötf
("bs†i†nŸ inôülized: w™ãd sum 0 gŸ %08x\n", 
x
);

39 
	`˝rötf
("init: bss seems okay\n");

42 
	`°rˇt
(
¨gs
, "init:árgs:");

43 
i
 = 0; i < 
¨gc
; i++) {

44 
	`°rˇt
(
¨gs
, " '");

45 
	`°rˇt
(
¨gs
, 
¨gv
[
i
]);

46 
	`°rˇt
(
¨gs
, "'");

48 
	`˝rötf
("%s\n", 
¨gs
);

50 
	`˝rötf
("init:Ñunning sh\n");

53 
	`˛o£
(0);

54 i‡((
r
 = 
	`›íc⁄s
()) < 0)

55 
	`∑nic
("›íc⁄s: %e", 
r
);

56 i‡(
r
 != 0)

57 
	`∑nic
("fú° o≥nc⁄†u£d fd %d", 
r
);

58 i‡((
r
 = 
	`dup
(0, 1)) < 0)

59 
	`∑nic
("dup: %e", 
r
);

61 
	`˝rötf
("init: starting sh\n");

62 
r
 = 
	`•aw∆
("/sh", "sh", (*)0);

63 i‡(
r
 < 0) {

64 
	`˝rötf
("öô: s∑w¿sh: %e\n", 
r
);

67 
	`waô
(
r
);

69 
	}
}

	@ipc.c

3 
	~<sy¶ib.h
>

22 
öt32_t


23 
	$ùc_ªcv
(
ívid_t
 *
‰om_ív_°‹e
, *
pg
, *
≥rm_°‹e
)

26 
r
;

27 if(!
pg
)

28 
pg
 = (*)-1;

29 if((
r
 = 
	`sys_ùc_ªcv
(
pg
)) < 0)

31 if(
‰om_ív_°‹e
)

32 *
‰om_ív_°‹e
 = 0;

33 if(
≥rm_°‹e
)

34 *
≥rm_°‹e
 = 0;

36 if(
‰om_ív_°‹e
)

37 *
‰om_ív_°‹e
 = 
thi£nv
->
ív_ùc_‰om
;

38 if(
≥rm_°‹e
)

39 *
≥rm_°‹e
 = 
thi£nv
->
ív_ùc_≥rm
;

40  
thi£nv
->
ív_ùc_vÆue
;

41 
	}
}

52 
	$ùc_£nd
(
ívid_t
 
to_ív
, 
uöt32_t
 
vÆ
, *
pg
, 
≥rm
)

55 
r
;

56 if(!
pg
)

57 
pg
 = (*)-1;

58 (
r
 = 
	`sys_ùc_åy_£nd
(
to_ív
, 
vÆ
, 
pg
, 
≥rm
)))

60 if(
r
 == 0)

62 if(
r
 !-
E_IPC_NOT_RECV
)

63 
	`∑nic
("ùc_£nd : %e", 
r
);

64 
	`sys_yõld
();

66 
	}
}

71 
ívid_t


72 
	$ùc_föd_ív
(
EnvTy≥
 
ty≥
)

74 
i
;

75 
i
 = 0; i < 
NENV
; i++)

76 i‡(
ívs
[
i
].
ív_ty≥
 =
ty≥
)

77  
ívs
[
i
].
ív_id
;

79 
	}
}

	@libmain.c

4 
	~<sy¶ib.h
>

6 
umaö
(
¨gc
, **
¨gv
);

8 c⁄° vﬁ©ûê
Env
 *
	gthi£nv
;

9 c⁄° *
	gbö¨y«me
 = "<unknown>";

12 
	$libmaö
(
¨gc
, **
¨gv
)

15 
thi£nv
 = &
ívs
[
	`ENVX
(
	`sys_gëívid
())];

18 i‡(
¨gc
 > 0)

19 
bö¨y«me
 = 
¨gv
[0];

22 
	`umaö
(
¨gc
, 
¨gv
);

25 
	`exô
();

26 
	}
}

	@main.c

1 
	~<x86.h
>

2 
	~<boŸutû.h
>

3 
	~<ñf.h
>

5 
	#ELFHDR
 ((
Elf
 *) 0x10000)

6 

	)

7 
	#SECTSIZE
 512

	)

9 
ªad£˘
(*, 
uöt32_t
);

10 
ªad£g
(
uöt32_t
, uint32_t, uint32_t);

13 
	$boŸmaö
()

15 
Proghdr
 *
ph
, *
ïh
;

18 
	`ªad£g
((
uöt32_t
Ë
ELFHDR
, 
SECTSIZE
*8, 0);

21 i‡(
ELFHDR
->
e_magic
 !
ELF_MAGIC
)

22 
bad
;

25 
ph
 = (
Proghdr
 *Ë((
uöt8_t
 *Ë
ELFHDR
 + ELFHDR->
e_phoff
);

26 
ïh
 = 
ph
 + 
ELFHDR
->
e_phnum
;

27 ; 
ph
 < 
ïh
;Öh++)

30 
	`ªad£g
(
ph
->
p_∑
,Öh->
p_memsz
,Öh->
p_off£t
);

34 (((*)()Ë(
ELFHDR
->
e_íåy
))();

36 
bad
:

37 
	`outw
(0x8A00, 0x8A00);

38 
	`outw
(0x8A00, 0x8E00);

41 
	}
}

47 
	$ªad£g
(
uöt32_t
 
∑
, uöt32_à
cou¡
, uöt32_à
off£t
)

49 
uöt32_t
 
íd_∑
;

51 
íd_∑
 = 
∑
 + 
cou¡
;

54 
∑
 &~(
SECTSIZE
 - 1);

57 
off£t
 = (off£à/ 
SECTSIZE
) + 1;

62 
∑
 < 
íd_∑
) {

67 
	`ªad£˘
((
uöt8_t
*Ë
∑
, 
off£t
);

68 
∑
 +
SECTSIZE
;

69 
off£t
++;

71 
	}
}

74 
	$waôdisk
()

77 (
	`öb
(0x1F7) & 0xC0) != 0x40)

79 
	}
}

83 
	$ªad£˘
(*
d°
, 
uöt32_t
 
off£t
)

86 
	`waôdisk
();

88 
	`outb
(0x1F2, 1);

89 
	`outb
(0x1F3, 
off£t
);

90 
	`outb
(0x1F4, 
off£t
 >> 8);

91 
	`outb
(0x1F5, 
off£t
 >> 16);

92 
	`outb
(0x1F6, (
off£t
 >> 24) | 0xE0);

93 
	`outb
(0x1F7, 0x20);

96 
	`waôdisk
();

99 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
/4);

100 
	}
}

	@monitor.c

1 
	~<x86.h
>

2 
	~<utû.h
>

3 
	~<c⁄sﬁe.h
>

4 
	~<å≠.h
>

5 
	~<°dio.h
>

6 
	~<°rög.h
>

7 
	~<m⁄ô‹.h
>

9 
	#CMDBUF_SIZE
 80

10 

	)

12 
	sComm™d
 {

13 c⁄° *
	m«me
;

14 c⁄° *
	mdesc
;

16 (*
	mfunc
)(
	m¨gc
, ** 
	m¨gv
, 
Tøp‰ame
* 
	mtf
);

19 
Comm™d
 
	gcomm™ds
[] = {

20 { "hñp", "Di•œyÅhi†li° o‡comm™ds", 
m⁄_hñp
 },

21 { "kînöfo", "Di•œy inf‹m©i⁄ábouàthêkî√l", 
m⁄_kînöfo
 },

23 
	#NCOMMANDS
 ((
comm™ds
)/(comm™ds[0]))

	)

28 
	$m⁄_hñp
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

30 
i
;

32 
i
 = 0; i < 
NCOMMANDS
; i++)

33 
	`˝rötf
("%†- %s\n", 
comm™ds
[
i
].
«me
, comm™ds[i].
desc
);

35 
	}
}

38 
	$m⁄_kînöfo
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

40 
_°¨t
[], 
íåy
[], 
ëext
[], 
ed©a
[], 
íd
[];

42 
	`˝rötf
("Special kernel symbols:\n");

43 
	`˝rötf
(" _°¨à %08x (phys)\n", 
_°¨t
);

44 
	`˝rötf
("É¡ry %08x (vútË %08x (phys)\n", 
íåy
,É¡ry - 
KERNBASE
);

45 
	`˝rötf
("Éãxà %08x (vútË %08x (phys)\n", 
ëext
,Éãxà- 
KERNBASE
);

46 
	`˝rötf
("Éd©® %08x (vútË %08x (phys)\n", 
ed©a
,Éd©®- 
KERNBASE
);

47 
	`˝rötf
("Énd %08x (vútË %08x (phys)\n", 
íd
,Énd - 
KERNBASE
);

48 
	`˝rötf
("KernelÉxecutable memory footprint: %dKB\n",

49 
	`ROUNDUP
(
íd
 - 
íåy
, 1024) / 1024);

51 
	}
}

57 
	#WHITESPACE
 "\t\r\¿"

	)

58 
	#MAXARGS
 16

	)

61 
	$runcmd
(*
buf
, 
Tøp‰ame
 *
tf
)

63 
¨gc
;

64 *
¨gv
[
MAXARGS
];

65 
i
;

68 
¨gc
 = 0;

69 
¨gv
[
¨gc
] = 0;

72 *
buf
 && 
	`°rchr
(
WHITESPACE
, *buf))

73 *
buf
++ = 0;

74 i‡(*
buf
 == 0)

78 i‡(
¨gc
 =
MAXARGS
-1) {

79 
	`˝rötf
("Toÿm™yárgumít†(max %d)\n", 
MAXARGS
);

82 
¨gv
[
¨gc
++] = 
buf
;

83 *
buf
 && !
	`°rchr
(
WHITESPACE
, *buf))

84 
buf
++;

86 
¨gv
[
¨gc
] = 0;

89 i‡(
¨gc
 == 0)

91 
i
 = 0; i < 
NCOMMANDS
; i++) {

92 i‡(
	`°rcmp
(
¨gv
[0], 
comm™ds
[
i
].
«me
) == 0)

93  
comm™ds
[
i
].
	`func
(
¨gc
, 
¨gv
, 
tf
);

95 
	`˝rötf
("Unknow¿comm™d '%s'\n", 
¨gv
[0]);

97 
	}
}

100 
	$m⁄ô‹
(
Tøp‰ame
 *
tf
)

102 *
buf
;

104 
	`˝rötf
("WelcomeÅoÅhe DamnOS Kernel Monitor!\n");

105 
	`˝rötf
("Type 'help' foráÜist of commands.\n");

111 
buf
 = 
	`ªadlöe
("D> ");

112 i‡(
buf
 !
NULL
)

113 i‡(
	`runcmd
(
buf
, 
tf
) < 0)

116 
	}
}

	@monitor.h

1 #i‚de‡
MONITOR


2 
	#MONITOR


	)

4 
	gTøp‰ame
;

9 
m⁄ô‹
(
Tøp‰ame
 *
tf
);

12 
m⁄_hñp
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

13 
m⁄_kînöfo
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

	@pageref.c

1 
	~<sy¶ib.h
>

4 
	$∑gîef
(*
v
)

6 
±e_t
 
±e
;

8 i‡(!(
uvpd
[
	`PDX
(
v
)] & 
PTE_P
))

10 
±e
 = 
uv±
[
	`PGNUM
(
v
)];

12 i‡(!(
±e
 & 
PTE_P
))

15  
∑ges
[
	`PGNUM
(
±e
)].
µ_ªf
;

16 
	}
}

	@pgfault.c

7 
	~<sy¶ib.h
>

10 
_pgÁu…_upˇŒ
();

13 (*
_pgÁu…_h™dÀr
)(
UTøp‰ame
 *
utf
);

24 
	$£t_pgÁu…_h™dÀr
((*
h™dÀr
)(
UTøp‰ame
 *
utf
))

26 
r
;

28 i‡(
_pgÁu…_h™dÀr
 == 0) {

30 if((
r
 = 
	`sys_∑ge_Æloc
(0, (*)(
UXSTACKTOP
 - 
PGSIZE
), 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

31 
	`∑nic
("£t_pgÁu…_h™dÀ∏: %e", 
r
);

32 if((
r
 = 
	`sys_ív_£t_pgÁu…_upˇŒ
(0, 
_pgÁu…_upˇŒ
)) < 0)

33 
	`∑nic
("£t_pgÁu…_h™dÀ∏: %e", 
r
);

37 
_pgÁu…_h™dÀr
 = 
h™dÀr
;

38 
	}
}

	@picirq.c

1 
	~<å≠.h
>

2 
	~<°dio.h
>

3 
	~<picúq.h
>

8 
uöt16_t
 
	gúq_mask_8259A
 = 0xFFFF & ~((1<<
IRQ_SLAVE
Ë| (1<<
IRQ_TIMER
Ë| (1<<
IRQ_SERIAL
Ë| (1 << 
IRQ_KBD
)) ;

9 
boﬁ
 
	gdidöô
;

13 
	$pic_öô
()

15 
didöô
 = 1;

18 
	`outb
(
IO_PIC1
+1, 0xFF);

19 
	`outb
(
IO_PIC2
+1, 0xFF);

27 
	`outb
(
IO_PIC1
, 0x11);

30 
	`outb
(
IO_PIC1
+1, 
IRQ_OFFSET
);

34 
	`outb
(
IO_PIC1
+1, 1<<
IRQ_SLAVE
);

44 
	`outb
(
IO_PIC1
+1, 0x3);

47 
	`outb
(
IO_PIC2
, 0x11);

48 
	`outb
(
IO_PIC2
+1, 
IRQ_OFFSET
 + 8);

49 
	`outb
(
IO_PIC2
+1, 
IRQ_SLAVE
);

52 
	`outb
(
IO_PIC2
+1, 0x01);

58 
	`outb
(
IO_PIC1
, 0x68);

59 
	`outb
(
IO_PIC1
, 0x0a);

61 
	`outb
(
IO_PIC2
, 0x68);

62 
	`outb
(
IO_PIC2
, 0x0a);

64 i‡(
úq_mask_8259A
 != 0xFFFF)

65 
	`úq_£tmask_8259A
(
úq_mask_8259A
);

66 
	}
}

69 
	$úq_£tmask_8259A
(
uöt16_t
 
mask
)

71 
i
;

72 
úq_mask_8259A
 = 
mask
;

73 i‡(!
didöô
)

75 
	`outb
(
IO_PIC1
+1, ()
mask
);

76 
	`outb
(
IO_PIC2
+1, ()(
mask
 >> 8));

77 
	`˝rötf
("enabled interrupts:");

78 
i
 = 0; i < 16; i++)

79 i‡(~
mask
 & (1<<
i
))

80 
	`˝rötf
(" %d", 
i
);

81 
	`˝rötf
("\n");

82 
	}
}

	@picirq.h

3 #i‚de‡
__PICIRQ


4 
	#__PICIRQ


	)

6 
	#MAX_IRQS
 16

7 

	)

9 
	#IO_PIC1
 0x20

10 
	#IO_PIC2
 0xA0

11 

	)

12 
	#IRQ_SLAVE
 2

13 

	)

15 #i‚de‡
__ASSEMBLER__


17 
	~<x86.h
>

19 
uöt16_t
 
úq_mask_8259A
;

20 
pic_öô
();

21 
úq_£tmask_8259A
(
uöt16_t
 
mask
);

	@pipe.c

1 
	~<sy¶ib.h
>

3 
	#debug
 0

	)

5 
ssize_t
 
devpùe_ªad
(
Fd
 *
fd
, *
buf
, 
size_t
 
n
);

6 
ssize_t
 
devpùe_wrôe
(
Fd
 *
fd
, c⁄° *
buf
, 
size_t
 
n
);

7 
devpùe_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
);

8 
devpùe_˛o£
(
Fd
 *
fd
);

10 
Dev
 
	gdevpùe
 =

12 .
dev_id
 = 'p',

13 .
	gdev_«me
 = "pipe",

14 .
	gdev_ªad
 = 
devpùe_ªad
,

15 .
	gdev_wrôe
 = 
devpùe_wrôe
,

16 .
	gdev_˛o£
 = 
devpùe_˛o£
,

17 .
	gdev_°©
 = 
devpùe_°©
,

20 
	#PIPEBUFSIZ
 32

21 

	)

22 
	sPùe
 {

23 
off_t
 
	mp_Ωos
;

24 
off_t
 
	mp_wpos
;

25 
uöt8_t
 
	mp_buf
[
PIPEBUFSIZ
];

29 
	$pùe
(
pfd
[2])

31 
r
;

32 
Fd
 *
fd0
, *
fd1
;

33 *
va
;

36 i‡((
r
 = 
	`fd_Æloc
(&
fd0
)) < 0

37 || (
r
 = 
	`sys_∑ge_Æloc
(0, 
fd0
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

38 
îr
;

40 i‡((
r
 = 
	`fd_Æloc
(&
fd1
)) < 0

41 || (
r
 = 
	`sys_∑ge_Æloc
(0, 
fd1
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

42 
îr1
;

45 
va
 = 
	`fd2d©a
(
fd0
);

46 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
va
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

47 
îr2
;

48 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
va
, 0, 
	`fd2d©a
(
fd1
), 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

49 
îr3
;

52 
fd0
->
fd_dev_id
 = 
devpùe
.
dev_id
;

53 
fd0
->
fd_omode
 = 
O_RDONLY
;

55 
fd1
->
fd_dev_id
 = 
devpùe
.
dev_id
;

56 
fd1
->
fd_omode
 = 
O_WRONLY
;

58 i‡(
debug
)

59 
	`˝rötf
("[%08x]Öùe¸óã %08x\n", 
thi£nv
->
ív_id
, 
uv±
[
	`PGNUM
(
va
)]);

61 
pfd
[0] = 
	`fd2num
(
fd0
);

62 
pfd
[1] = 
	`fd2num
(
fd1
);

65 
îr3
:

66 
	`sys_∑ge_unm≠
(0, 
va
);

67 
îr2
:

68 
	`sys_∑ge_unm≠
(0, 
fd1
);

69 
îr1
:

70 
	`sys_∑ge_unm≠
(0, 
fd0
);

71 
îr
:

72  
r
;

73 
	}
}

76 
	$_pùeis˛o£d
(
Fd
 *
fd
, 
Pùe
 *
p
)

78 
n
, 
¬
, 
ªt
;

81 
n
 = 
thi£nv
->
ív_runs
;

82 
ªt
 = 
	`∑gîef
(
fd
Ë=∑gîef(
p
);

83 
¬
 = 
thi£nv
->
ív_runs
;

84 i‡(
n
 =
¬
)

85  
ªt
;

86 i‡(
n
 !
¬
 && 
ªt
 == 1)

87 
	`˝rötf
("pùêø˚ávoided\n", 
n
, 
thi£nv
->
ív_runs
, 
ªt
);

89 
	}
}

92 
	$pùeis˛o£d
(
fdnum
)

94 
Fd
 *
fd
;

95 
Pùe
 *
p
;

96 
r
;

98 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

99  
r
;

100 
p
 = (
Pùe
*Ë
	`fd2d©a
(
fd
);

101  
	`_pùeis˛o£d
(
fd
, 
p
);

102 
	}
}

104 
ssize_t


105 
	$devpùe_ªad
(
Fd
 *
fd
, *
vbuf
, 
size_t
 
n
)

107 
uöt8_t
 *
buf
;

108 
size_t
 
i
;

109 
Pùe
 *
p
;

111 
p
 = (
Pùe
*)
	`fd2d©a
(
fd
);

112 i‡(
debug
)

113 
	`˝rötf
("[%08x] devpipe_read %08x %dÑpos %d wpos %d\n",

114 
thi£nv
->
ív_id
, 
uv±
[
	`PGNUM
(
p
)], 
n
,Ö->
p_Ωos
,Ö->
p_wpos
);

116 
buf
 = 
vbuf
;

117 
i
 = 0; i < 
n
; i++) {

118 
p
->
p_Ωos
 =p->
p_wpos
) {

121 i‡(
i
 > 0)

122  
i
;

124 i‡(
	`_pùeis˛o£d
(
fd
, 
p
))

127 i‡(
debug
)

128 
	`˝rötf
("devpipe_read yield\n");

129 
	`sys_yõld
();

133 
buf
[
i
] = 
p
->
p_buf
[p->
p_Ωos
 % 
PIPEBUFSIZ
];

134 
p
->
p_Ωos
++;

136  
i
;

137 
	}
}

139 
ssize_t


140 
	$devpùe_wrôe
(
Fd
 *
fd
, c⁄° *
vbuf
, 
size_t
 
n
)

142 c⁄° 
uöt8_t
 *
buf
;

143 
size_t
 
i
;

144 
Pùe
 *
p
;

146 
p
 = (
Pùe
*Ë
	`fd2d©a
(
fd
);

147 i‡(
debug
)

148 
	`˝rötf
("[%08x] devpipe_write %08x %dÑpos %d wpos %d\n",

149 
thi£nv
->
ív_id
, 
uv±
[
	`PGNUM
(
p
)], 
n
,Ö->
p_Ωos
,Ö->
p_wpos
);

151 
buf
 = 
vbuf
;

152 
i
 = 0; i < 
n
; i++) {

153 
p
->
p_wpos
 >p->
p_Ωos
 + ’->
p_buf
)) {

158 i‡(
	`_pùeis˛o£d
(
fd
, 
p
))

161 i‡(
debug
)

162 
	`˝rötf
("devpipe_write yield\n");

163 
	`sys_yõld
();

167 
p
->
p_buf
[p->
p_wpos
 % 
PIPEBUFSIZ
] = 
buf
[
i
];

168 
p
->
p_wpos
++;

171  
i
;

172 
	}
}

175 
	$devpùe_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
)

177 
Pùe
 *
p
 = (Pùe*Ë
	`fd2d©a
(
fd
);

178 
	`°r˝y
(
°©
->
°_«me
, "<pipe>");

179 
°©
->
°_size
 = 
p
->
p_wpos
 -Ö->
p_Ωos
;

180 
°©
->
°_isdú
 = 0;

181 
°©
->
°_dev
 = &
devpùe
;

183 
	}
}

186 
	$devpùe_˛o£
(
Fd
 *
fd
)

188 (Ë
	`sys_∑ge_unm≠
(0, 
fd
);

189  
	`sys_∑ge_unm≠
(0, 
	`fd2d©a
(
fd
));

190 
	}
}

	@pmap.c

1 
	~<pm≠.h
>

2 
	~<°rög.h
>

3 
	~<c⁄sﬁe.h
>

4 
	~<°dio.h
>

5 
	~<ív.h
>

8 
	$mc146818_ªad
(
ªg
)

10 
	`outb
(
IO_RTC
, 
ªg
);

11  
	`öb
(
IO_RTC
+1);

12 
	}
}

15 
size_t
 
	g≈ages
;

16 
size_t
 
	g≈ages_ba£mem
;

19 
pde_t
 *
	gkîn_pgdú
;

20 
PageInfo
 *
	g∑ges
;

21 
PageInfo
 *
	g∑ge_‰ì_li°
;

29 
	$nvøm_ªad
(
r
)

31  
	`mc146818_ªad
(
r
) | (mc146818_read(r + 1) << 8);

32 
	}
}

35 
	$i386_dëe˘_mem‹y
()

37 
size_t
 
≈ages_extmem
;

41 
≈ages_ba£mem
 = (
	`nvøm_ªad
(
NVRAM_BASELO
Ë* 1024Ë/ 
PGSIZE
;

42 
≈ages_extmem
 = (
	`nvøm_ªad
(
NVRAM_EXTLO
Ë* 1024Ë/ 
PGSIZE
;

46 i‡(
≈ages_extmem
)

47 
≈ages
 = (
EXTPHYSMEM
 / 
PGSIZE
Ë+ 
≈ages_extmem
;

49 
≈ages
 = 
≈ages_ba£mem
;

51 
	`˝rötf
("Mem‹y: %dK\n", 
≈ages
*4);

52 
	}
}

58 
boŸ_m≠_ªgi⁄
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
, 
size_t
 
size
, 
phyßddr_t
 
∑
, 
≥rm
);

74 
	$boŸ_Æloc
(
uöt32_t
 
n
)

76 *
√xt‰ì
;

77 *
ªsu…
;

84 i‡(!
√xt‰ì
) {

85 
íd
[];

86 
√xt‰ì
 = (*)
	`ROUNDUP
((*Ë
íd
, 
PGSIZE
);

92 
ªsu…
 = 
√xt‰ì
;

93 if(
n
 != 0)

94 
√xt‰ì
 = 
	`ROUNDUP
“ext‰ì + 
n
, 
PGSIZE
);

95  (*)
ªsu…
;

96 
	}
}

108 
	$mem_öô
()

110 
uöt32_t
 
¸0
;

113 
	`i386_dëe˘_mem‹y
();

118 
kîn_pgdú
 = (
pde_t
 *Ë
	`boŸ_Æloc
(
PGSIZE
);

119 
	`mem£t
(
kîn_pgdú
, 0, 
PGSIZE
);

128 
kîn_pgdú
[
	`PDX
(
UVPT
)] = 
	`PADDR
(kîn_pgdúË| 
PTE_U
 | 
PTE_P
;

137 
∑ges
 = (
PageInfo
 *Ë
	`boŸ_Æloc
(
≈ages
 * (PageInfo));

138 
	`mem£t
(
∑ges
, 0, 
≈ages
 * (
PageInfo
));

142 
ívs
 = (
Env
 *)
	`boŸ_Æloc
(
NENV
 * (Env));

150 
	`∑ge_öô
();

161 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
UPAGES
, 
	`ROUNDUP
(
≈ages
 * (
PageInfo
), 
PGSIZE
), 
	`PADDR
(
∑ges
), 
PTE_U
 | 
PTE_P
);

168 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
UENVS
, 
PTSIZE
, 
	`PADDR
(
ívs
), 
PTE_U
 | 
PTE_P
);

179 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
KSTACKTOP
-
KSTKSIZE
, KSTKSIZE, 
	`PADDR
(
boŸ°ack
), 
PTE_W
 | 
PTE_P
);

187 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
KERNBASE
, (0xFFFFFFFF - KERNBASE), 0, 
PTE_W
 | 
PTE_P
);

197 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

201 
¸0
 = 
	`r¸0
();

202 
¸0
 |
CR0_PE
|
CR0_PG
|
CR0_AM
|
CR0_WP
|
CR0_NE
|
CR0_MP
;

203 
¸0
 &~(
CR0_TS
|
CR0_EM
);

204 
	`l¸0
(
¸0
);

206 
	}
}

221 
	$∑ge_öô
()

223 
size_t
 
i
;

224 
phyßddr_t
 
∑
;

225 
i
 = 
≈ages
-1; i > 0; i--) {

226 i‡(
i
==0 ||

227 
i
 =
	`PGNUM
(
≈ages_ba£mem
)) {

228 
∑ges
[
i
].
µ_ªf
 = 1;

229 
∑ges
[
i
].
µ_lök
 = 
NULL
;

230 } i‡(
i
<
≈ages_ba£mem
) {

231 
∑ges
[
i
].
µ_ªf
 = 0;

232 
∑ges
[
i
].
µ_lök
 = 
∑ge_‰ì_li°
;

233 
∑ge_‰ì_li°
 = &
∑ges
[
i
];

234 } i‡((
i
<=(
EXTPHYSMEM
 / 
PGSIZE
))

235 || (
i
<(((
uöt32_t
)
	`boŸ_Æloc
(0Ë- 
KERNBASE
)>>
PGSHIFT
))){

236 
∑ges
[
i
].
µ_ªf
++;

237 
∑ges
[
i
].
µ_lök
 = 
NULL
;

239 
∑ges
[
i
].
µ_ªf
 = 0;

240 
∑ges
[
i
].
µ_lök
 = 
∑ge_‰ì_li°
;

241 
∑ge_‰ì_li°
 = &
∑ges
[
i
];

244 
∑
 = 
	`∑ge2∑
(&
∑ges
[
i
]);

246 i‡((
∑
 =0 ||Ö®=
IOPHYSMEM
)

247 && (
∑ges
[
i
].
µ_ªf
==0))

248 
	`˝rötf
("∑gêîr‹: i %d\n", 
i
);

250 
	}
}

258 
PageInfo
 *

259 
	$∑ge_Æloc
(
Æloc_Êags
)

261 if(!
∑ge_‰ì_li°
)

262  
NULL
;

264 
PageInfo
 * 
ãmp
 = 
∑ge_‰ì_li°
;

265 
∑ge_‰ì_li°
 =Öage_‰ì_li°->
µ_lök
;

266 
ãmp
->
µ_lök
 = 
NULL
;

268 if(
Æloc_Êags
 & 
ALLOC_ZERO
)

269 
	`mem£t
(
	`∑ge2kva
(
ãmp
), 0, 
PGSIZE
);

271  
ãmp
;

272 
	}
}

279 
	$∑ge_‰ì
(
PageInfo
 *
µ
)

281 if(
µ
->
µ_ªf
)

282 
	`∑nic
("page_free :Öp->pp_ref isÇonzero!");

283 if(
µ
->
µ_lök
)

284 
	`∑nic
("page_free :Öp->pp_link isÇot NULL!");

285 
µ
->
µ_lök
 = 
∑ge_‰ì_li°
;

286 
∑ge_‰ì_li°
 = 
µ
;

287 
	}
}

294 
	$∑ge_de¸ef
(
PageInfo
* 
µ
)

296 i‡(--
µ
->
µ_ªf
 == 0)

297 
	`∑ge_‰ì
(
µ
);

298 
	}
}

312 
±e_t
 *

313 
	$pgdú_wÆk
(
pde_t
 *
pgdú
, c⁄° *
va
, 
¸óã
)

315 
±e_t
 * 
∑ge_èbÀ
 = (±e_à*)
	`KADDR
(
	`PTE_ADDR
(
pgdú
[
	`PDX
(
va
)]));

317 if(!
pgdú
[
	`PDX
(
va
)])

319 if(!
¸óã
)

320  
NULL
;

323 
PageInfo
 * 
√w_∑ge_èbÀ_∑ge
 = 
	`∑ge_Æloc
(1);

325 if(!
√w_∑ge_èbÀ_∑ge
)

326  
NULL
;

328 
√w_∑ge_èbÀ_∑ge
->
µ_ªf
++;

330 
pgdú
[
	`PDX
(
va
)] |(
	`∑ge2∑
(
√w_∑ge_èbÀ_∑ge
) & (~0xFFF));

331 
pgdú
[
	`PDX
(
va
)] =Ögdú[PDX(va)] | 
PTE_P
 | 
PTE_W
 | 
PTE_U
;

333 
∑ge_èbÀ
 = (
±e_t
 *)
	`KADDR
(
	`PTE_ADDR
(
pgdú
[
	`PDX
(
va
)]));

336  &
∑ge_èbÀ
[
	`PTX
(
va
)];

337 
	}
}

350 
	$boŸ_m≠_ªgi⁄
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
, 
size_t
 
size
, 
phyßddr_t
 
∑
, 
≥rm
)

353 
size_t
 
i
;

354 
i
 = 0; i < 
size
; i +
PGSIZE
)

356 
±e_t
 * 
ãmp_±e
 = 
	`pgdú_wÆk
(
pgdú
, (*)(
va
 + 
i
), 1);

357 *
ãmp_±e
 = 
	`PTE_ADDR
(
∑
 + 
i
Ë| 
≥rm
 | 
PTE_P
;

359 
	}
}

384 
	$∑ge_ö£π
(
pde_t
 *
pgdú
, 
PageInfo
 *
µ
, *
va
, 
≥rm
)

386 
±e_t
 * 
ãmp_±e
 = 
	`pgdú_wÆk
(
pgdú
, 
va
, 1);

388 if(!
ãmp_±e
)

389  -
E_NO_MEM
;

391 
µ
->
µ_ªf
++;

392 if(
	`PTE_ADDR
(*
ãmp_±e
))

394 
	`∑ge_ªmove
(
pgdú
, 
va
);

395 
	`éb_övÆid©e
(
pgdú
, 
va
);

398 *
ãmp_±e
 = 
	`∑ge2∑
(
µ
)|
≥rm
|
PTE_P
;

401 
	}
}

412 
PageInfo
 *

413 
	$∑ge_lookup
(
pde_t
 *
pgdú
, *
va
, 
±e_t
 **
±e_°‹e
)

415 
±e_t
 * 
±e
 = 
	`pgdú_wÆk
(
pgdú
, 
va
, 0);

416 i‡(!
±e
)

417  
NULL
;

418 i‡(
±e_°‹e
)

419 *
±e_°‹e
 = 
±e
;

420  
	`∑2∑ge
(
	`PTE_ADDR
(*
±e
));

421 
	}
}

437 
	$∑ge_ªmove
(
pde_t
 *
pgdú
, *
va
)

439 
±e_t
 * 
±e
 = 
NULL
;

440 
PageInfo
 * 
µ
 = 
	`∑ge_lookup
(
pgdú
, 
va
, &
±e
);

441 i‡(!
µ
)

443 
	`∑ge_de¸ef
(
µ
);

444 i‡(
±e
)

445 *
±e
 = 0;

446 
	`éb_övÆid©e
(
pgdú
, 
va
);

447 
	}
}

454 
	$éb_övÆid©e
(
pde_t
 *
pgdú
, *
va
)

457 i‡(!
cuªnv
 || cuªnv->
ív_pgdú
 =
pgdú
)

458 
	`övÕg
(
va
);

459 
	}
}

467 
	$mmio_m≠_ªgi⁄
(
phyßddr_t
 
∑
, 
size_t
 
size
)

473 
uöçå_t
 
ba£
 = 
MMIOBASE
;

493 
size_t
 
rounded_size
 = 
	`ROUNDUP
(
size
, 
PGSIZE
);

494 if(
ba£
 + 
rounded_size
 > 
MMIOLIM
)

495 
	`∑nic
("overflow MMIOLIM");

496 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
ba£
, 
rounded_size
, 
∑
, 
PTE_PCD
 | 
PTE_PWT
 | 
PTE_W
);

497 
ba£
 +
rounded_size
;

498  (*)(
ba£
 - 
rounded_size
);

501 
	}
}

	@pmap.h

1 #i‚de‡
__PMAP


2 
	#__PMAP


	)

4 
	~<x86.h
>

5 
	~<utû.h
>

6 
	~<îr‹.h
>

10 
	sPageInfo
 {

12 
PageInfo
 *
	mµ_lök
;

19 
uöt16_t
 
	mµ_ªf
;

22 #i‚de‡
__FOR_USER__


24 
boŸ°ackt›
[], 
boŸ°ack
[];

25 
PageInfo
 *
∑ges
;

26 
size_t
 
≈ages
;

28 
pde_t
 *
kîn_pgdú
;

36 
	#PADDR
(
kva
Ë
	`_∑ddr
(kva)

	)

38 
ölöe
 
phyßddr_t


39 
	$_∑ddr
(*
kva
)

41  (
phyßddr_t
)
kva
 - 
KERNBASE
;

42 
	}
}

46 
	#KADDR
(
∑
Ë
	`_kaddr
’a)

	)

48 
ölöe
 *

49 
	$_kaddr
(
phyßddr_t
 
∑
)

51  (*)(
∑
 + 
KERNBASE
);

52 
	}
}

57 
	mALLOC_ZERO
 = 1<<0,

60 
mem_öô
();

62 
∑ge_öô
();

63 
PageInfo
 *
∑ge_Æloc
(
Æloc_Êags
);

64 
∑ge_‰ì
(
PageInfo
 *
µ
);

65 
∑ge_ö£π
(
pde_t
 *
pgdú
, 
PageInfo
 *
µ
, *
va
, 
≥rm
);

66 
∑ge_ªmove
(
pde_t
 *
pgdú
, *
va
);

67 
PageInfo
 *
∑ge_lookup
(
pde_t
 *
pgdú
, *
va
, 
±e_t
 **
±e_°‹e
);

68 
∑ge_de¸ef
(
PageInfo
 *
µ
);

70 
éb_övÆid©e
(
pde_t
 *
pgdú
, *
va
);

72 * 
mmio_m≠_ªgi⁄
(
phyßddr_t
 
∑
, 
size_t
 
size
);

75 
ölöe
 
phyßddr_t


76 
	$∑ge2∑
(
PageInfo
 *
µ
)

78  (
µ
 - 
∑ges
Ë<< 
PGSHIFT
;

79 
	}
}

81 
ölöe
 
PageInfo
*

82 
	$∑2∑ge
(
phyßddr_t
 
∑
)

84  &
∑ges
[
	`PGNUM
(
∑
)];

85 
	}
}

87 
ölöe
 *

88 
	$∑ge2kva
(
PageInfo
 *
µ
)

90  
	`KADDR
(
	`∑ge2∑
(
µ
));

91 
	}
}

93 
±e_t
 *
pgdú_wÆk
(
pde_t
 *
pgdú
, c⁄° *
va
, 
¸óã
);

	@sched.c

1 
	~<x86.h
>

2 
	~<°dio.h
>

3 
	~<ív.h
>

4 
	~<pm≠.h
>

5 
	~<m⁄ô‹.h
>

7 
sched_hÆt
();

11 
	$sched_yõld
()

28 
cuªnv_id
, 
i
;

29 if(
cuªnv
)

30 
cuªnv_id
 = 
	`ENVX
(
cuªnv
->
ív_id
);

32 
cuªnv_id
 = 0;

33 
i
 = 0; i < 
NENV
; ++i)

35 
j
 = (
cuªnv_id
 + 
i
Ë% 
NENV
;

36 if(
ívs
[
j
].
ív_°©us
 =
ENV_RUNNABLE
)

37 
	`ív_run
(
ívs
 + 
j
);

39 if(
cuªnv
 && cuªnv->
ív_°©us
 =
ENV_RUNNING
)

40 
	`ív_run
(
cuªnv
);

43 
	`sched_hÆt
();

44 
	}
}

50 
	$sched_hÆt
()

52 
i
;

56 
i
 = 0; i < 
NENV
; i++) {

57 i‡((
ívs
[
i
].
ív_°©us
 =
ENV_RUNNABLE
 ||

58 
ívs
[
i
].
ív_°©us
 =
ENV_RUNNING
 ||

59 
ívs
[
i
].
ív_°©us
 =
ENV_DYING
))

63 i‡(
i
 =
NENV
) {

64 
	`˝rötf
("NoÑunnableÉnvironments inÅhe system!\n");

66 
	`m⁄ô‹
(
NULL
);

70 
cuªnv
 = 
NULL
;

71 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

77 
asm
 volatile (

86 : : "a" (
KSTACKTOP
));

87 
	}
}

	@sched.h

1 #i‚de‡
__SCHED


2 
	#__SCHED


	)

4 
	$sched_yõld
(Ë
	`__©åibuã__
((
n‹ëu∫
));

	@serv.c

6 
	~<x86.h
>

7 
	~<°rög.h
>

9 
	~<damnfs.h
>

10 
	~<sy¶ib.h
>

13 
	#debug
 0

	)

33 
DamnInode
 * 
öodes
;

34 
DúE¡ry
 
	gπ_íåy
 = {{'/', '\0'}, 0};

37 
	sO≥nFûe
 {

38 
uöt32_t
 
	mo_fûeid
;

39 
DúE¡ry
 *
	mo_fûe
;

40 
	mo_mode
;

41 
Fd
 *
	mo_fd
;

45 
	#MAXOPEN
 1024

	)

46 
	#FILEVA
 0xD0000000

	)

49 
O≥nFûe
 
	g›íèb
[
MAXOPEN
] = {

54 
Fsùc
 *
	gf§eq
 = (Fsipc *)0x0ffff000;

58 
	$£rve_öô
()

60 
i
;

61 
uöçå_t
 
va
 = 
FILEVA
;

62 
i
 = 0; i < 
MAXOPEN
; i++) {

63 
›íèb
[
i
].
o_fûeid
 = i;

64 
›íèb
[
i
].
o_fd
 = (
Fd
*Ë
va
;

65 
va
 +
PGSIZE
;

67 
	}
}

71 
	$›ífûe_Æloc
(
O≥nFûe
 **
o
)

73 
i
, 
r
;

76 
i
 = 0; i < 
MAXOPEN
; i++)

78 
	`∑gîef
(
›íèb
[
i
].
o_fd
)) {

80 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
›íèb
[
i
].
o_fd
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

81  
r
;

84 
›íèb
[
i
].
o_fûeid
 +
MAXOPEN
;

85 *
o
 = &
›íèb
[
i
];

86 
	`mem£t
(
›íèb
[
i
].
o_fd
, 0, 
PGSIZE
);

87  (*
o
)->
o_fûeid
;

90  -
E_MAX_OPEN
;

91 
	}
}

95 
	$›ífûe_lookup
(
ívid_t
 
ívid
, 
uöt32_t
 
fûeid
, 
O≥nFûe
 **
po
)

97 
O≥nFûe
 *
o
;

99 
o
 = &
›íèb
[
fûeid
 % 
MAXOPEN
];

100 i‡(
	`∑gîef
(
o
->
o_fd
Ë<1 || o->
o_fûeid
 !
fûeid
)

101  -
E_INVAL
;

102 *
po
 = 
o
;

104 
	}
}

110 
	$£rve_›í
(
ívid_t
 
ívid
, 
F§eq_›í
 *
ªq
,

111 **
pg_°‹e
, *
≥rm_°‹e
)

113 
∑th
[
MAXPATHLEN
];

114 
DúE¡ry
 *
f
;

115 
r
;

116 
O≥nFûe
 *
o
;

118 i‡(
debug
)

119 
	`˝rötf
("£rve_›í [%08x] %†0x%x\n", 
ívid
, 
ªq
->
ªq_∑th
,Ñeq->
ªq_omode
);

122 
	`memmove
(
∑th
, 
ªq
->
ªq_∑th
, 
MAXPATHLEN
);

123 
∑th
[
MAXPATHLEN
-1] = 0;

126 i‡(
ªq
->
ªq_omode
 & 
O_MKDIR
) {

127 i‡((
r
 = 
	`fûe_¸óã
(
∑th
, &
f
, 
FTYPE_DIR
) < 0))

128  
r
;

132 i‡((
r
 = 
	`›ífûe_Æloc
(&
o
)) < 0) {

133 i‡(
debug
)

134 
	`˝rötf
("›ífûe_Ælo¯Áûed: %e\n", 
r
);

135  
r
;

139 i‡(
ªq
->
ªq_omode
 & 
O_CREAT
) {

140 i‡((
r
 = 
	`fûe_¸óã
(
∑th
, &
f
, 
FTYPE_REG
)) < 0) {

141 i‡(!(
ªq
->
ªq_omode
 & 
O_EXCL
Ë&& 
r
 =-
E_FILE_EXISTS
)

142 
åy_›í
;

143 i‡(
debug
)

144 
	`˝rötf
("fûe_¸óã faûed: %e\n", 
r
);

145  
r
;

148 
åy_›í
:

149 i‡((
r
 = 
	`fûe_›í
(
∑th
, &
f
)) < 0) {

150 i‡(
debug
)

151 
	`˝rötf
("fûe_›í faûed: %e\n", 
r
);

152  
r
;

157 i‡(
ªq
->
ªq_omode
 & 
O_TRUNC
) {

158 i‡((
r
 = 
	`fûe_£t_size
(
f
, 0)) < 0) {

159 i‡(
debug
)

160 
	`˝rötf
("fûe_£t_sizêÁûed: %e\n", 
r
);

161  
r
;

164 i‡((
r
 = 
	`fûe_›í
(
∑th
, &
f
)) < 0) {

165 i‡(
debug
)

166 
	`˝rötf
("fûe_›í faûed: %e\n", 
r
);

167  
r
;

171 
o
->
o_fûe
 = 
f
;

172 i‡(
f
 =
NULL
)

173 
o
->
o_fûe
 = &
π_íåy
;

176 
o
->
o_fd
->
fd_fûe
.
id
 = o->
o_fûeid
;

177 
o
->
o_fd
->
fd_omode
 = 
ªq
->
ªq_omode
 & 
O_ACCMODE
;

178 
o
->
o_fd
->
fd_dev_id
 = 
devfûe
.
dev_id
;

179 
o
->
o_mode
 = 
ªq
->
ªq_omode
;

181 i‡(
debug
)

182 
	`˝rötf
("£ndög suc˚ss,Öagê%08x\n", (
uöçå_t
Ë
o
->
o_fd
);

186 *
pg_°‹e
 = 
o
->
o_fd
;

187 *
≥rm_°‹e
 = 
PTE_P
|
PTE_U
|
PTE_W
|
PTE_SHARE
;

190 
	}
}

195 
	$£rve_£t_size
(
ívid_t
 
ívid
, 
F§eq_£t_size
 *
ªq
)

197 
O≥nFûe
 *
o
;

198 
r
;

200 i‡(
debug
)

201 
	`˝rötf
("£rve_£t_sizê%08x %08x %08x\n", 
ívid
,

202 
ªq
->
ªq_fûeid
,Ñeq->
ªq_size
);

209 i‡((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

210  
r
;

214  
	`fûe_£t_size
(
o
->
o_fûe
, 
ªq
->
ªq_size
);

215 
	}
}

222 
	$£rve_ªad
(
ívid_t
 
ívid
, 
Fsùc
 *
ùc
)

224 
F§eq_ªad
 *
ªq
 = &
ùc
->
ªad
;

225 
F§ë_ªad
 *
ªt
 = &
ùc
->
ªadRë
;

227 i‡(
debug
)

228 
	`˝rötf
("£rve_ªad %08x %08x %08x\n", 
ívid
,

229 
ªq
->
ªq_fûeid
,Ñeq->
ªq_n
);

231 
O≥nFûe
 * 
o
;

232 
r
;

233 if((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

234  
r
;

235 if((
r
 = 
	`fûe_ªad
(
o
->
o_fûe
, (*)
ªt
->
ªt_buf
,

236 
ªq
->
ªq_n
, 
o
->
o_fd
->
fd_off£t
)) >= 0)

237 
o
->
o_fd
->
fd_off£t
 +
r
;

238  
r
;

239 
	}
}

247 
	$£rve_wrôe
(
ívid_t
 
ívid
, 
F§eq_wrôe
 *
ªq
)

249 i‡(
debug
)

250 
	`˝rötf
("£rve_wrôê%08x %08x %08x\n", 
ívid
,

251 
ªq
->
ªq_fûeid
,Ñeq->
ªq_n
);

253 
O≥nFûe
 * 
o
;

254 
r
;

255 if((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

256  
r
;

257 if((
r
 = 
	`fûe_wrôe
(
o
->
o_fûe
, (*)
ªq
->
ªq_buf
,

258 
ªq
->
ªq_n
, 
o
->
o_fd
->
fd_off£t
)) >= 0)

259 
o
->
o_fd
->
fd_off£t
 +
r
;

260  
r
;

263 
	}
}

268 
	$£rve_°©
(
ívid_t
 
ívid
, 
Fsùc
 *
ùc
)

270 
F§eq_°©
 *
ªq
 = &
ùc
->
°©
;

271 
F§ë_°©
 *
ªt
 = &
ùc
->
°©Rë
;

272 
O≥nFûe
 *
o
;

273 
r
;

275 i‡(
debug
)

276 
	`˝rötf
("£rve_°© %08x %08x\n", 
ívid
, 
ªq
->
ªq_fûeid
);

278 i‡((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

279  
r
;

281 
DamnInode
 * 
öode
;

283 i‡(
o
->
o_fûe
 =
NULL
) {

284 
öode
 = &
öodes
[0];

285 
	`°r˝y
(
ªt
->
ªt_«me
, "/");

288 
öode
 = &
öodes
[
o
->
o_fûe
->
ö_öd
];

289 
	`°r˝y
(
ªt
->
ªt_«me
, 
o
->
o_fûe
->
f_«me
);

291 
ªt
->
ªt_size
 = 
öode
->
size
;

292 
ªt
->
ªt_isdú
 = (
öode
->
ty≥
 =
FTYPE_DIR
);

294 
	}
}

298 
	$£rve_Êush
(
ívid_t
 
ívid
, 
F§eq_Êush
 *
ªq
)

300 
O≥nFûe
 *
o
;

301 
r
;

303 i‡(
debug
)

304 
	`˝rötf
("£rve_Êush %08x %08x\n", 
ívid
, 
ªq
->
ªq_fûeid
);

306 i‡((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

307  
r
;

308 i‡(
o
->
o_fûe
->
ö_öd
 != 0)

309 
	`fûe_Êush
(
o
->
o_fûe
);

311 
	`fûe_Êush
(&
öodes
[0]);

313 
	}
}

317 
	$£rve_mkdú
(
ívid_t
 
ívid
, 
F§eq_mkdú
 *
ªq
)

319 
∑th
[
MAXPATHLEN
];

321 i‡(
debug
)

322 
	`˝rötf
("£rve_mkdú %08x %s\n", 
ívid
, 
ªq
->
ªq_∑th
);

328 
	`memmove
(
∑th
, 
ªq
->
ªq_∑th
, 
MAXPATHLEN
);

329 
∑th
[
MAXPATHLEN
-1] = 0;

332  
	`fûe_¸óã
(
∑th
, 0, 
FTYPE_DIR
);

333 
	}
}

338 
	$£rve_ªmove
(
ívid_t
 
ívid
, 
F§eq_ªmove
 *
ªq
)

340 
∑th
[
MAXPATHLEN
];

342 i‡(
debug
)

343 
	`˝rötf
("£rve_ªmovê%08x %s\n", 
ívid
, 
ªq
->
ªq_∑th
);

349 
	`memmove
(
∑th
, 
ªq
->
ªq_∑th
, 
MAXPATHLEN
);

350 
∑th
[
MAXPATHLEN
-1] = 0;

353  
	`fûe_ªmove
(
∑th
);

354 
	}
}

358 
	$£rve_sync
(
ívid_t
 
ívid
, 
Fsùc
 *
ªq
)

360 
	`fs_sync
();

362 
	}
}

364 (*
	tfsh™dÀr
)(
	tívid_t
 
	tívid
, 
	tFsùc
 *
	tªq
);

366 
fsh™dÀr
 
h™dÀrs
[] = {

369 [
FSREQ_READ
] = 
£rve_ªad
,

370 [
FSREQ_STAT
] = 
£rve_°©
,

371 [
FSREQ_FLUSH
] = (
fsh™dÀr
)
£rve_Êush
,

372 [
FSREQ_WRITE
] = (
fsh™dÀr
)
£rve_wrôe
,

373 [
FSREQ_SET_SIZE
] = (
fsh™dÀr
)
£rve_£t_size
,

374 [
FSREQ_REMOVE
] = (
fsh™dÀr
)
£rve_ªmove
,

375 [
FSREQ_MKDIR
] = (
fsh™dÀr
)
£rve_mkdú
,

376 [
FSREQ_SYNC
] = 
£rve_sync


377 
	}
};

378 
	#NHANDLERS
 ((
h™dÀrs
)/(h™dÀrs[0]))

	)

381 
	$£rve
()

383 
uöt32_t
 
ªq
, 
whom
;

384 
≥rm
, 
r
;

385 *
pg
;

389 
≥rm
 = 0;

390 
ªq
 = 
	`ùc_ªcv
((
öt32_t
 *Ë&
whom
, 
f§eq
, &
≥rm
);

391 i‡(
debug
)

392 
	`˝rötf
("fsÑeq %d from %08x [page %08x: %s]\n",

393 
ªq
, 
whom
, 
uv±
[
	`PGNUM
(
f§eq
)], fsreq);

396 i‡(!(
≥rm
 & 
PTE_P
)) {

397 
	`˝rötf
("InvalidÑequest from %08x:ÇoárgumentÖage\n",

398 
whom
);

402 
pg
 = 
NULL
;

403 i‡(
ªq
 =
FSREQ_OPEN
)

405 
r
 = 
	`£rve_›í
(
whom
, (
F§eq_›í
*)
f§eq
, &
pg
, &
≥rm
);

407 i‡(
ªq
 < 
NHANDLERS
 && 
h™dÀrs
[req])

409 
r
 = 
h™dÀrs
[
ªq
](
whom
, 
f§eq
);

413 
	`˝rötf
("InvÆidÑeque° codê%d from %08x\n", 
ªq
, 
whom
);

414 
r
 = -
E_INVAL
;

416 
	`ùc_£nd
(
whom
, 
r
, 
pg
, 
≥rm
);

417 
	`sys_∑ge_unm≠
(0, 
f§eq
);

419 
	}
}

422 
	$umaö
(
¨gc
, **
¨gv
)

424 
bö¨y«me
 = "fs";

425 
	`˝rötf
("FS: isÑunning\n");

428 
	`outw
(0x8A00, 0x8A00);

429 
	`˝rötf
("FS: can do I/O\n");

431 
	`£rve_öô
();

432 
	`fs_öô
();

433 
	`£rve
();

434 
	}
}

	@sh.c

1 
	~<sy¶ib.h
>

3 
	#BUFSIZ
 1024

	)

4 
	gbuf
[
BUFSIZ
];

5 
	gdebug
 = 0;

8 
	gÊag
[256];

9 
	gcuΩ©h
[
MAXPATHLEN
];

10 
	gﬁd∑th
[
MAXPATHLEN
];

11 
	gfuŒ∑th
[
MAXPATHLEN
];

13 
lsdú
(const *, const *);

14 
ls1
(c⁄° *, 
boﬁ
, 
off_t
, const *);

17 
	$upd©e_cuΩ©h
(c⁄° *
po°
, 
size
)

19 
Àn
 = 
	`°æí
(
cuΩ©h
);

20 i‡(
size
 > 0) {

21 i‡(
po°
[0] !'/' && 
cuΩ©h
[
Àn
-1] != '/')

22 
cuΩ©h
[
Àn
++] = '/';

23 
	`mem˝y
(
cuΩ©h
+
Àn
, 
po°
, 
size
);

24 
cuΩ©h
[
Àn
+
size
] = '\0';

27 
i
 = 
Àn
-1;

28 
cuΩ©h
[
i
] != '/' && i > 1)

29 --
i
;

30 
cuΩ©h
[
i
] = 0;

32 
	}
}

35 
	$upd©e_fuŒ∑th
(c⁄° *
po°
)

37 
Àn
 = 
	`°æí
(
cuΩ©h
);

38 
	`°r˝y
(
fuŒ∑th
, 
cuΩ©h
);

39 i‡(
cuΩ©h
[
Àn
-1] != '/') {

40 
fuŒ∑th
[
Àn
] = '/';

41 
fuŒ∑th
[++
Àn
] = '\0';

43 
	`°r˝y
(
fuŒ∑th
+
Àn
, 
po°
);

44 
	}
}

48 
	$cd
(c⁄° *
∑th
)

50 
íd
 = 0, 
íd1
, 
fd
, 
r
, 
n
;

51 
Sèt
 
°
;

52 
DúE¡ry
 
f
;

54 i‡(
∑th
[0] == '\0')

57 i‡(
∑th
[0] == '/')

58 
∑th
++;

60 
∑th
[
íd
] != '/' &&Öath[end])

61 ++
íd
;

62 i‡(!
∑th
[
íd
] &&Énd == 0)

65 
èrgë
[
MAXNAMELEN
];

66 
	`mem˝y
(
èrgë
, 
∑th
, 
íd
);

67 
èrgë
[
íd
] = 0;

69 i‡(
íd
 > 
MAXNAMELEN
) {

70 
	`upd©e_fuŒ∑th
(
èrgë
);

71 
	`¥ötf
("cd %s: %e\n", 
fuŒ∑th
, -
E_BAD_NAME
);

74 i‡(
∑th
[
íd
] &&Énd == 0) {

75 
	`upd©e_fuŒ∑th
("/");

76 
	`¥ötf
("cd %s: %e\n", 
fuŒ∑th
, -
E_BAD_PATH
);

82 
	`upd©e_fuŒ∑th
(
èrgë
);

84 i‡((
r
 = 
	`°©
(
cuΩ©h
, &
°
)) < 0) {

85 
	`¥ötf
("cd %s: %e\n", 
fuŒ∑th
, 
r
);

86  
r
;

88 i‡(!
°
.
°_isdú
) {

89 
	`¥ötf
("cd %s:ÇŸá dúe˘‹y\n", 
fuŒ∑th
);

90  
r
;

93 i‡((
fd
 = 
	`›í
(
cuΩ©h
, 
O_RDONLY
)) < 0) {

94 
	`¥ötf
("cd %s: %e\n", 
∑th
, 
fd
);

95  
fd
;

97 (
n
 = 
	`ªadn
(
fd
, &
f
,  f)) ==  f) {

98 i‡(
	`°rcmp
(
f
.
f_«me
, 
èrgë
) == 0) {

99 i‡(
	`°rcmp
(
f
.
f_«me
, ".."Ë=0 && såcmp(
cuΩ©h
, "/") != 0)

100 
	`upd©e_cuΩ©h
("", -1);

101 i‡(
	`°rcmp
(
f
.
f_«me
, "..") != 0 && strcmp(f.f_name, ".") != 0)

102 
	`upd©e_cuΩ©h
(
èrgë
, 
íd
);

103 
	`˛o£
(
fd
);

104  
	`cd
(
∑th
+
íd
);

108 
	`¥ötf
("cd %s:Çÿsuch dúe˘‹y\n", 
fuŒ∑th
);

109 
	`˛o£
(
fd
);

111 
	}
}

114 
	$pwd
()

116 
	`¥ötf
(" %s\n", 
cuΩ©h
);

118 
	}
}

123 
	$ˇt
(
f
, *
s
)

125 
n
;

126 
r
;

128 (
n
 = 
	`ªad
(
f
, 
buf
, ()(buf))Ë> 0 &&Ç < 
BUFSIZ
)

129 i‡((
r
 = 
	`wrôe
(1, 
buf
, 
n
)) !=Ç)

130 
	`∑nic
("wrôêîr‹ c›yög %s: %e", 
s
, 
r
);

131 i‡(
n
 < 0)

132 
	`∑nic
("îr‹Ñódög %s: %e", 
s
, 
n
);

133 
	}
}

136 
	$mkdú
(c⁄° *
∑th
)

138 
r
;

139 
Sèt
 
°
;

141 i‡(
∑th
[0] != '/') {

142 
	`upd©e_fuŒ∑th
(
∑th
);

143 
∑th
 = 
fuŒ∑th
;

145 i‡((
r
 = 
	`°©
(
∑th
, &
°
)) < 0) {

146 i‡(
r
 !-
E_NOT_FOUND
) {

147 
	`¥ötf
("mkdú %s: %e", 
∑th
, 
r
);

149 i‡((
r
 = 
	`makedú
(
∑th
)) < 0) {

150 
	`¥ötf
("mkdú %s: %e", 
∑th
, 
r
);

154 
	`¥ötf
("mkdú %s: %e\n", 
∑th
, -
E_FILE_EXISTS
);

155 
	}
}

158 
	$rm
(c⁄° *
∑th
)

160 
r
;

161 
Sèt
 
°
;

163 i‡(
∑th
[0] != '/') {

164 
	`upd©e_fuŒ∑th
(
∑th
);

165 
∑th
 = 
fuŒ∑th
;

167 i‡((
r
 = 
	`°©
(
∑th
, &
°
)) < 0) {

168 
	`¥ötf
("rm %s: %e\n", 
∑th
, 
r
);

171 i‡(
°
.
°_isdú
 && st.
°_size
 > 2*
DIRESIZE
) {

172 
	`¥ötf
("rm %s:ÇŸá¿em±y dúe˘‹y\n", 
∑th
);

175 i‡((
r
 = 
	`ªmove
(
∑th
)) < 0) {

176 
	`¥ötf
("rm %s: %e\n", 
∑th
, 
r
);

178 
	}
}

181 
	$ls
(c⁄° *
∑th
, c⁄° *
¥efix
)

183 
r
;

184 
Sèt
 
°
;

186 i‡(
∑th
[0] == '.') {

187 
	`upd©e_fuŒ∑th
(
∑th
);

188 
∑th
 = 
fuŒ∑th
;

190 i‡((
r
 = 
	`°©
(
∑th
, &
°
)) < 0) {

191 
	`¥ötf
("l†%s: %e", 
∑th
, 
r
);

193 i‡(
°
.
°_isdú
 && !
Êag
['d'])

194 
	`lsdú
(
∑th
,Öath);

196 
	`ls1
(0, 
°
.
°_isdú
, st.
°_size
, 
∑th
);

197 
	}
}

200 
	$lsdú
(c⁄° *
∑th
, c⁄° *
¥efix
)

202 
fd
, 
n
, 
Àn
, 
r
;

203 
DúE¡ry
 
f
;

204 
Sèt
 
°
;

206 
Àn
 = 
	`°æí
(
∑th
);

207 i‡((
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
)) < 0) {

208 
	`¥ötf
("l†%s: %e\n", 
∑th
, 
fd
);

211 (
n
 = 
	`ªadn
(
fd
, &
f
,  f)) ==  f)

212 i‡(
f
.
f_«me
[0]) {

213 
	`upd©e_fuŒ∑th
(
f
.
f_«me
);

214 i‡((
r
 = 
	`°©
(
fuŒ∑th
, &
°
)) < 0)

215 
	`¥ötf
("l†%s: %e\n", 
fuŒ∑th
, 
r
);

216 
	`ls1
(
¥efix
, 
°
.
°_isdú
, st.
°_size
, 
f
.
f_«me
);

218 
	`˛o£
(
fd
);

219 i‡(
n
 > 0)

220 
	`∑nic
("sh‹àªad i¿dúe˘‹y %s\n", 
∑th
);

221 i‡(
n
 < 0)

222 
	`∑nic
("îr‹Ñódög dúe˘‹y %s: %e\n", 
∑th
, 
n
);

223 
	}
}

226 
	$ls1
(c⁄° *
¥efix
, 
boﬁ
 
isdú
, 
off_t
 
size
, c⁄° *
«me
)

228 c⁄° *
£p
;

230 
	`¥ötf
("%6d %¯", 
size
, 
isdú
 ? 'd' : '-');

231 if(
¥efix
) {

232 i‡(
¥efix
[0] &&Öªfix[
	`°æí
(prefix)-1] != '/')

233 
£p
 = "/";

235 
£p
 = "";

236 
	`¥ötf
("%s%s", 
¥efix
, 
£p
);

238 
	`¥ötf
("%s", 
«me
);

239 
	`¥ötf
("\n");

240 
	}
}

243 
	$pögp⁄g
()

245 
ívid_t
 
who
;

247 i‡((
who
 = 
	`f‹k
()) != 0) {

249 
	`˝rötf
("£nd 0 from %xÅÿ%x\n", 
	`sys_gëívid
(), 
who
);

250 
	`ùc_£nd
(
who
, 0, 0, 0);

254 
uöt32_t
 
i
 = 
	`ùc_ªcv
(&
who
, 0, 0);

255 
	`˝rötf
("%x gŸ %d from %x\n", 
	`sys_gëívid
(), 
i
, 
who
);

256 i‡(
i
 >= 10)

258 
i
++;

259 
	`ùc_£nd
(
who
, 
i
, 0, 0);

260 i‡(
i
 >= 10)

263 
	}
}

265 
	$lﬂd_cuΩ©h
(){

266 
glb_v¨_fd
;

269 i‡((
glb_v¨_fd
 = 
	`›í
("/.globÆ_v¨", 
O_RDONLY
)) < 0)

270 
	`¥ötf
("›í %s: %e", "/.globÆ_v¨", 
glb_v¨_fd
);

271 
cuΩ©hÀn
 = 
	`ªadn
(
glb_v¨_fd
, 
cuΩ©h
, 
MAXPATHLEN
);

272 
cuΩ©h
[
cuΩ©hÀn
] = '\0';

273 
	`˛o£
(
glb_v¨_fd
);

274 
	}
}

279 
	$ßve_cuΩ©h
(){

280 
glb_v¨_fd
;

283 i‡((
glb_v¨_fd
 = 
	`›í
("/.globÆ_v¨", 
O_WRONLY
|
O_CREAT
)) < 0)

284 
	`∑nic
("›í %s: %e", "/.globÆ_v¨", 
glb_v¨_fd
);

285 
	`wrôe
(
glb_v¨_fd
, 
cuΩ©h
, 
	`°æí
(curpath));

286 
	`˛o£
(
glb_v¨_fd
);

289 
	}
}

297 
gëtokí
(*
s
, **
tokí
);

304 
	#MAXARGS
 16

	)

306 
	$runcmd
(* 
s
)

308 *
¨gv
[
MAXARGS
], *
t
, 
¨gv0buf
[
BUFSIZ
];

309 
¨gc
, 
c
, 
i
, 
r
, 
p
[2], 
fd
, 
pùe_chûd
;

311 
pùe_chûd
 = 0;

312 
	`gëtokí
(
s
, 0);

314 
agaö
:

315 
¨gc
 = 0;

317 (
c
 = 
	`gëtokí
(0, &
t
))) {

320 i‡(
¨gc
 =
MAXARGS
) {

321 
	`˝rötf
("too manyárguments\n");

322 
	`exô
();

324 
¨gv
[
¨gc
++] = 
t
;

329 i‡(
	`gëtokí
(0, &
t
) != 'w') {

330 
	`˝rötf
("syntaxÉrror: <Çot followed by word\n");

331 
	`exô
();

342 
	`upd©e_fuŒ∑th
(
t
);

343 if((
fd
 = 
	`›í
(
fuŒ∑th
, 
O_RDONLY
)) < 0)

345 
	`˝rötf
("›í %†f‹Ñód: %e", 
t
, 
fd
);

346 
	`exô
();

348 if(
fd
 != 0)

350 
	`dup
(
fd
, 0);

351 
	`˛o£
(
fd
);

357 i‡(
	`gëtokí
(0, &
t
) != 'w') {

358 
	`˝rötf
("syntaxÉrror: >Çot followed by word\n");

359 
	`exô
();

361 
	`upd©e_fuŒ∑th
(
t
);

362 i‡((
fd
 = 
	`›í
(
fuŒ∑th
, 
O_WRONLY
|
O_CREAT
|
O_TRUNC
)) < 0) {

363 
	`˝rötf
("›í %†f‹ wrôe: %e", 
t
, 
fd
);

364 
	`exô
();

366 i‡(
fd
 != 1) {

367 
	`dup
(
fd
, 1);

368 
	`˛o£
(
fd
);

373 i‡((
r
 = 
	`pùe
(
p
)) < 0) {

374 
	`˝rötf
("pùe: %e", 
r
);

375 
	`exô
();

377 i‡(
debug
)

378 
	`˝rötf
("PIPE: %d %d\n", 
p
[0],Ö[1]);

379 i‡((
r
 = 
	`f‹k
()) < 0) {

380 
	`˝rötf
("f‹k: %e", 
r
);

381 
	`exô
();

383 i‡(
r
 == 0) {

384 i‡(
p
[0] != 0) {

385 
	`dup
(
p
[0], 0);

386 
	`˛o£
(
p
[0]);

388 
	`˛o£
(
p
[1]);

389 
agaö
;

391 
pùe_chûd
 = 
r
;

392 i‡(
p
[1] != 1) {

393 
	`dup
(
p
[1], 1);

394 
	`˛o£
(
p
[1]);

396 
	`˛o£
(
p
[0]);

397 
runô
;

399 
	`∑nic
("|Çot implemented");

404 
runô
;

407 
	`∑nic
("badÑëu∫ %d from gëtokí", 
c
);

413 
runô
:

415 if(
¨gc
 == 0) {

416 i‡(
debug
)

417 
	`˝rötf
("EMPTY COMMAND\n");

422 i‡(
¨gv
[0][0] == 'c' &&árgv[0][1] == 'd' &&árgv[0][2] == 0) {

423 i‡(
¨gc
 == 1)

424 
	`°r˝y
(
cuΩ©h
, "/");

425 i‡(
¨gc
 == 2) {

426 
	`°r˝y
(
ﬁd∑th
, 
cuΩ©h
);

427 i‡(
¨gv
[1][0] == '/') {

428 
cuΩ©h
[0] = '/';

429 
¨gv0buf
[0] = 0;

430 
	`°r˝y
(
¨gv0buf
, 
¨gv
[1]+1);

431 
¨gv
[1] = 
¨gv0buf
;

434 i‡(
	`cd
(
¨gv
[1]) < 0)

435 
	`°r˝y
(
cuΩ©h
, 
ﬁd∑th
);

436 
	`ßve_cuΩ©h
();

439 
	`¥ötf
("usage: cd [path]\n");

444 i‡(
¨gv
[0][0] == 'p' &&árgv[0][1] == 'w' &&árgv[0][2] == 'd' &&árgv[0][3] == 0) {

445 
	`pwd
();

446 
	`exô
();

449 i‡(
¨gv
[0][0] == 'r' &&árgv[0][1] == 'm' &&árgv[0][2] == 0) {

450 i‡(
¨gc
 != 2)

451 
	`¥ötf
("usage:Ñm [path]\n");

453 
	`upd©e_fuŒ∑th
(
¨gv
[1]);

454 
	`rm
(
fuŒ∑th
);

456 
	`exô
();

459 i‡(
¨gv
[0][0] == 'm' &&árgv[0][1] == 'k' &&árgv[0][2] == 'd' &&árgv[0][3] == 'i' &&árgv[0][4] == 'r' &&árgv[0][5] == 0) {

460 i‡(
¨gc
 != 2)

461 
	`¥ötf
("usage: mkdir [path]\n");

463 
	`upd©e_fuŒ∑th
(
¨gv
[1]);

464 
	`mkdú
(
fuŒ∑th
);

466 
	`exô
();

469 i‡(
¨gv
[0][0] == 'e' &&árgv[0][1] == 'c' &&árgv[0][2] == 'h' &&árgv[0][3] == 'o' &&árgv[0][4] == 0) {

470 
i
, 
nÊag
;

472 
nÊag
 = 0;

474 
i
 = 1; i < 
¨gc
; i++) {

475 i‡(
i
 > 1)

476 
	`wrôe
(1, " ", 1);

477 
	`wrôe
(1, 
¨gv
[
i
], 
	`°æí
(argv[i]));

479 i‡(!
nÊag
)

480 
	`wrôe
(1, "\n", 1);

481 
	`exô
();

484 i‡(
¨gv
[0][0] == 'p' &&árgv[0][1] == 'i' &&árgv[0][2] == 'n' &&árgv[0][3] == 'g' \

485 && 
¨gv
[0][4] == 'p' &&árgv[0][5] == 'o' &&árgv[0][6] == 'n' &&árgv[0][7] == 'g' &&árgv[0][8] == 0 ) {

486 
	`pögp⁄g
();

487 
	`exô
();

490 i‡(
¨gv
[0][0] == 'c' &&árgv[0][1] == 'a' &&árgv[0][2] == 't' &&árgv[0][3] == 0) {

491 
f
, 
i
;

493 i‡(
¨gc
 == 1)

494 
	`ˇt
(0, "<stdin>");

496 
i
 = 1; i < 
¨gc
; i++) {

497 
	`upd©e_fuŒ∑th
(
¨gv
[
i
]);

498 
f
 = 
	`›í
(
fuŒ∑th
, 
O_RDONLY
);

499 i‡(
f
 < 0)

500 
	`¥ötf
("ˇn'à›í %s: %e\n", 
¨gv
[
i
], 
f
);

502 
	`ˇt
(
f
, 
fuŒ∑th
);

503 
	`˛o£
(
f
);

506 
	`exô
();

510 i‡(
¨gv
[0][0] == 'l' &&árgv[0][1] == 's' &&árgv[0][2] == 0) {

511 i‡(
¨gc
 == 1)

512 
	`ls
(
cuΩ©h
, curpath);

514 
	`ls
(
¨gv
[1],árgv[1]);

515 
	`exô
();

521 i‡(
¨gv
[0][0] != '/') {

522 
	`°r˝y
(
¨gv0buf
, 
cuΩ©h
);

523 
	`°r˝y
(
¨gv0buf
 + 1, 
¨gv
[0]);

524 
¨gv
[0] = 
¨gv0buf
;

526 
¨gv
[
¨gc
] = 0;

529 i‡(
debug
) {

530 
	`˝rötf
("[%08x] SPAWN:", 
thi£nv
->
ív_id
);

531 
i
 = 0; 
¨gv
[i]; i++)

532 
	`˝rötf
(" %s", 
¨gv
[
i
]);

533 
	`˝rötf
("\n");

537 i‡((
r
 = 
	`•awn
(
¨gv
[0], (const **)árgv)) < 0)

538 
	`˝rötf
("•aw¿%s: %e\n", 
¨gv
[0], 
r
);

542 
	`˛o£_Æl
();

543 i‡(
r
 >= 0) {

544 i‡(
debug
)

545 
	`˝rötf
("[%08x] WAIT %†%08x\n", 
thi£nv
->
ív_id
, 
¨gv
[0], 
r
);

546 
	`waô
(
r
);

547 i‡(
debug
)

548 
	`˝rötf
("[%08x] waô föished\n", 
thi£nv
->
ív_id
);

553 i‡(
pùe_chûd
) {

554 i‡(
debug
)

555 
	`˝rötf
("[%08x] WAITÖùe_chûd %08x\n", 
thi£nv
->
ív_id
, 
pùe_chûd
);

556 
	`waô
(
pùe_chûd
);

557 i‡(
debug
)

558 
	`˝rötf
("[%08x] waô föished\n", 
thi£nv
->
ív_id
);

562 
	`exô
();

563 
	}
}

577 
	#WHITESPACE
 " \t\r\n"

	)

578 
	#SYMBOLS
 "<|>&;()"

	)

581 
	$_gëtokí
(*
s
, **
p1
, **
p2
)

583 
t
;

585 i‡(
s
 == 0) {

586 i‡(
debug
 > 1)

587 
	`˝rötf
("GETTOKEN NULL\n");

591 i‡(
debug
 > 1)

592 
	`˝rötf
("GETTOKEN: %s\n", 
s
);

594 *
p1
 = 0;

595 *
p2
 = 0;

597 
	`°rchr
(
WHITESPACE
, *
s
))

598 *
s
++ = 0;

599 i‡(*
s
 == 0) {

600 i‡(
debug
 > 1)

601 
	`˝rötf
("EOL\n");

604 i‡(
	`°rchr
(
SYMBOLS
, *
s
)) {

605 
t
 = *
s
;

606 *
p1
 = 
s
;

607 *
s
++ = 0;

608 *
p2
 = 
s
;

609 i‡(
debug
 > 1)

610 
	`˝rötf
("TOK %c\n", 
t
);

611  
t
;

613 *
p1
 = 
s
;

614 *
s
 && !
	`°rchr
(
WHITESPACE
 
SYMBOLS
, *s))

615 
s
++;

616 *
p2
 = 
s
;

617 i‡(
debug
 > 1) {

618 
t
 = **
p2
;

619 **
p2
 = 0;

620 
	`˝rötf
("WORD: %s\n", *
p1
);

621 **
p2
 = 
t
;

624 
	}
}

627 
	$gëtokí
(*
s
, **
p1
)

629 
c
, 
nc
;

630 * 
≈1
, *
≈2
;

632 i‡(
s
) {

633 
nc
 = 
	`_gëtokí
(
s
, &
≈1
, &
≈2
);

636 
c
 = 
nc
;

637 *
p1
 = 
≈1
;

638 
nc
 = 
	`_gëtokí
(
≈2
, &
≈1
, &np2);

639  
c
;

640 
	}
}

644 
	$ußge
()

646 
	`˝rötf
("usage: sh [-dix] [command-file]\n");

647 
	`exô
();

648 
	}
}

651 
	$umaö
(
¨gc
, **
¨gv
)

653 
öãø˘ive
, 
echocmds
;

654 
Arg°©e
 
¨gs
;

655 
r
;

657 
	`˝rötf
("initsh:Ñunning sh\n");

660 
	`˛o£
(0);

661 i‡((
r
 = 
	`›íc⁄s
()) < 0)

662 
	`∑nic
("›íc⁄s: %e", 
r
);

663 i‡(
r
 != 0)

664 
	`∑nic
("fú° o≥nc⁄†u£d fd %d", 
r
);

665 i‡((
r
 = 
	`dup
(0, 1)) < 0)

666 
	`∑nic
("dup: %e", 
r
);

668 
	`˝rötf
("initsh: starting sh\n");

671 
cuΩ©h
[0] = '/', curpath[1] = '\0';

672 
	`ßve_cuΩ©h
();

674 
öãø˘ive
 = '?';

675 
echocmds
 = 0;

676 
	`¨g°¨t
(&
¨gc
, 
¨gv
, &
¨gs
);

677 (
r
 = 
	`¨g√xt
(&
¨gs
)) >= 0)

678 
r
) {

680 
debug
++;

683 
öãø˘ive
 = 1;

686 
echocmds
 = 1;

689 
	`ußge
();

692 i‡(
¨gc
 > 2)

693 
	`ußge
();

694 i‡(
¨gc
 == 2) {

695 
	`˛o£
(0);

696 i‡((
r
 = 
	`›í
(
¨gv
[1], 
O_RDONLY
)) < 0)

697 
	`∑nic
("›í %s: %e", 
¨gv
[1], 
r
);

699 i‡(
öãø˘ive
 == '?')

700 
öãø˘ive
 = 
	`isc⁄s
(0);

703 *
buf
;

705 
buf
 = 
	`ªadlöe
(
öãø˘ive
 ? "$> " : 
NULL
);

706 i‡(
buf
 =
NULL
) {

707 i‡(
debug
)

708 
	`˝rötf
("EXITING\n");

709 
	`exô
();

711 i‡(
debug
)

712 
	`˝rötf
("LINE: %s\n", 
buf
);

713 i‡(
buf
[0] == '#')

715 i‡(
echocmds
)

716 
	`¥ötf
("# %s\n", 
buf
);

717 i‡(
debug
)

718 
	`˝rötf
("BEFORE FORK\n");

719 i‡(
	`°æí
(
buf
) >= 2 && buf[0] == 'c' && buf[1] == 'd') {

720 
	`runcmd
(
buf
);

723 i‡((
r
 = 
	`f‹k
()) < 0)

724 
	`∑nic
("f‹k: %e", 
r
);

725 i‡(
debug
)

726 
	`˝rötf
("FORK: %d\n", 
r
);

727 i‡(
r
 == 0) {

728 
	`runcmd
(
buf
);

729 
	`exô
();

731 
	`waô
(
r
);

733 
	}
}

	@spawn.c

1 
	~<sy¶ib.h
>

2 
	~<ñf.h
>

4 
	#UTEMP2USTACK
(
addr
Ë((*Ë◊ddrË+ (
USTACKTOP
 - 
PGSIZE
Ë- 
UTEMP
)

	)

5 
	#UTEMP2
 (
UTEMP
 + 
PGSIZE
)

	)

6 
	#UTEMP3
 (
UTEMP2
 + 
PGSIZE
)

	)

9 
öô_°ack
(
ívid_t
 
chûd
, c⁄° **
¨gv
, 
uöçå_t
 *
öô_e•
);

10 
m≠_£gmít
(
ívid_t
 
chûd
, 
uöçå_t
 
va
, 
size_t
 
memsz
,

11 
fd
, 
size_t
 
fûesz
, 
off_t
 
fûeoff£t
, 
≥rm
);

12 
c›y_sh¨ed_∑ges
(
ívid_t
 
chûd
);

20 
	$•awn
(c⁄° *
¥og
, c⁄° **
¨gv
)

22 
ñf_buf
[512];

23 
Tøp‰ame
 
chûd_tf
;

24 
ívid_t
 
chûd
;

26 
fd
, 
i
, 
r
;

27 
Elf
 *
ñf
;

28 
Proghdr
 *
ph
;

29 
≥rm
;

88 i‡((
r
 = 
	`›í
(
¥og
, 
O_RDONLY
)) < 0)

89  
r
;

90 
fd
 = 
r
;

93 
ñf
 = (
Elf
*Ë
ñf_buf
;

94 i‡(
	`ªadn
(
fd
, 
ñf_buf
, (elf_buf)) != (elf_buf)

95 || 
ñf
->
e_magic
 !
ELF_MAGIC
) {

96 
	`˛o£
(
fd
);

98  -
E_NOT_EXEC
;

102 i‡((
r
 = 
	`sys_exof‹k
()) < 0)

103  
r
;

104 
chûd
 = 
r
;

107 
chûd_tf
 = 
ívs
[
	`ENVX
(
chûd
)].
ív_tf
;

108 
chûd_tf
.
tf_eù
 = 
ñf
->
e_íåy
;

110 i‡((
r
 = 
	`öô_°ack
(
chûd
, 
¨gv
, &
chûd_tf
.
tf_e•
)) < 0)

111  
r
;

114 
ph
 = (
Proghdr
*Ë(
ñf_buf
 + 
ñf
->
e_phoff
);

115 
i
 = 0; i < 
ñf
->
e_phnum
; i++, 
ph
++) {

116 i‡(
ph
->
p_ty≥
 !
ELF_PROG_LOAD
)

118 
≥rm
 = 
PTE_P
 | 
PTE_U
;

119 i‡(
ph
->
p_Êags
 & 
ELF_PROG_FLAG_WRITE
)

120 
≥rm
 |
PTE_W
;

121 i‡((
r
 = 
	`m≠_£gmít
(
chûd
, 
ph
->
p_va
,Öh->
p_memsz
,

122 
fd
, 
ph
->
p_fûesz
,Öh->
p_off£t
, 
≥rm
)) < 0)

123 
îr‹
;

125 
	`˛o£
(
fd
);

126 
fd
 = -1;

129 i‡((
r
 = 
	`c›y_sh¨ed_∑ges
(
chûd
)) < 0)

130 
	`∑nic
("c›y_sh¨ed_∑ges: %e", 
r
);

132 i‡((
r
 = 
	`sys_ív_£t_å≠‰ame
(
chûd
, &
chûd_tf
)) < 0)

133 
	`∑nic
("sys_ív_£t_å≠‰ame: %e", 
r
);

135 i‡((
r
 = 
	`sys_ív_£t_°©us
(
chûd
, 
ENV_RUNNABLE
)) < 0)

136 
	`∑nic
("sys_ív_£t_°©us: %e", 
r
);

138  
chûd
;

140 
îr‹
:

141 
	`sys_ív_de°roy
(
chûd
);

142 
	`˛o£
(
fd
);

143  
r
;

144 
	}
}

150 
	$•aw∆
(c⁄° *
¥og
, c⁄° *
¨g0
, ...)

156 
¨gc
=0;

157 
va_li°
 
vl
;

158 
	`va_°¨t
(
vl
, 
¨g0
);

159 
	`va_¨g
(
vl
, *Ë!
NULL
)

160 
¨gc
++;

161 
	`va_íd
(
vl
);

165 c⁄° *
¨gv
[
¨gc
+2];

166 
¨gv
[0] = 
¨g0
;

167 
¨gv
[
¨gc
+1] = 
NULL
;

169 
	`va_°¨t
(
vl
, 
¨g0
);

170 
i
;

171 
i
=0;i<
¨gc
;i++)

172 
¨gv
[
i
+1] = 
	`va_¨g
(
vl
, const *);

173 
	`va_íd
(
vl
);

174  
	`•awn
(
¥og
, 
¨gv
);

175 
	}
}

186 
	$öô_°ack
(
ívid_t
 
chûd
, c⁄° **
¨gv
, 
uöçå_t
 *
öô_e•
)

188 
size_t
 
°rög_size
;

189 
¨gc
, 
i
, 
r
;

190 *
°rög_°‹e
;

191 
uöçå_t
 *
¨gv_°‹e
;

195 
°rög_size
 = 0;

196 
¨gc
 = 0; 
¨gv
[argc] != 0;árgc++)

197 
°rög_size
 +
	`°æí
(
¨gv
[
¨gc
]) + 1;

204 
°rög_°‹e
 = (*Ë
UTEMP
 + 
PGSIZE
 - 
°rög_size
;

207 
¨gv_°‹e
 = (
uöçå_t
*Ë(
	`ROUNDDOWN
(
°rög_°‹e
, 4Ë- 4 * (
¨gc
 + 1));

211 i‡((*Ë(
¨gv_°‹e
 - 2Ë< (*Ë
UTEMP
)

212  -
E_NO_MEM
;

215 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, (*Ë
UTEMP
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

216  
r
;

235 
i
 = 0; i < 
¨gc
; i++) {

236 
¨gv_°‹e
[
i
] = 
	`UTEMP2USTACK
(
°rög_°‹e
);

237 
	`°r˝y
(
°rög_°‹e
, 
¨gv
[
i
]);

238 
°rög_°‹e
 +
	`°æí
(
¨gv
[
i
]) + 1;

240 
¨gv_°‹e
[
¨gc
] = 0;

242 
¨gv_°‹e
[-1] = 
	`UTEMP2USTACK
(argv_store);

243 
¨gv_°‹e
[-2] = 
¨gc
;

245 *
öô_e•
 = 
	`UTEMP2USTACK
(&
¨gv_°‹e
[-2]);

249 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
UTEMP
, 
chûd
, (*Ë(
USTACKTOP
 - 
PGSIZE
), 
PTE_P
 | 
PTE_U
 | 
PTE_W
)) < 0)

250 
îr‹
;

251 i‡((
r
 = 
	`sys_∑ge_unm≠
(0, 
UTEMP
)) < 0)

252 
îr‹
;

256 
îr‹
:

257 
	`sys_∑ge_unm≠
(0, 
UTEMP
);

258  
r
;

259 
	}
}

262 
	$m≠_£gmít
(
ívid_t
 
chûd
, 
uöçå_t
 
va
, 
size_t
 
memsz
,

263 
fd
, 
size_t
 
fûesz
, 
off_t
 
fûeoff£t
, 
≥rm
)

265 
i
, 
r
;

266 *
blk
;

270 i‡((
i
 = 
	`PGOFF
(
va
))) {

271 
va
 -
i
;

272 
memsz
 +
i
;

273 
fûesz
 +
i
;

274 
fûeoff£t
 -
i
;

277 
i
 = 0; i < 
memsz
; i +
PGSIZE
) {

278 i‡(
i
 >
fûesz
) {

280 i‡((
r
 = 
	`sys_∑ge_Æloc
(
chûd
, (*Ë(
va
 + 
i
), 
≥rm
)) < 0)

281  
r
;

284 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
UTEMP
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

285  
r
;

286 i‡((
r
 = 
	`£ek
(
fd
, 
fûeoff£t
 + 
i
)) < 0)

287  
r
;

288 i‡((
r
 = 
	`ªadn
(
fd
, 
UTEMP
, 
	`MIN
(
PGSIZE
, 
fûesz
-
i
))) < 0)

289  
r
;

290 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
UTEMP
, 
chûd
, (*Ë(
va
 + 
i
), 
≥rm
)) < 0)

291 
	`∑nic
("•awn: sys_∑ge_m≠ d©a: %e", 
r
);

292 
	`sys_∑ge_unm≠
(0, 
UTEMP
);

296 
	}
}

300 
	$c›y_sh¨ed_∑ges
(
ívid_t
 
chûd
)

303 
i
;

304 
i
 = 0; i < 
UTOP
; i +
PGSIZE
)

306 if((
uvpd
[
	`PDX
(
i
)] & 
PTE_P
) &&

307 (
uv±
[
	`PGNUM
(
i
)] & 
PTE_P
) &&

308 (
uv±
[
	`PGNUM
(
i
)] & 
PTE_U
) &&

309 (
uv±
[
	`PGNUM
(
i
)] & 
PTE_SHARE
))

310 
	`sys_∑ge_m≠
(0, (*)
i
, 
chûd
, (*)i,

311 
PTE_SHARE
 | 
PTE_SYSCALL
);

314 
	}
}

	@spinlock.c

3 
	~<x86.h
>

4 
	~<utû.h
>

5 
	~<°rög.h
>

6 
	~<•ölock.h
>

9 
•ölock
 
	gkî√l_lock
;

12 
	$__•ö_öôlock
(
•ölock
 *
lk
, *
«me
)

14 
lk
->
locked
 = 0;

15 
	}
}

22 
	$•ö_lock
(
•ölock
 *
lk
)

28 
	`xchg
(&
lk
->
locked
, 1) != 0)

29 
asm
 volatile ("pause");

30 
	}
}

34 
	$•ö_u∆ock
(
•ölock
 *
lk
)

46 
	`xchg
(&
lk
->
locked
, 0);

47 
	}
}

	@spinlock.h

1 #i‚de‡
__SPINLOCK


2 
	#__SPINLOCK


	)

4 
	~<x86.h
>

8 
	s•ölock
 {

9 
	mlocked
;

12 
__•ö_öôlock
(
•ölock
 *
lk
, *
«me
);

13 
•ö_lock
(
•ölock
 *
lk
);

14 
•ö_u∆ock
(
•ölock
 *
lk
);

16 
	#•ö_öôlock
(
lock
Ë
	`__•ö_öôlock
÷ock, #lock)

	)

18 
•ölock
 
kî√l_lock
;

20 
ölöe
 

21 
	$lock_kî√l
()

23 
	`•ö_lock
(&
kî√l_lock
);

24 
	}
}

26 
ölöe
 

27 
	$u∆ock_kî√l
()

29 
	`•ö_u∆ock
(&
kî√l_lock
);

35 
asm
 volatile("pause");

36 
	}
}

	@stdio.c

1 
	~<x86.h
>

2 
	~<utû.h
>

3 
	~<°dio.h
>

4 
	~<°rög.h
>

5 
	~<îr‹.h
>

8 c⁄° * c⁄° 
	gîr‹_°rög
[
MAXERROR
] =

10 [
E_UNSPECIFIED
] = "unspecifiedÉrror",

11 [
E_BAD_ENV
] = "badÉnvironment",

12 [
E_INVAL
] = "invalidÖarameter",

13 [
E_NO_MEM
] = "out of memory",

14 [
E_NO_FREE_ENV
] = "out ofÉnvironments",

15 [
E_FAULT
] = "segmentation fault",

16 [
E_IPC_NOT_RECV
]= "env isÇotÑecving",

17 [
E_EOF
] = "unexpectedÉnd of file",

18 [
E_NO_DISK
] = "no free space on disk",

19 [
E_NO_INODE
] = "no free inode on disk",

20 [
E_MAX_OPEN
] = "too many filesáre open",

21 [
E_NOT_FOUND
] = "file or blockÇot found",

22 [
E_BAD_PATH
] = "invalidÖath",

23 [
E_BAD_NAME
] = "bad fileÇame",

24 [
E_FILE_EXISTS
] = "fileálreadyÉxists",

25 [
E_NOT_EXEC
] = "file isÇotá validÉxecutable",

26 [
E_NOT_SUPP
] = "operationÇot supported",

30 #i‚de‡
__FOR_USER__


37 
	$putch
(
ch
, *
˙t
)

39 
	`˝utch¨
(
ch
);

40 ++(*
˙t
);

41 
	}
}

44 
	$v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
)

46 
˙t
 = 0;

48 
	`v¥ötfmt
((*)
putch
, &
˙t
, 
fmt
, 
≠
);

49  
˙t
;

50 
	}
}

53 
	$˝rötf
(c⁄° *
fmt
, ...)

55 
va_li°
 
≠
;

56 
˙t
;

58 
	`va_°¨t
(
≠
, 
fmt
);

59 
˙t
 = 
	`v˝rötf
(
fmt
, 
≠
);

60 
	`va_íd
(
≠
);

62  
˙t
;

63 
	}
}

73 
	~<sy¶ib.h
>

81 
	s¥ötbuf
 {

82 
	midx
;

83 
	m˙t
;

84 
	mbuf
[256];

89 
	$putch
(
ch
, 
¥ötbuf
 *
b
)

91 
b
->
buf
[b->
idx
++] = 
ch
;

92 i‡(
b
->
idx
 == 256-1) {

93 
	`sys_˝uts
(
b
->
buf
, b->
idx
);

94 
b
->
idx
 = 0;

96 
b
->
˙t
++;

97 
	}
}

100 
	$v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
)

102 
¥ötbuf
 
b
;

104 
b
.
idx
 = 0;

105 
b
.
˙t
 = 0;

106 
	`v¥ötfmt
((*)
putch
, &
b
, 
fmt
, 
≠
);

107 
	`sys_˝uts
(
b
.
buf
, b.
idx
);

109  
b
.
˙t
;

110 
	}
}

113 
	$˝rötf
(c⁄° *
fmt
, ...)

115 
va_li°
 
≠
;

116 
˙t
;

118 
	`va_°¨t
(
≠
, 
fmt
);

119 
˙t
 = 
	`v˝rötf
(
fmt
, 
≠
);

120 
	`va_íd
(
≠
);

122  
˙t
;

123 
	}
}

130 
	sÂrötbuf
 {

131 
	mfd
;

132 
	midx
;

133 
ssize_t
 
	mªsu…
;

134 
	mîr‹
;

135 
	mbuf
[256];

140 
	$wrôebuf
(
Ârötbuf
 *
b
)

142 i‡(
b
->
îr‹
 > 0) {

143 
ssize_t
 
ªsu…
 = 
	`wrôe
(
b
->
fd
, b->
buf
, b->
idx
);

144 i‡(
ªsu…
 > 0)

145 
b
->
ªsu…
 +=Ñesult;

146 i‡(
ªsu…
 !
b
->
idx
)

147 
b
->
îr‹
 = (
ªsu…
 < 0 ?Ñesult : 0);

149 
	}
}

152 
	$Âutch
(
ch
, *
thunk
)

154 
Ârötbuf
 *
b
 = (Ârötbu‡*Ë
thunk
;

155 
b
->
buf
[b->
idx
++] = 
ch
;

156 i‡(
b
->
idx
 == 256) {

157 
	`wrôebuf
(
b
);

158 
b
->
idx
 = 0;

160 
	}
}

163 
	$vÂrötf
(
fd
, c⁄° *
fmt
, 
va_li°
 
≠
)

165 
Ârötbuf
 
b
;

167 
b
.
fd
 = fd;

168 
b
.
idx
 = 0;

169 
b
.
ªsu…
 = 0;

170 
b
.
îr‹
 = 1;

171 
	`v¥ötfmt
(
Âutch
, &
b
, 
fmt
, 
≠
);

172 i‡(
b
.
idx
 > 0)

173 
	`wrôebuf
(&
b
);

175  (
b
.
ªsu…
 ? b.ªsu… : b.
îr‹
);

176 
	}
}

179 
	$Ârötf
(
fd
, c⁄° *
fmt
, ...)

181 
va_li°
 
≠
;

182 
˙t
;

184 
	`va_°¨t
(
≠
, 
fmt
);

185 
˙t
 = 
	`vÂrötf
(
fd
, 
fmt
, 
≠
);

186 
	`va_íd
(
≠
);

188  
˙t
;

189 
	}
}

192 
	$¥ötf
(c⁄° *
fmt
, ...)

194 
va_li°
 
≠
;

195 
˙t
;

197 
	`va_°¨t
(
≠
, 
fmt
);

198 
˙t
 = 
	`vÂrötf
(1, 
fmt
, 
≠
);

199 
	`va_íd
(
≠
);

201  
˙t
;

202 
	}
}

210 
	$gëuöt
(
va_li°
 *
≠
, 
lÊag
)

212 i‡(
lÊag
 >= 2)

213  
	`va_¨g
(*
≠
, );

214 i‡(
lÊag
)

215  
	`va_¨g
(*
≠
, );

217  
	`va_¨g
(*
≠
, );

218 
	}
}

223 
	$gëöt
(
va_li°
 *
≠
, 
lÊag
)

225 i‡(
lÊag
 >= 2)

226  
	`va_¨g
(*
≠
, );

227 i‡(
lÊag
)

228  
	`va_¨g
(*
≠
, );

230  
	`va_¨g
(*
≠
, );

231 
	}
}

234 
	$¥öäum
((*
putch
)(, *), *
putd©
,

235 
num
, 
ba£
, 
width
, 
∑dc
)

238 i‡(
num
 >
ba£
) {

239 
	`¥öäum
(
putch
, 
putd©
, 
num
 / 
ba£
, ba£, 
width
 - 1, 
∑dc
);

242 --
width
 > 0)

243 
	`putch
(
∑dc
, 
putd©
);

247 
	`putch
("0123456789abcdef"[
num
 % 
ba£
], 
putd©
);

248 
	}
}

251 
	$¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...)

253 
va_li°
 
≠
;

255 
	`va_°¨t
(
≠
, 
fmt
);

256 
	`v¥ötfmt
(
putch
, 
putd©
, 
fmt
, 
≠
);

257 
	`va_íd
(
≠
);

258 
	}
}

261 
	$v¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, 
va_li°
 
≠
)

263 c⁄° *
p
;

264 
ch
, 
îr
;

265 
num
;

266 
ba£
, 
lÊag
, 
width
, 
¥ecisi⁄
, 
ÆtÊag
;

267 
∑dc
;

270 (
ch
 = *(*Ë
fmt
++) != '%') {

271 i‡(
ch
 == '\0')

273 
	`putch
(
ch
, 
putd©
);

277 
∑dc
 = ' ';

278 
width
 = -1;

279 
¥ecisi⁄
 = -1;

280 
lÊag
 = 0;

281 
ÆtÊag
 = 0;

282 
ªswôch
:

283 
ch
 = *(*Ë
fmt
++) {

287 
∑dc
 = '-';

288 
ªswôch
;

292 
∑dc
 = '0';

293 
ªswôch
;

305 
¥ecisi⁄
 = 0; ; ++
fmt
) {

306 
¥ecisi⁄
 =Öªcisi⁄ * 10 + 
ch
 - '0';

307 
ch
 = *
fmt
;

308 i‡(
ch
 < '0' || ch > '9')

311 
¥o˚ss_¥ecisi⁄
;

314 
¥ecisi⁄
 = 
	`va_¨g
(
≠
, );

315 
¥o˚ss_¥ecisi⁄
;

318 i‡(
width
 < 0)

319 
width
 = 0;

320 
ªswôch
;

323 
ÆtÊag
 = 1;

324 
ªswôch
;

326 
¥o˚ss_¥ecisi⁄
:

327 i‡(
width
 < 0)

328 
width
 = 
¥ecisi⁄
,Örecision = -1;

329 
ªswôch
;

333 
lÊag
++;

334 
ªswôch
;

338 
	`putch
(
	`va_¨g
(
≠
, ), 
putd©
);

343 
îr
 = 
	`va_¨g
(
≠
, );

344 i‡(
îr
 < 0)

345 
îr
 = -err;

346 i‡(
îr
 >
MAXERROR
 || (
p
 = 
îr‹_°rög
[îr]Ë=
NULL
)

347 
	`¥ötfmt
(
putch
, 
putd©
, "îr‹ %d", 
îr
);

349 
	`¥ötfmt
(
putch
, 
putd©
, "%s", 
p
);

354 i‡((
p
 = 
	`va_¨g
(
≠
, *)Ë=
NULL
)

355 
p
 = "(null)";

356 i‡(
width
 > 0 && 
∑dc
 != '-')

357 
width
 -
	`°∫Àn
(
p
, 
¥ecisi⁄
); width > 0; width--)

358 
	`putch
(
∑dc
, 
putd©
);

359 ; (
ch
 = *
p
++Ë!'\0' && (
¥ecisi⁄
 < 0 || --¥ecisi⁄ >0); 
width
--)

360 i‡(
ÆtÊag
 && (
ch
 < ' ' || ch > '~'))

361 
	`putch
('?', 
putd©
);

363 
	`putch
(
ch
, 
putd©
);

364 ; 
width
 > 0; width--)

365 
	`putch
(' ', 
putd©
);

370 
num
 = 
	`gëöt
(&
≠
, 
lÊag
);

371 i‡((Ë
num
 < 0) {

372 
	`putch
('-', 
putd©
);

373 
num
 = -()Çum;

375 
ba£
 = 10;

376 
numbî
;

380 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

381 
ba£
 = 10;

382 
numbî
;

387 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

388 
ba£
 = 8;

389 
numbî
;

393 
	`putch
('0', 
putd©
);

394 
	`putch
('x', 
putd©
);

395 
num
 = ()

396 (
uöçå_t
Ë
	`va_¨g
(
≠
, *);

397 
ba£
 = 16;

398 
numbî
;

402 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

403 
ba£
 = 16;

404 
numbî
:

405 
	`¥öäum
(
putch
, 
putd©
, 
num
, 
ba£
, 
width
, 
∑dc
);

410 
	`putch
(
ch
, 
putd©
);

415 
	`putch
('%', 
putd©
);

416 
fmt
--; fmt[-1] != '%'; fmt--)

421 
	}
}

422 
	s•rötbuf
 {

423 *
	mbuf
;

424 *
	mebuf
;

425 
	m˙t
;

429 
	$•röçutch
(
ch
, 
•rötbuf
 *
b
)

431 
b
->
˙t
++;

432 i‡(
b
->
buf
 < b->
ebuf
)

433 *
b
->
buf
++ = 
ch
;

434 
	}
}

437 
	$v¢¥ötf
(*
buf
, 
n
, c⁄° *
fmt
, 
va_li°
 
≠
)

439 
•rötbuf
 
b
 = {
buf
, buf+
n
-1, 0};

441 i‡(
buf
 =
NULL
 || 
n
 < 1)

442  -
E_INVAL
;

445 
	`v¥ötfmt
((*)
•röçutch
, &
b
, 
fmt
, 
≠
);

448 *
b
.
buf
 = '\0';

450  
b
.
˙t
;

451 
	}
}

454 
	$¢¥ötf
(*
buf
, 
n
, c⁄° *
fmt
, ...)

456 
va_li°
 
≠
;

457 
rc
;

459 
	`va_°¨t
(
≠
, 
fmt
);

460 
rc
 = 
	`v¢¥ötf
(
buf
, 
n
, 
fmt
, 
≠
);

461 
	`va_íd
(
≠
);

463  
rc
;

464 
	}
}

467 
	#BUFLEN
 1024

	)

468 
	gbuf
[
BUFLEN
];

471 
	$ªadlöe
(c⁄° *
¥om±
)

473 
i
, 
c
, 
echoög
;

475 #i‚de‡
__FOR_USER__


476 i‡(
¥om±
 !
NULL
)

477 
	`˝rötf
("%s", 
¥om±
);

479 i‡(
¥om±
 !
NULL
)

480 
	`Ârötf
(1, "%s", 
¥om±
);

483 
i
 = 0;

484 
echoög
 = 
	`isc⁄s
(0);

486 
c
 = 
	`gëch¨
();

487 i‡(
c
 < 0) {

488 i‡(
c
 !-
E_EOF
)

489 
	`˝rötf
("ªadÉº‹: %e\n", 
c
);

490  
NULL
;

491 } i‡((
c
 == '\b' || c == '\x7f')) {

492 i‡(
i
 > 0) {

493 i‡(
echoög
)

494 
	`˝utch¨
('\b');

495 
i
--;

497 } i‡(
c
 >' ' && 
i
 < 
BUFLEN
-1) {

498 i‡(
echoög
)

499 
	`˝utch¨
(
c
);

500 
buf
[
i
++] = 
c
;

501 } i‡(
c
 == '\n' || c == '\r') {

502 i‡(
echoög
)

503 
	`˝utch¨
('\n');

504 
buf
[
i
] = 0;

505  
buf
;

508 
	}
}

510 #i‚de‡
__FOR_USER__


512 
	~<m⁄ô‹.h
>

518 
	$_∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
,...)

520 
va_li°
 
≠
;

522 c⁄° * 
∑nic°r
 = 
fmt
;

523 i‡(
∑nic°r
 =
NULL
)

524 
dód
;

527 
__asm
 
	`__vﬁ©ûe
("cli; cld");

529 
	`va_°¨t
(
≠
, 
fmt
);

530 
	`˝rötf
("kî√»∑ni¯© %s:%d: ", 
fûe
, 
löe
);

531 
	`v˝rötf
(
fmt
, 
≠
);

532 
	`˝rötf
("\n");

533 
	`va_íd
(
≠
);

535 
dód
:

538 
	`m⁄ô‹
(
NULL
);

539 
	}
}

548 
	~<sy¶ib.h
>

551 
	$_∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...)

553 
va_li°
 
≠
;

555 
	`va_°¨t
(
≠
, 
fmt
);

558 
	`˝rötf
("[%08x] userÖanic in %sát %s:%d: ",

559 
	`sys_gëívid
(), 
bö¨y«me
, 
fûe
, 
löe
);

560 
	`v˝rötf
(
fmt
, 
≠
);

561 
	`˝rötf
("\n");

565 
asm
 volatile("int3");

566 
	}
}

	@stdio.h

1 #i‚de‡
__STDIO


2 
	#__STDIO


	)

4 
__buûtö_va_li°
 
	tva_li°
;

6 
	#va_°¨t
(
≠
, 
œ°
Ë
	`__buûtö_va_°¨t
◊p,Üa°)

	)

8 
	#va_¨g
(
≠
, 
ty≥
Ë
	`__buûtö_va_¨g
◊p,Åy≥)

	)

10 
	#va_íd
(
≠
Ë
	`__buûtö_va_íd
◊p)

	)

12 #i‚de‡
NULL


13 
	#NULL
 ((*Ë0)

	)

17 
˝utch¨
(
c
);

18 
gëch¨
();

19 
isc⁄s
(
fd
);

21 
¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...);

22 
	`v¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, 
va_li°
);

23 
	`¢¥ötf
(*
°r
, 
size
, c⁄° *
fmt
, ...);

24 
	`v¢¥ötf
(*
°r
, 
size
, c⁄° *
fmt
, 
va_li°
);

26 
	`˝rötf
(c⁄° *
fmt
, ...);

27 
	`v˝rötf
(c⁄° *
fmt
, 
va_li°
);

29 
	`¥ötf
(c⁄° *
fmt
, ...);

30 
	`Ârötf
(
fd
, c⁄° *
fmt
, ...);

31 
	`vÂrötf
(
fd
, c⁄° *
fmt
, 
va_li°
);

33 * 
	`ªadlöe
(c⁄° *
¥om±
);

35 
	$_∑nic
(c⁄° *, , c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

36 
	#∑nic
(...Ë
	`_∑nic
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

	@string.c

2 
	~<x86.h
>

3 
	#ASM
 1

	)

6 
	$°æí
(c⁄° *
s
)

8 
n
;

10 
n
 = 0; *
s
 != '\0'; s++)

11 
n
++;

12  
n
;

13 
	}
}

16 
	$°∫Àn
(c⁄° *
s
, 
size_t
 
size
)

18 
n
;

20 
n
 = 0; 
size
 > 0 && *
s
 != '\0'; s++, size--)

21 
n
++;

22  
n
;

23 
	}
}

26 
	$°r˝y
(*
d°
, c⁄° *
§c
)

28 *
ªt
;

30 
ªt
 = 
d°
;

31 (*
d°
++ = *
§c
++) != '\0')

33  
ªt
;

34 
	}
}

37 
	$°rˇt
(*
d°
, c⁄° *
§c
)

39 
Àn
 = 
	`°æí
(
d°
);

40 
	`°r˝y
(
d°
 + 
Àn
, 
§c
);

41  
d°
;

42 
	}
}

45 
	$°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
) {

46 
size_t
 
i
;

47 *
ªt
;

49 
ªt
 = 
d°
;

50 
i
 = 0; i < 
size
; i++) {

51 *
d°
++ = *
§c
;

53 i‡(*
§c
 != '\0')

54 
§c
++;

56  
ªt
;

57 
	}
}

59 
size_t


60 
	$°æ˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
)

62 *
d°_ö
;

64 
d°_ö
 = 
d°
;

65 i‡(
size
 > 0) {

66 --
size
 > 0 && *
§c
 != '\0')

67 *
d°
++ = *
§c
++;

68 *
d°
 = '\0';

70  
d°
 - 
d°_ö
;

71 
	}
}

74 
	$°rcmp
(c⁄° *
p
, c⁄° *
q
)

76 *
p
 && *∞=*
q
)

77 
p
++, 
q
++;

78  (Ë((Ë*
p
 - (Ë*
q
);

79 
	}
}

82 
	$°∫cmp
(c⁄° *
p
, c⁄° *
q
, 
size_t
 
n
)

84 
n
 > 0 && *
p
 && *∞=*
q
)

85 
n
--, 
p
++, 
q
++;

86 i‡(
n
 == 0)

89  (Ë((Ë*
p
 - (Ë*
q
);

90 
	}
}

95 
	$°rchr
(c⁄° *
s
, 
c
)

97 ; *
s
; s++)

98 i‡(*
s
 =
c
)

99  (*Ë
s
;

101 
	}
}

106 
	$°rföd
(c⁄° *
s
, 
c
)

108 ; *
s
; s++)

109 i‡(*
s
 =
c
)

111  (*Ë
s
;

112 
	}
}

114 #i‡
ASM


116 
	$mem£t
(*
v
, 
c
, 
size_t
 
n
)

119 i‡(
n
 == 0)

120  
v
;

121 i‡(()
v
%4 =0 && 
n
%4 == 0) {

122 
c
 &= 0xFF;

123 
c
 = (c<<24)|(c<<16)|(c<<8)|c;

124 
asm
 volatile("cld;Ñep stosl\n"

125 :: "D" (
v
), "a" (
c
), "c" (
n
/4)

128 
asm
 volatile("cld;Ñep stosb\n"

129 :: "D" (
v
), "a" (
c
), "c" (
n
)

131  
v
;

132 
	}
}

135 
	$memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

137 c⁄° *
s
;

138 *
d
;

140 
s
 = 
§c
;

141 
d
 = 
d°
;

142 i‡(
s
 < 
d
 && s + 
n
 > d) {

143 
s
 +
n
;

144 
d
 +
n
;

145 i‡(()
s
%4 =0 && ()
d
%4 =0 && 
n
%4 == 0)

146 
asm
 volatile("std;Ñep movsl\n"

147 :: "D" (
d
-4), "S" (
s
-4), "c" (
n
/4) : "cc", "memory");

149 
asm
 volatile("std;Ñep movsb\n"

150 :: "D" (
d
-1), "S" (
s
-1), "c" (
n
) : "cc", "memory");

152 
asm
 volatile("cld" ::: "cc");

154 i‡(()
s
%4 =0 && ()
d
%4 =0 && 
n
%4 == 0)

155 
asm
 volatile("cld;Ñep movsl\n"

156 :: "D" (
d
), "S" (
s
), "c" (
n
/4) : "cc", "memory");

158 
asm
 volatile("cld;Ñep movsb\n"

159 :: "D" (
d
), "S" (
s
), "c" (
n
) : "cc", "memory");

161  
d°
;

162 
	}
}

167 
	$mem£t
(*
v
, 
c
, 
size_t
 
n
)

169 *
p
;

170 
m
;

172 
p
 = 
v
;

173 
m
 = 
n
;

174 --
m
 >= 0)

175 *
p
++ = 
c
;

177  
v
;

178 
	}
}

181 
	$memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

183 c⁄° *
s
;

184 *
d
;

186 
s
 = 
§c
;

187 
d
 = 
d°
;

188 i‡(
s
 < 
d
 && s + 
n
 > d) {

189 
s
 +
n
;

190 
d
 +
n
;

191 
n
-- > 0)

192 *--
d
 = *--
s
;

194 
n
-- > 0)

195 *
d
++ = *
s
++;

197  
d°
;

198 
	}
}

202 
	$mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

204  
	`memmove
(
d°
, 
§c
, 
n
);

205 
	}
}

208 
	$memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
size_t
 
n
)

210 c⁄° 
uöt8_t
 *
s1
 = (c⁄° uöt8_à*Ë
v1
;

211 c⁄° 
uöt8_t
 *
s2
 = (c⁄° uöt8_à*Ë
v2
;

213 
n
-- > 0) {

214 i‡(*
s1
 !*
s2
)

215  (Ë*
s1
 - (Ë*
s2
;

216 
s1
++, 
s2
++;

220 
	}
}

223 
	$memföd
(c⁄° *
s
, 
c
, 
size_t
 
n
)

225 c⁄° *
íds
 = (c⁄° *Ë
s
 + 
n
;

226 ; 
s
 < 
íds
; s++)

227 i‡(*(c⁄° *Ë
s
 =(Ë
c
)

229  (*Ë
s
;

230 
	}
}

233 
	$°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
)

235 
√g
 = 0;

236 
vÆ
 = 0;

239 *
s
 == ' ' || *s == '\t')

240 
s
++;

243 i‡(*
s
 == '+')

244 
s
++;

245 i‡(*
s
 == '-')

246 
s
++, 
√g
 = 1;

249 i‡((
ba£
 =0 || ba£ =16Ë&& (
s
[0] == '0' && s[1] == 'x'))

250 
s
 +2, 
ba£
 = 16;

251 i‡(
ba£
 =0 && 
s
[0] == '0')

252 
s
++, 
ba£
 = 8;

253 i‡(
ba£
 == 0)

254 
ba£
 = 10;

258 
dig
;

260 i‡(*
s
 >= '0' && *s <= '9')

261 
dig
 = *
s
 - '0';

262 i‡(*
s
 >= 'a' && *s <= 'z')

263 
dig
 = *
s
 - 'a' + 10;

264 i‡(*
s
 >= 'A' && *s <= 'Z')

265 
dig
 = *
s
 - 'A' + 10;

268 i‡(
dig
 >
ba£
)

270 
s
++, 
vÆ
 = (vÆ * 
ba£
Ë+ 
dig
;

274 i‡(
íd±r
)

275 *
íd±r
 = (*Ë
s
;

276  (
√g
 ? -
vÆ
 : val);

277 
	}
}

	@string.h

1 #i‚de‡
__STRING


2 
	#__STRING


	)

4 
	~<x86.h
>

6 
°æí
(c⁄° *
s
);

7 
°∫Àn
(c⁄° *
s
, 
size_t
 
size
);

8 * 
°r˝y
(*
d°
, c⁄° *
§c
);

9 * 
°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
);

10 * 
°rˇt
(*
d°
, c⁄° *
§c
);

11 
size_t
 
°æ˝y
(*
d°
, c⁄° *
§c
, size_à
size
);

12 
°rcmp
(c⁄° *
s1
, c⁄° *
s2
);

13 
°∫cmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
size
);

14 * 
°rchr
(c⁄° *
s
, 
c
);

15 * 
°rföd
(c⁄° *
s
, 
c
);

17 * 
mem£t
(*
d°
, 
c
, 
size_t
 
Àn
);

18 * 
mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

19 * 
memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

20 
memcmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
);

21 * 
memföd
(c⁄° *
s
, 
c
, 
size_t
 
Àn
);

23 
°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
);

	@syscall.c

2 
	~<sy¶ib.h
>

4 
ölöe
 
öt32_t


5 
	$sysˇŒ
(
num
, 
check
, 
uöt32_t
 
a1
, uöt32_à
a2
, uöt32_à
a3
, uöt32_à
a4
, uöt32_à
a5
)

7 
öt32_t
 
ªt
;

21 
asm
 volatile("int %1\n"

22 : "˜" (
ªt
)

23 : "i" (
T_SYSCALL
),

24 "a" (
num
),

25 "d" (
a1
),

26 "c" (
a2
),

27 "b" (
a3
),

28 "D" (
a4
),

29 "S" (
a5
)

32 if(
check
 && 
ªt
 > 0)

33 
	`∑nic
("sysˇŒ %dÑëu∫ed %d (> 0)", 
num
, 
ªt
);

35  
ªt
;

36 
	}
}

39 
	$sys_˝uts
(c⁄° *
s
, 
size_t
 
Àn
)

41 
	`sysˇŒ
(
SYS_˝uts
, 0, (
uöt32_t
)
s
, 
Àn
, 0, 0, 0);

42 
	}
}

45 
	$sys_cgëc
()

47  
	`sysˇŒ
(
SYS_cgëc
, 0, 0, 0, 0, 0, 0);

48 
	}
}

51 
	$sys_ív_de°roy
(
ívid_t
 
ívid
)

53  
	`sysˇŒ
(
SYS_ív_de°roy
, 1, 
ívid
, 0, 0, 0, 0);

54 
	}
}

56 
ívid_t


57 
	$sys_gëívid
()

59  
	`sysˇŒ
(
SYS_gëívid
, 0, 0, 0, 0, 0, 0);

60 
	}
}

63 
	$sys_yõld
()

65 
	`sysˇŒ
(
SYS_yõld
, 0, 0, 0, 0, 0, 0);

66 
	}
}

69 
	$sys_∑ge_Æloc
(
ívid_t
 
ívid
, *
va
, 
≥rm
)

71  
	`sysˇŒ
(
SYS_∑ge_Æloc
, 1, 
ívid
, (
uöt32_t
Ë
va
, 
≥rm
, 0, 0);

72 
	}
}

75 
	$sys_∑ge_m≠
(
ívid_t
 
§˚nv
, *
§cva
,Énvid_à
d°ív
, *
d°va
, 
≥rm
)

77  
	`sysˇŒ
(
SYS_∑ge_m≠
, 1, 
§˚nv
, (
uöt32_t
Ë
§cva
, 
d°ív
, (uöt32_tË
d°va
, 
≥rm
);

78 
	}
}

81 
	$sys_∑ge_unm≠
(
ívid_t
 
ívid
, *
va
)

83  
	`sysˇŒ
(
SYS_∑ge_unm≠
, 1, 
ívid
, (
uöt32_t
Ë
va
, 0, 0, 0);

84 
	}
}

89 
	$sys_ív_£t_°©us
(
ívid_t
 
ívid
, 
°©us
)

91  
	`sysˇŒ
(
SYS_ív_£t_°©us
, 1, 
ívid
, 
°©us
, 0, 0, 0);

92 
	}
}

95 
	$sys_ív_£t_å≠‰ame
(
ívid_t
 
ívid
, 
Tøp‰ame
 *
tf
)

97  
	`sysˇŒ
(
SYS_ív_£t_å≠‰ame
, 1, 
ívid
, (
uöt32_t
Ë
tf
, 0, 0, 0);

98 
	}
}

101 
	$sys_ív_£t_pgÁu…_upˇŒ
(
ívid_t
 
ívid
, *
upˇŒ
)

103  
	`sysˇŒ
(
SYS_ív_£t_pgÁu…_upˇŒ
, 1, 
ívid
, (
uöt32_t
Ë
upˇŒ
, 0, 0, 0);

104 
	}
}

107 
	$sys_ùc_åy_£nd
(
ívid_t
 
ívid
, 
uöt32_t
 
vÆue
, *
§cva
, 
≥rm
)

109  
	`sysˇŒ
(
SYS_ùc_åy_£nd
, 0, 
ívid
, 
vÆue
, (
uöt32_t
Ë
§cva
, 
≥rm
, 0);

110 
	}
}

113 
	$sys_ùc_ªcv
(*
d°va
)

115  
	`sysˇŒ
(
SYS_ùc_ªcv
, 1, (
uöt32_t
)
d°va
, 0, 0, 0, 0);

116 
	}
}

	@syslib.h

1 #i‚de‡
__SYSLIB


2 
	#__SYSLIB


	)

5 
	~<x86.h
>

6 
	~<utû.h
>

7 
	~<°dio.h
>

8 
	~<°rög.h
>

9 
	~<îr‹.h
>

11 
	~<pm≠.h
>

12 
	~<å≠.h
>

13 
	~<ív.h
>

14 
	~<damnfs.h
>

15 
	~<fd.h
>

16 
	~<¨gs.h
>

19 
	#USED
(
x
Ë()(x)

	)

22 
umaö
(
¨gc
, **
¨gv
);

25 c⁄° *
bö¨y«me
;

26 c⁄° vﬁ©ûê
Env
 *
thi£nv
;

27 c⁄° vﬁ©ûê
Env
 
ívs
[
NENV
];

28 c⁄° vﬁ©ûê
PageInfo
 
∑ges
[];

29 vﬁ©ûê
±e_t
 
uv±
[];

30 vﬁ©ûê
pde_t
 
uvpd
[];

32 
∑gîef
(*);

35 
exô
();

38 
£t_pgÁu…_h™dÀr
((*
h™dÀr
)(
UTøp‰ame
 *
utf
));

41 
	`sys_˝uts
(c⁄° *
°rög
, 
size_t
 
Àn
);

42 
	`sys_cgëc
();

43 
ívid_t
 
	`sys_gëívid
();

44 
	`sys_ív_de°roy
(
ívid_t
);

45 
	`sys_yõld
();

46 
ívid_t
 
	`sys_exof‹k
();

47 
	`sys_ív_£t_°©us
(
ívid_t
 
ív
, 
°©us
);

48 
	`sys_ív_£t_å≠‰ame
(
ívid_t
 
ív
, 
Tøp‰ame
 *
tf
);

49 
	`sys_ív_£t_pgÁu…_upˇŒ
(
ívid_t
 
ív
, *
upˇŒ
);

50 
	`sys_∑ge_Æloc
(
ívid_t
 
ív
, *
pg
, 
≥rm
);

51 
	`sys_∑ge_m≠
(
ívid_t
 
§c_ív
, *
§c_pg
,

52 
ívid_t
 
d°_ív
, *
d°_pg
, 
≥rm
);

53 
	`sys_∑ge_unm≠
(
ívid_t
 
ív
, *
pg
);

54 
	`sys_ùc_åy_£nd
(
ívid_t
 
to_ív
, 
uöt32_t
 
vÆue
, *
pg
, 
≥rm
);

55 
	`sys_ùc_ªcv
(*
rcv_pg
);

58 
__ölöe
 
ívid_t
 
	`__©åibuã__
((
Æways_ölöe
))

59 
	$sys_exof‹k
()

61 
ívid_t
 
ªt
;

62 
__asm
 
	`__vﬁ©ûe
("int %2"

63 : "˜" (
ªt
)

64 : "a" (
SYS_exof‹k
),

65 "i" (
T_SYSCALL
)

67  
ªt
;

68 
	}
}

71 
ùc_£nd
(
ívid_t
 
to_ív
, 
uöt32_t
 
vÆue
, *
pg
, 
≥rm
);

72 
öt32_t
 
ùc_ªcv
(
ívid_t
 *
‰om_ív_°‹e
, *
pg
, *
≥rm_°‹e
);

73 
ívid_t
 
ùc_föd_ív
(
EnvTy≥
 
ty≥
);

76 
	#PTE_SHARE
 0x400

	)

77 
ívid_t
 
f‹k
();

80 
˛o£
(
fd
);

81 
ssize_t
 
ªad
(
fd
, *
buf
, 
size_t
 
nbyãs
);

82 
ssize_t
 
wrôe
(
fd
, c⁄° *
buf
, 
size_t
 
nbyãs
);

83 
£ek
(
fd
, 
off_t
 
off£t
);

84 
˛o£_Æl
();

85 
ssize_t
 
ªadn
(
fd
, *
buf
, 
size_t
 
nbyãs
);

86 
dup
(
ﬁdfd
, 
√wfd
);

87 
f°©
(
fd
, 
Sèt
 *
°©buf
);

88 
°©
(c⁄° *
∑th
, 
Sèt
 *
°©buf
);

91 
›í
(c⁄° *
∑th
, 
mode
);

92 
makedú
(c⁄° * 
∑th
);

93 
ªmove
(c⁄° * 
∑th
);

94 
·runˇã
(
fd
, 
off_t
 
size
);

95 
ªmove
(c⁄° *
∑th
);

96 
sync
();

99 
ívid_t
 
•awn
(c⁄° *
¥ogøm
, c⁄° **
¨gv
);

100 
ívid_t
 
•aw∆
(c⁄° *
¥ogøm
, c⁄° *
¨g0
, ...);

103 
˝utch¨
(
c
);

104 
gëch¨
();

105 
isc⁄s
(
fd
);

106 
›íc⁄s
();

109 
pùe
(
pùefds
[2]);

110 
pùeis˛o£d
(
pùefd
);

113 
waô
(
ívid_t
 
ív
);

116 
	#O_RDONLY
 0x0000

	)

117 
	#O_WRONLY
 0x0001

	)

118 
	#O_RDWR
 0x0002

	)

119 
	#O_ACCMODE
 0x0003

	)

121 
	#O_CREAT
 0x0100

	)

122 
	#O_TRUNC
 0x0200

	)

123 
	#O_EXCL
 0x0400

	)

124 
	#O_MKDIR
 0x0800

	)

	@trap.c

1 
	~<x86.h
>

2 
	~<utû.h
>

3 
	~<pm≠.h
>

4 
	~<c⁄sﬁe.h
>

5 
	~<m⁄ô‹.h
>

6 
	~<°dio.h
>

7 
	~<å≠.h
>

8 
	~<ív.h
>

9 
	~<sched.h
>

10 
	~<•ölock.h
>

11 
	~<°rög.h
>

13 
Task°©e
 
	gts
;

19 
Tøp‰ame
 *
	gœ°_tf
;

24 
G©edesc
 
	gidt
[256] = { { 0 } };

25 
P£udodesc
 
	gidt_pd
 = {

26 (
idt
Ë- 1, (
uöt32_t
) idt

29 
öt32_t
 
sysˇŒ
(
uöt32_t
 
num
, uöt32_à
a1
, uöt32_à
a2
, uöt32_à
a3
, uöt32_à
a4
, uöt32_à
a5
);

33 c⁄° *
	$å≠«me
(
å≠no
)

35 c⁄° * c⁄° 
ex˙ames
[] = {

58 i‡(
å≠no
 < (
ex˙ames
)/(excnames[0]))

59  
ex˙ames
[
å≠no
];

60 i‡(
å≠no
 =
T_SYSCALL
)

62 i‡(
å≠no
 >
IRQ_OFFSET
 &&Årapno < IRQ_OFFSET + 16)

65 
	}
}

67 
å≠_h™dÀ0
();

68 
å≠_h™dÀ1
();

69 
å≠_h™dÀ2
();

70 
å≠_h™dÀ3
();

71 
å≠_h™dÀ4
();

72 
å≠_h™dÀ5
();

73 
å≠_h™dÀ6
();

74 
å≠_h™dÀ7
();

75 
å≠_h™dÀ8
();

76 
å≠_h™dÀ10
();

77 
å≠_h™dÀ11
();

78 
å≠_h™dÀ12
();

79 
å≠_h™dÀ13
();

80 
å≠_h™dÀ14
();

81 
å≠_h™dÀ16
();

82 
å≠_h™dÀ17
();

83 
å≠_h™dÀ18
();

84 
å≠_h™dÀ19
();

85 
å≠_h™dÀ_sysˇŒ
();

87 
å≠_h™dÀ_timî
();

90 
	$å≠_öô
()

92 
Segdesc
 
gdt
[];

95 
	`SETGATE
(
idt
[0], 0, 
GD_KT
, 
å≠_h™dÀ0
, 0);

96 
	`SETGATE
(
idt
[1], 0, 
GD_KT
, 
å≠_h™dÀ1
, 0);

97 
	`SETGATE
(
idt
[2], 0, 
GD_KT
, 
å≠_h™dÀ2
, 0);

98 
	`SETGATE
(
idt
[3], 0, 
GD_KT
, 
å≠_h™dÀ3
, 3);

99 
	`SETGATE
(
idt
[4], 0, 
GD_KT
, 
å≠_h™dÀ4
, 0);

100 
	`SETGATE
(
idt
[5], 0, 
GD_KT
, 
å≠_h™dÀ5
, 0);

101 
	`SETGATE
(
idt
[6], 0, 
GD_KT
, 
å≠_h™dÀ6
, 0);

102 
	`SETGATE
(
idt
[7], 0, 
GD_KT
, 
å≠_h™dÀ7
, 0);

103 
	`SETGATE
(
idt
[8], 0, 
GD_KT
, 
å≠_h™dÀ8
, 0);

104 
	`SETGATE
(
idt
[10], 0, 
GD_KT
, 
å≠_h™dÀ10
, 0);

105 
	`SETGATE
(
idt
[11], 0, 
GD_KT
, 
å≠_h™dÀ11
, 0);

106 
	`SETGATE
(
idt
[12], 0, 
GD_KT
, 
å≠_h™dÀ12
, 0);

107 
	`SETGATE
(
idt
[13], 0, 
GD_KT
, 
å≠_h™dÀ13
, 0);

108 
	`SETGATE
(
idt
[14], 0, 
GD_KT
, 
å≠_h™dÀ14
, 0);

109 
	`SETGATE
(
idt
[16], 0, 
GD_KT
, 
å≠_h™dÀ16
, 0);

110 
	`SETGATE
(
idt
[17], 0, 
GD_KT
, 
å≠_h™dÀ17
, 0);

111 
	`SETGATE
(
idt
[18], 0, 
GD_KT
, 
å≠_h™dÀ18
, 0);

112 
	`SETGATE
(
idt
[19], 0, 
GD_KT
, 
å≠_h™dÀ19
, 0);

114 
	`SETGATE
(
idt
[
T_SYSCALL
], 1, 
GD_KT
, 
å≠_h™dÀ_sysˇŒ
, 3);

116 
	`SETGATE
(
idt
[
IRQ_OFFSET
 + 
IRQ_TIMER
], 0, 
GD_KT
, 
å≠_h™dÀ_timî
, 0);

118 
	`å≠_öô_≥r˝u
();

119 
	}
}

123 
	$å≠_öô_≥r˝u
()

127 
ts
.
ts_e•0
 = 
KSTACKTOP
;

128 
ts
.
ts_ss0
 = 
GD_KD
;

131 
gdt
[
GD_TSS0
 >> 3] = 
	`SEG16
(
STS_T32A
, (
uöt32_t
Ë(&
ts
),

132 (
Task°©e
), 0);

133 
gdt
[
GD_TSS0
 >> 3].
sd_s
 = 0;

137 
	`…r
(
GD_TSS0
);

140 
	`lidt
(&
idt_pd
);

141 
	}
}

144 
	$¥öt_å≠‰ame
(
Tøp‰ame
 *
tf
)

146 
	`˝rötf
("TRAP fømê© %p\n", 
tf
);

147 
	`¥öt_ªgs
(&
tf
->
tf_ªgs
);

148 
	`˝rötf
("É† 0x----%04x\n", 
tf
->
tf_es
);

149 
	`˝rötf
(" d† 0x----%04x\n", 
tf
->
tf_ds
);

150 
	`˝rötf
("Åø∞0x%08x %s\n", 
tf
->
tf_å≠no
, 
	`å≠«me
(tf->tf_trapno));

153 i‡(
tf
 =
œ°_tf
 &&Åf->
tf_å≠no
 =
T_PGFLT
)

154 
	`˝rötf
(" cr2 0x%08x\n", 
	`r¸2
());

155 
	`˝rötf
("Éº 0x%08x", 
tf
->
tf_îr
);

160 i‡(
tf
->
tf_å≠no
 =
T_PGFLT
)

161 
	`˝rötf
(" [%s, %s, %s]\n",

162 
tf
->
tf_îr
 & 4 ? "user" : "kernel",

163 
tf
->
tf_îr
 & 2 ? "write" : "read",

164 
tf
->
tf_îr
 & 1 ? "protection" : "not-present");

166 
	`˝rötf
("\n");

167 
	`˝rötf
("Éù 0x%08x\n", 
tf
->
tf_eù
);

168 
	`˝rötf
(" c† 0x----%04x\n", 
tf
->
tf_cs
);

169 
	`˝rötf
(" fœg 0x%08x\n", 
tf
->
tf_eÊags
);

170 i‡((
tf
->
tf_cs
 & 3) != 0) {

171 
	`˝rötf
("É• 0x%08x\n", 
tf
->
tf_e•
);

172 
	`˝rötf
(" s† 0x----%04x\n", 
tf
->
tf_ss
);

174 
	}
}

177 
	$¥öt_ªgs
(
PushRegs
 *
ªgs
)

179 
	`˝rötf
("Édò 0x%08x\n", 
ªgs
->
ªg_edi
);

180 
	`˝rötf
("Ésò 0x%08x\n", 
ªgs
->
ªg_esi
);

181 
	`˝rötf
("Éb∞ 0x%08x\n", 
ªgs
->
ªg_ebp
);

182 
	`˝rötf
(" oe• 0x%08x\n", 
ªgs
->
ªg_€•
);

183 
	`˝rötf
("Ébx 0x%08x\n", 
ªgs
->
ªg_ebx
);

184 
	`˝rötf
("Édx 0x%08x\n", 
ªgs
->
ªg_edx
);

185 
	`˝rötf
("Écx 0x%08x\n", 
ªgs
->
ªg_ecx
);

186 
	`˝rötf
("Éax 0x%08x\n", 
ªgs
->
ªg_óx
);

187 
	}
}

190 
	$å≠_di•©ch
(
Tøp‰ame
 *
tf
)

193 if(
tf
->
tf_å≠no
 =
T_PGFLT
)

195 
	`∑ge_Áu…_h™dÀr
(
tf
);

198 if(
tf
->
tf_å≠no
 =
T_BRKPT
)

200 
	`m⁄ô‹
(
tf
);

203 if(
tf
->
tf_å≠no
 =
T_SYSCALL
)

206 
öt32_t
 
ãmp_ªt
 = 
	`sysˇŒ
(
tf
->
tf_ªgs
.
ªg_óx
,

207 
tf
->
tf_ªgs
.
ªg_edx
,Åf->tf_ªgs.
ªg_ecx
,Åf->tf_ªgs.
ªg_ebx
,

208 
tf
->
tf_ªgs
.
ªg_edi
,Åf->tf_ªgs.
ªg_esi
);

209 
tf
->
tf_ªgs
.
ªg_óx
 = 
ãmp_ªt
;

216 i‡(
tf
->
tf_å≠no
 =
IRQ_OFFSET
 + 
IRQ_SPURIOUS
) {

217 
	`˝rötf
("Spurious interrupt on irq 7\n");

218 
	`¥öt_å≠‰ame
(
tf
);

224 if(
tf
->
tf_å≠no
 =
IRQ_OFFSET
 + 
IRQ_TIMER
)

227 
	`sched_yõld
();

232 if(
tf
->
tf_å≠no
 =
IRQ_OFFSET
 + 
IRQ_KBD
)

234 
	`kbd_öå
();

237 if(
tf
->
tf_å≠no
 =
IRQ_OFFSET
 + 
IRQ_SERIAL
)

239 
	`£rül_öå
();

244 
	`¥öt_å≠‰ame
(
tf
);

245 i‡(
tf
->
tf_cs
 =
GD_KT
)

246 
	`∑nic
("unhandledÅrap in kernel");

248 
	`ív_de°roy
(
cuªnv
);

251 
	}
}

257 
	$å≠
(
Tøp‰ame
 *
tf
)

261 
asm
 volatile("cld" ::: "cc");

264 i‡((
tf
->
tf_cs
 & 3) == 3) {

268 
	`lock_kî√l
();

271 i‡(
cuªnv
->
ív_°©us
 =
ENV_DYING
) {

272 
	`ív_‰ì
(
cuªnv
);

273 
cuªnv
 = 
NULL
;

274 
	`sched_yõld
();

280 
cuªnv
->
ív_tf
 = *
tf
;

282 
tf
 = &
cuªnv
->
ív_tf
;

286 
œ°_tf
 = 
tf
;

289 
	`å≠_di•©ch
(
tf
);

294 i‡(
cuªnv
 && cuªnv->
ív_°©us
 =
ENV_RUNNING
)

295 
	`ív_run
(
cuªnv
);

297 
	`sched_yõld
();

298 
	}
}

302 
	$∑ge_Áu…_h™dÀr
(
Tøp‰ame
 *
tf
)

304 
uöt32_t
 
Áu…_va
;

307 
Áu…_va
 = 
	`r¸2
();

311 if((
tf
->
tf_cs
 & 0x3) == 0)

312 
	`∑nic
("kernel-modeÖage faults");

346 if(
cuªnv
->
ív_pgÁu…_upˇŒ
)

349 
uöçå_t
 
utf_addr
;

350 if(
tf
->
tf_e•
 >
UXSTACKTOP
 - 
PGSIZE
 &&

351 
tf
->
tf_e•
 <
UXSTACKTOP
 - 1)

352 
utf_addr
 = 
tf
->
tf_e•
 - (
UTøp‰ame
) - 4;

354 
utf_addr
 = 
UXSTACKTOP
 - (
UTøp‰ame
);

356 
UTøp‰ame
 * 
utf
 = (UTøp‰amê*)
utf_addr
;

358 
utf
->
utf_Áu…_va
 = 
Áu…_va
;

359 
utf
->
utf_îr
 = 
tf
->
tf_îr
;

360 
utf
->
utf_ªgs
 = 
tf
->
tf_ªgs
;

361 
utf
->
utf_eù
 = 
tf
->
tf_eù
;

362 
utf
->
utf_eÊags
 = 
tf
->
tf_eÊags
;

363 
utf
->
utf_e•
 = 
tf
->
tf_e•
;

365 
cuªnv
->
ív_tf
.
tf_eù
 = (
uöçå_t
)(cuªnv->
ív_pgÁu…_upˇŒ
);

366 
cuªnv
->
ív_tf
.
tf_e•
 = 
utf_addr
;

367 
	`ív_run
(
cuªnv
);

371 
	`˝rötf
("[%08x] user fault va %08x ip %08x\n",

372 
cuªnv
->
ív_id
, 
Áu…_va
, 
tf
->
tf_eù
);

373 
	`¥öt_å≠‰ame
(
tf
);

374 
	`ív_de°roy
(
cuªnv
);

375 
	}
}

381 
	$sys_˝uts
(c⁄° *
s
, 
size_t
 
Àn
)

384 
	`˝rötf
("%.*s", 
Àn
, 
s
);

385 
	}
}

390 
	$sys_cgëc
()

392  
	`c⁄s_gëc
();

393 
	}
}

396 
ívid_t


397 
	$sys_gëívid
()

399  
cuªnv
->
ív_id
;

400 
	}
}

408 
	$sys_ív_de°roy
(
ívid_t
 
ívid
)

410 
r
;

411 
Env
 *
e
;

413 i‡((
r
 = 
	`ívid2ív
(
ívid
, &
e
, 1)) < 0)

414  
r
;

415 
	`ív_de°roy
(
e
);

417 
	}
}

421 
	$sys_yõld
()

423 
	`sched_yõld
();

424 
	}
}

430 
ívid_t


431 
	$sys_exof‹k
()

439 
Env
 * 
√w_ív
;

441 
ªt_vÆue
 = 
	`ív_Æloc
(&
√w_ív
, 
cuªnv
->
ív_id
);

442 if(
ªt_vÆue
 < 0)

443  
ªt_vÆue
;

445 
√w_ív
->
ív_°©us
 = 
ENV_NOT_RUNNABLE
;

446 
	`mem˝y
(&
√w_ív
->
ív_tf
, &
cuªnv
->ív_tf, (
Tøp‰ame
));

447 
√w_ív
->
ív_tf
.
tf_ªgs
.
ªg_óx
 = 0;

449  
√w_ív
->
ív_id
;

451 
	}
}

461 
	$sys_ív_£t_°©us
(
ívid_t
 
ívid
, 
°©us
)

463 if(
°©us
 !
ENV_RUNNABLE
 && sètu†!
ENV_NOT_RUNNABLE
)

464  -
E_INVAL
;

466 
Env
 * 
ív_°‹e
;

467 if(
	`ívid2ív
(
ívid
, &
ív_°‹e
, 1) < 0)

468  -
E_BAD_ENV
;

470 
ív_°‹e
->
ív_°©us
 = 
°©us
;

473 
	}
}

483 
	$sys_ív_£t_å≠‰ame
(
ívid_t
 
ívid
, 
Tøp‰ame
 *
tf
)

485 
Env
 * 
ív_°‹e
;

486 if(
	`ívid2ív
(
ívid
, &
ív_°‹e
, 1) < 0)

487  -
E_BAD_ENV
;

488 
ív_°‹e
->
ív_tf
 = *
tf
;

489 
ív_°‹e
->
ív_tf
.
tf_eÊags
 |
FL_IF
;

491 
	}
}

502 
	$sys_ív_£t_pgÁu…_upˇŒ
(
ívid_t
 
ívid
, *
func
)

504 
Env
 * 
ív_°‹e
;

505 if(
	`ívid2ív
(
ívid
, &
ív_°‹e
, 1) < 0)

506  -
E_BAD_ENV
;

507 i‡(!
func
)

508  -
E_INVAL
;

510 
ív_°‹e
->
ív_pgÁu…_upˇŒ
 = 
func
;

513 
	}
}

532 
	$sys_∑ge_Æloc
(
ívid_t
 
ívid
, *
va
, 
≥rm
)

534 
Env
 * 
ív_°‹e
;

536 if(
	`ívid2ív
(
ívid
, &
ív_°‹e
, 1) < 0)

537  -
E_BAD_ENV
;

538 if((
uöt32_t
)
va
 >
UTOP
 || ((uöt32_t)v®% 
PGSIZE
 != 0))

539  -
E_INVAL
;

542 if(!(
≥rm
 & 
PTE_U
Ë|| !’îm & 
PTE_P
))

543  -
E_INVAL
;

544 if(
≥rm
 & ~(
PTE_P
 | 
PTE_U
 | 
PTE_W
 | 
PTE_AVAIL
))

545  -
E_INVAL
;

547 
PageInfo
 * 
µ
 = 
	`∑ge_Æloc
(
ALLOC_ZERO
);

548 if(!
µ
 || 
	`∑ge_ö£π
(
ív_°‹e
->
ív_pgdú
,Öp, 
va
, 
≥rm
) < 0) {

549 
	`∑ge_‰ì
(
µ
);

550  -
E_NO_MEM
;

554 
	}
}

573 
	$sys_∑ge_m≠
(
ívid_t
 
§˚nvid
, *
§cva
,

574 
ívid_t
 
d°ívid
, *
d°va
, 
≥rm
)

576 
Env
 * 
§˚nv_°‹e
;

577 if(
	`ívid2ív
(
§˚nvid
, &
§˚nv_°‹e
, 1) < 0)

578  -
E_BAD_ENV
;

579 
Env
 * 
d°ív_°‹e
;

580 if(
	`ívid2ív
(
d°ívid
, &
d°ív_°‹e
, 1) < 0)

581  -
E_BAD_ENV
;

583 if((
uöt32_t
)
§cva
 >
UTOP
 || ((uöt32_t)§cv®% 
PGSIZE
 != 0) ||

584 (
uöt32_t
)
d°va
 >
UTOP
 || ((uöt32_t)d°v®% 
PGSIZE
 != 0))

585  -
E_INVAL
;

588 if(!(
≥rm
 & 
PTE_U
Ë|| !’îm & 
PTE_P
))

589  -
E_INVAL
;

590 if(
≥rm
 & ~(
PTE_P
 | 
PTE_U
 | 
PTE_W
 | 
PTE_AVAIL
))

591  -
E_INVAL
;

593 
±e_t
 * 
±e_°‹e
;

594 
PageInfo
 * 
µ
 = 
	`∑ge_lookup
(
§˚nv_°‹e
->
ív_pgdú
,

595 
§cva
, &
±e_°‹e
);

596 if(!
µ
)

597  -
E_INVAL
;

599 if((
≥rm
 & 
PTE_W
Ë&& (()
±e_°‹e
 & PTE_W))

600  -
E_INVAL
;

602 if(
	`∑ge_ö£π
(
d°ív_°‹e
->
ív_pgdú
, 
µ
, 
d°va
, 
≥rm
) < 0)

603  -
E_NO_MEM
;

606 
	}
}

616 
	$sys_∑ge_unm≠
(
ívid_t
 
ívid
, *
va
)

618 
Env
 * 
ív_°‹e
;

619 if(
	`ívid2ív
(
ívid
, &
ív_°‹e
, 1) < 0)

620  -
E_BAD_ENV
;

621 if((
uöt32_t
)
va
 >
UTOP
 || ((uöt32_t)v®% 
PGSIZE
 != 0))

622  -
E_INVAL
;

624 
	`∑ge_ªmove
(
ív_°‹e
->
ív_pgdú
, 
va
);

627 
	}
}

669 
	$sys_ùc_åy_£nd
(
ívid_t
 
ívid
, 
uöt32_t
 
vÆue
, *
§cva
, 
≥rm
)

671 
r
;

672 
Env
 * 
ív_°‹e
;

673 if((
r
 = 
	`ívid2ív
(
ívid
, &
ív_°‹e
, 0)) < 0)

674  
r
;

675 if(
ív_°‹e
->
ív_ùc_ªcvög
 == 0)

676  -
E_IPC_NOT_RECV
;

677 
ív_°‹e
->
ív_ùc_ªcvög
 = 0;

679 if((
uöt32_t
)
§cva
 < 
UTOP
)

682 if(
§cva
 !
	`ROUNDDOWN
(§cva, 
PGSIZE
))

683  -
E_INVAL
;

685 if(!(
≥rm
 & 
PTE_U
Ë|| !’îm & 
PTE_P
))

686  -
E_INVAL
;

687 if(
≥rm
 & ~(
PTE_P
 | 
PTE_U
 | 
PTE_W
 | 
PTE_AVAIL
))

688  -
E_INVAL
;

690 
±e_t
 * 
±e
;

691 
PageInfo
 * 
µ
 = 
	`∑ge_lookup
(
cuªnv
->
ív_pgdú
, 
§cva
, &
±e
);

693 if(!
µ
)

694  -
E_INVAL
;

696 if((
≥rm
 & 
PTE_W
Ë&& !(*
±e
 & PTE_W))

697  -
E_INVAL
;

698 if((
uöt32_t
)
ív_°‹e
->
ív_ùc_d°va
 < 
UTOP
)

700 if((
r
 = 
	`∑ge_ö£π
(
ív_°‹e
->
ív_pgdú
, 
µ
,

701 
ív_°‹e
->
ív_ùc_d°va
, 
≥rm
)) < 0)

703 
ív_°‹e
->
ív_ùc_≥rm
 = 0;

704  
r
;

706 
ív_°‹e
->
ív_ùc_≥rm
 = 
≥rm
;

710 
ív_°‹e
->
ív_ùc_‰om
 = 
cuªnv
->
ív_id
;

711 
ív_°‹e
->
ív_ùc_vÆue
 = 
vÆue
;

712 
ív_°‹e
->
ív_°©us
 = 
ENV_RUNNABLE
;

713 
ív_°‹e
->
ív_tf
.
tf_ªgs
.
ªg_óx
 = 0;

716 
	}
}

730 
	$sys_ùc_ªcv
(*
d°va
)

732 if((
uöt32_t
)
d°va
 < 
UTOP
 &&

733 (
uöt32_t
)
d°va
 % 
PGSIZE
)

734  -
E_INVAL
;

736 
cuªnv
->
ív_ùc_ªcvög
 = 1;

737 
cuªnv
->
ív_ùc_d°va
 = 
d°va
;

738 
cuªnv
->
ív_°©us
 = 
ENV_NOT_RUNNABLE
;

739 
	`sched_yõld
();

741 
	}
}

744 
öt32_t


745 
	$sysˇŒ
(
uöt32_t
 
sysˇŒno
, uöt32_à
a1
, uöt32_à
a2
,

746 
uöt32_t
 
a3
, uöt32_à
a4
, uöt32_à
a5
)

753 
sysˇŒno
) {

756  -
E_INVAL
;

759 
SYS_˝uts
:

760 
	`sys_˝uts
((c⁄° *)
a1
, (
size_t
)
a2
);

762 
SYS_cgëc
:

763  
	`sys_cgëc
();

764 
SYS_gëívid
:

765  (
öt32_t
)
	`sys_gëívid
();

766 
SYS_ív_de°roy
:

767  
	`sys_ív_de°roy
((
ívid_t
)
a1
);

768 
SYS_yõld
:

769 
	`sys_yõld
();

771 
SYS_exof‹k
:

772  
	`sys_exof‹k
();

773 
SYS_ív_£t_°©us
:

774  
	`sys_ív_£t_°©us
((
ívid_t
)
a1
, ()
a2
);

775 
SYS_∑ge_Æloc
:

776  
	`sys_∑ge_Æloc
((
ívid_t
)
a1
, (*)
a2
, ()
a3
);

777 
SYS_∑ge_m≠
:

778  
	`sys_∑ge_m≠
((
ívid_t
)
a1
, (*)
a2
,

779 (
ívid_t
)
a3
, (*)
a4
, ()
a5
);

780 
SYS_∑ge_unm≠
:

781  
	`sys_∑ge_unm≠
((
ívid_t
)
a1
, (*)
a2
);

782 
SYS_ív_£t_pgÁu…_upˇŒ
:

783  
	`sys_ív_£t_pgÁu…_upˇŒ
((
ívid_t
)
a1
, (*)
a2
);

784 
SYS_ùc_åy_£nd
:

785  
	`sys_ùc_åy_£nd
((
ívid_t
)
a1
, (
uöt32_t
)
a2
,

786 (*)
a3
, ()
a4
);

787 
SYS_ùc_ªcv
:

788  
	`sys_ùc_ªcv
((*)
a1
);

789 
SYS_ív_£t_å≠‰ame
:

790  
	`sys_ív_£t_å≠‰ame
((
ívid_t
)
a1
, (
Tøp‰ame
 *)
a2
);

792 
	}
}

	@trap.h

1 #i‚de‡
__TRAP


2 
	#__TRAP


	)

6 
	#T_DIVIDE
 0

7 
	#T_DEBUG
 1

8 
	#T_NMI
 2

9 
	#T_BRKPT
 3

10 
	#T_OFLOW
 4

11 
	#T_BOUND
 5

12 
	#T_ILLOP
 6

13 
	#T_DEVICE
 7

14 
	#T_DBLFLT
 8

16 
	#T_TSS
 10

17 
	#T_SEGNP
 11

18 
	#T_STACK
 12

19 
	#T_GPFLT
 13

20 
	#T_PGFLT
 14

22 
	#T_FPERR
 16

23 
	#T_ALIGN
 17

24 
	#T_MCHK
 18

25 
	#T_SIMDERR
 19

26 

	)

29 
	#T_SYSCALL
 48

30 
	#T_DEFAULT
 500

31 

	)

32 
	#IRQ_OFFSET
 32

33 

	)

35 
	#IRQ_TIMER
 0

	)

36 
	#IRQ_KBD
 1

	)

37 
	#IRQ_SERIAL
 4

	)

38 
	#IRQ_SPURIOUS
 7

	)

39 
	#IRQ_IDE
 14

	)

40 
	#IRQ_ERROR
 19

	)

42 #i‚de‡
__ASSEMBLER__


43 
	~<x86.h
>

44 
	~<utû.h
>

46 
	sPushRegs
 {

48 
uöt32_t
 
	mªg_edi
;

49 
uöt32_t
 
	mªg_esi
;

50 
uöt32_t
 
	mªg_ebp
;

51 
uöt32_t
 
	mªg_€•
;

52 
uöt32_t
 
	mªg_ebx
;

53 
uöt32_t
 
	mªg_edx
;

54 
uöt32_t
 
	mªg_ecx
;

55 
uöt32_t
 
	mªg_óx
;

56 } 
__©åibuã__
((
∑cked
));

58 
	sTøp‰ame
 {

59 
PushRegs
 
	mtf_ªgs
;

60 
uöt16_t
 
	mtf_es
;

61 
uöt16_t
 
	mtf_∑ddög1
;

62 
uöt16_t
 
	mtf_ds
;

63 
uöt16_t
 
	mtf_∑ddög2
;

64 
uöt32_t
 
	mtf_å≠no
;

66 
uöt32_t
 
	mtf_îr
;

67 
uöçå_t
 
	mtf_eù
;

68 
uöt16_t
 
	mtf_cs
;

69 
uöt16_t
 
	mtf_∑ddög3
;

70 
uöt32_t
 
	mtf_eÊags
;

72 
uöçå_t
 
	mtf_e•
;

73 
uöt16_t
 
	mtf_ss
;

74 
uöt16_t
 
	mtf_∑ddög4
;

75 } 
__©åibuã__
((
∑cked
));

77 
	sUTøp‰ame
 {

79 
uöt32_t
 
	mutf_Áu…_va
;

80 
uöt32_t
 
	mutf_îr
;

82 
PushRegs
 
	mutf_ªgs
;

83 
uöçå_t
 
	mutf_eù
;

84 
uöt32_t
 
	mutf_eÊags
;

86 
uöçå_t
 
	mutf_e•
;

87 } 
__©åibuã__
((
∑cked
));

90 #i‚de‡
__FOR_USER__


93 
G©edesc
 
idt
[];

94 
P£udodesc
 
idt_pd
;

96 
å≠_öô
();

97 
å≠_öô_≥r˝u
();

98 
¥öt_ªgs
(
PushRegs
 *
ªgs
);

99 
¥öt_å≠‰ame
(
Tøp‰ame
 *
tf
);

100 
∑ge_Áu…_h™dÀr
(
Tøp‰ame
 *);

101 
backåa˚
(
Tøp‰ame
 *);

	@uconsole.c

2 
	~<°rög.h
>

3 
	~<sy¶ib.h
>

6 
	$˝utch¨
(
ch
)

8 
c
 = 
ch
;

12 
	`sys_˝uts
(&
c
, 1);

13 
	}
}

16 
	$gëch¨
()

18 
c
;

19 
r
;

24 
r
 = 
	`ªad
(0, &
c
, 1);

25 i‡(
r
 < 0)

26  
r
;

27 i‡(
r
 < 1)

28  -
E_EOF
;

29  
c
;

30 
	}
}

37 
ssize_t
 
devc⁄s_ªad
(
Fd
*, *, 
size_t
);

38 
ssize_t
 
devc⁄s_wrôe
(
Fd
*, c⁄° *, 
size_t
);

39 
devc⁄s_˛o£
(
Fd
*);

40 
devc⁄s_°©
(
Fd
*, 
Sèt
*);

42 
Dev
 
	gdevc⁄s
 =

44 .
dev_id
 = 'c',

45 .
	gdev_«me
 = "cons",

46 .
	gdev_ªad
 = 
devc⁄s_ªad
,

47 .
	gdev_wrôe
 = 
devc⁄s_wrôe
,

48 .
	gdev_˛o£
 = 
devc⁄s_˛o£
,

49 .
	gdev_°©
 = 
devc⁄s_°©


53 
	$isc⁄s
(
fdnum
)

55 
r
;

56 
Fd
 *
fd
;

58 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

59  
r
;

60  
fd
->
fd_dev_id
 =
devc⁄s
.
dev_id
;

61 
	}
}

64 
	$›íc⁄s
()

66 
r
;

67 
Fd
* 
fd
;

69 i‡((
r
 = 
	`fd_Æloc
(&
fd
)) < 0)

70  
r
;

71 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
fd
, 
PTE_P
|
PTE_U
|
PTE_W
|
PTE_SHARE
)) < 0)

72  
r
;

73 
fd
->
fd_dev_id
 = 
devc⁄s
.
dev_id
;

74 
fd
->
fd_omode
 = 
O_RDWR
;

75  
	`fd2num
(
fd
);

76 
	}
}

78 
ssize_t


79 
	$devc⁄s_ªad
(
Fd
 *
fd
, *
vbuf
, 
size_t
 
n
)

81 
c
;

83 i‡(
n
 == 0)

86 (
c
 = 
	`sys_cgëc
()) == 0)

87 
	`sys_yõld
();

88 i‡(
c
 < 0)

89  
c
;

90 i‡(
c
 == 0x04)

92 *(*)
vbuf
 = 
c
;

94 
	}
}

96 
ssize_t


97 
	$devc⁄s_wrôe
(
Fd
 *
fd
, c⁄° *
vbuf
, 
size_t
 
n
)

99 
tŸ
, 
m
;

100 
buf
[128];

104 
tŸ
 = 0;ÅŸ < 
n
;ÅŸ +
m
) {

105 
m
 = 
n
 - 
tŸ
;

106 i‡(
m
 > (
buf
) - 1)

107 
m
 = (
buf
) - 1;

108 
	`memmove
(
buf
, (*)
vbuf
 + 
tŸ
, 
m
);

109 
	`sys_˝uts
(
buf
, 
m
);

111  
tŸ
;

112 
	}
}

115 
	$devc⁄s_˛o£
(
Fd
 *
fd
)

117 
	`USED
(
fd
);

120 
	}
}

123 
	$devc⁄s_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
)

125 
	`°r˝y
(
°©
->
°_«me
, "<cons>");

127 
	}
}

	@util.h

1 #i‚de‡
__UTIL


2 
	#__UTIL


	)

12 
	#ROUNDDOWN
(
a
, 
n
) \

14 
uöt32_t
 
__a
 = (uöt32_tË(
a
); \

15 (
	`ty≥of
(
a
)Ë(
__a
 - __®% (
n
)); \

16 })

	)

18 
	#ROUNDUP
(
a
, 
n
) \

20 
uöt32_t
 
__n
 = (uöt32_tË(
n
); \

21 (
	`ty≥of
(
a
)Ë(
	`ROUNDDOWN
((
uöt32_t
Ë◊Ë+ 
__n
 - 1, __n)); \

22 })

	)

25 
	#GD_KT
 0x08

26 
	#GD_KD
 0x10

27 
	#GD_UT
 0x18

28 
	#GD_UD
 0x20

29 
	#GD_TSS0
 0x28

30 

	)

33 
	#CR0_PE
 0x00000001

34 
	#CR0_MP
 0x00000002

35 
	#CR0_EM
 0x00000004

36 
	#CR0_TS
 0x00000008

37 
	#CR0_ET
 0x00000010

38 
	#CR0_NE
 0x00000020

39 
	#CR0_WP
 0x00010000

40 
	#CR0_AM
 0x00040000

41 
	#CR0_NW
 0x20000000

42 
	#CR0_CD
 0x40000000

43 
	#CR0_PG
 0x80000000

44 

	)

45 
	#CR4_PCE
 0x00000100

46 
	#CR4_MCE
 0x00000040

47 
	#CR4_PSE
 0x00000010

48 
	#CR4_DE
 0x00000008

49 
	#CR4_TSD
 0x00000004

50 
	#CR4_PVI
 0x00000002

51 
	#CR4_VME
 0x00000001

52 

	)

54 
	#FL_CF
 0x00000001

55 
	#FL_PF
 0x00000004

56 
	#FL_AF
 0x00000010

57 
	#FL_ZF
 0x00000040

58 
	#FL_SF
 0x00000080

59 
	#FL_TF
 0x00000100

60 
	#FL_IF
 0x00000200

61 
	#FL_DF
 0x00000400

62 
	#FL_OF
 0x00000800

63 
	#FL_IOPL_MASK
 0x00003000

64 
	#FL_IOPL_0
 0x00000000

65 
	#FL_IOPL_1
 0x00001000

66 
	#FL_IOPL_2
 0x00002000

67 
	#FL_IOPL_3
 0x00003000

68 
	#FL_NT
 0x00004000

69 
	#FL_RF
 0x00010000

70 
	#FL_VM
 0x00020000

71 
	#FL_AC
 0x00040000

72 
	#FL_VIF
 0x00080000

73 
	#FL_VIP
 0x00100000

74 
	#FL_ID
 0x00200000

75 

	)

77 
	#FEC_PR
 0x1

78 
	#FEC_WR
 0x2

79 
	#FEC_U
 0x4

80 

	)

82 
	#NPDENTRIES
 1024

83 
	#NPTENTRIES
 1024

84 

	)

85 
	#PGSIZE
 4096

86 
	#PGSHIFT
 12

87 

	)

88 
	#PTSIZE
 (
PGSIZE
*
NPTENTRIES
)

89 
	#PTSHIFT
 22

90 

	)

91 
	#PTXSHIFT
 12

92 
	#PDXSHIFT
 22

93 

	)

96 
	#KERNBASE
 0xF0000000

	)

99 
	#KSTACKTOP
 
KERNBASE


	)

100 
	#KSTKSIZE
 (8*
PGSIZE
)

101 
	#KSTKGAP
 (8*
PGSIZE
)

102 

	)

105 
	#PTE_P
 0x001

106 
	#PTE_W
 0x002

107 
	#PTE_U
 0x004

108 
	#PTE_PWT
 0x008

109 
	#PTE_PCD
 0x010

110 
	#PTE_A
 0x020

111 
	#PTE_D
 0x040

112 
	#PTE_PS
 0x080

113 
	#PTE_G
 0x100

114 

	)

120 
	#PTE_AVAIL
 0xE00

121 

	)

123 
	#PTE_SYSCALL
 (
PTE_AVAIL
 | 
PTE_P
 | 
PTE_W
 | 
PTE_U
)

	)

126 
	#PTE_ADDR
(
±e
Ë((
phyßddr_t
Ë’ãË& ~0xFFF)

	)

131 
	#NPDENTRIES
 1024

132 
	#NPTENTRIES
 1024

133 

	)

138 
	#PGNUM
(
œ
Ë(((
uöçå_t
Ë÷a)Ë>> 
PTXSHIFT
)

	)

141 
	#PDX
(
œ
Ë((((
uöçå_t
Ë÷a)Ë>> 
PDXSHIFT
Ë& 0x3FF)

	)

144 
	#PTX
(
œ
Ë((((
uöçå_t
Ë÷a)Ë>> 
PTXSHIFT
Ë& 0x3FF)

	)

147 
	#PGOFF
(
œ
Ë(((
uöçå_t
Ë÷a)Ë& 0xFFF)

	)

150 
	#PGADDR
(
d
, 
t
, 
o
Ë((*Ë((dË<< 
PDXSHIFT
 | (tË<< 
PTXSHIFT
 | (o)))

	)

158 
	#IOPHYSMEM
 0x0A0000

	)

159 
	#EXTPHYSMEM
 0x100000

	)

161 
	#MMIOLIM
 (
KSTACKTOP
 - 
PTSIZE
)

	)

162 
	#MMIOBASE
 (
MMIOLIM
 - 
PTSIZE
)

	)

168 
	#ULIM
 (
MMIOBASE
)

	)

171 
	#UVPT
 (
ULIM
 - 
PTSIZE
)

	)

173 
	#UPAGES
 (
UVPT
 - 
PTSIZE
)

	)

175 
	#UENVS
 (
UPAGES
 - 
PTSIZE
)

	)

177 
	#UTOP
 
UENVS


	)

179 
	#UXSTACKTOP
 
UTOP


	)

182 
	#USTACKTOP
 (
UTOP
 - 2*
PGSIZE
)

	)

185 
	#UTEXT
 (2*
PTSIZE
)

	)

188 
	#UTEMP
 ((*Ë
PTSIZE
)

	)

191 
	#PFTEMP
 (
UTEMP
 + 
PTSIZE
 - 
PGSIZE
)

	)

193 
	#USTABDATA
 (
PTSIZE
 / 2)

	)

197 
	#IO_RTC
 0x070

	)

199 
	#MC_NVRAM_START
 0xê

	)

200 
	#MC_NVRAM_SIZE
 50

	)

203 
	#NVRAM_BASELO
 (
MC_NVRAM_START
 + 7Ë

	)

204 
	#NVRAM_BASEHI
 (
MC_NVRAM_START
 + 8Ë

	)

206 
	#NVRAM_EXTLO
 (
MC_NVRAM_START
 + 9Ë

	)

207 
	#NVRAM_EXTHI
 (
MC_NVRAM_START
 + 10Ë

	)

210 #ifde‡
__ASSEMBLER__


215 
	#SEG_NULL
 \

216 .
w‹d
 0, 0; \

217 .
byã
 0, 0, 0, 0

	)

218 
	#SEG
(
ty≥
,
ba£
,
lim
) \

219 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

220 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

221 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

225 
	~<x86.h
>

228 
	sSegdesc
 {

229 
	msd_lim_15_0
 : 16;

230 
	msd_ba£_15_0
 : 16;

231 
	msd_ba£_23_16
 : 8;

232 
	msd_ty≥
 : 4;

233 
	msd_s
 : 1;

234 
	msd_d∂
 : 2;

235 
	msd_p
 : 1;

236 
	msd_lim_19_16
 : 4;

237 
	msd_avl
 : 1;

238 
	msd_rsv1
 : 1;

239 
	msd_db
 : 1;

240 
	msd_g
 : 1;

243 
	msd_ba£_31_24
 : 8;

246 
	#SEG_NULL
 (
Segdesc
){ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }

	)

248 
	#SEG_FAULT
 (
Segdesc
){ 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0 }

	)

250 
	#SEG
(
ty≥
, 
ba£
, 
lim
, 
d∂
Ë(
Segdesc
) \

251 { ((
lim
Ë>> 12Ë& 0xffff, (
ba£
) & 0xffff, ((base) >> 16) & 0xff, \

252 
ty≥
, 1, 
d∂
, 1, (Ë(
lim
) >> 28, 0, 0, 1, 1, \

253 (Ë(
ba£
Ë>> 24 }

	)

254 
	#SEG16
(
ty≥
, 
ba£
, 
lim
, 
d∂
Ë(
Segdesc
) \

255 { (
lim
Ë& 0xffff, (
ba£
) & 0xffff, ((base) >> 16) & 0xff, \

256 
ty≥
, 1, 
d∂
, 1, (Ë(
lim
) >> 16, 0, 0, 1, 0, \

257 (Ë(
ba£
Ë>> 24 }

	)

262 
	#STA_X
 0x8

263 
	#STA_E
 0x4

264 
	#STA_C
 0x4

265 
	#STA_W
 0x2

266 
	#STA_R
 0x2

267 
	#STA_A
 0x1

268 

	)

270 
	#STS_T16A
 0x1

271 
	#STS_LDT
 0x2

272 
	#STS_T16B
 0x3

273 
	#STS_CG16
 0x4

274 
	#STS_TG
 0x5

275 
	#STS_IG16
 0x6

276 
	#STS_TG16
 0x7

277 
	#STS_T32A
 0x9

278 
	#STS_T32B
 0xB

279 
	#STS_CG32
 0xC

280 
	#STS_IG32
 0xE

281 
	#STS_TG32
 0xF

282 

	)

286 #i‚de‡
__ASSEMBLER__


289 
	sTask°©e
 {

290 
uöt32_t
 
	mts_lök
;

291 
uöçå_t
 
	mts_e•0
;

292 
uöt16_t
 
	mts_ss0
;

293 
uöt16_t
 
	mts_∑ddög1
;

294 
uöçå_t
 
	mts_e•1
;

295 
uöt16_t
 
	mts_ss1
;

296 
uöt16_t
 
	mts_∑ddög2
;

297 
uöçå_t
 
	mts_e•2
;

298 
uöt16_t
 
	mts_ss2
;

299 
uöt16_t
 
	mts_∑ddög3
;

300 
phyßddr_t
 
	mts_¸3
;

301 
uöçå_t
 
	mts_eù
;

302 
uöt32_t
 
	mts_eÊags
;

303 
uöt32_t
 
	mts_óx
;

304 
uöt32_t
 
	mts_ecx
;

305 
uöt32_t
 
	mts_edx
;

306 
uöt32_t
 
	mts_ebx
;

307 
uöçå_t
 
	mts_e•
;

308 
uöçå_t
 
	mts_ebp
;

309 
uöt32_t
 
	mts_esi
;

310 
uöt32_t
 
	mts_edi
;

311 
uöt16_t
 
	mts_es
;

312 
uöt16_t
 
	mts_∑ddög4
;

313 
uöt16_t
 
	mts_cs
;

314 
uöt16_t
 
	mts_∑ddög5
;

315 
uöt16_t
 
	mts_ss
;

316 
uöt16_t
 
	mts_∑ddög6
;

317 
uöt16_t
 
	mts_ds
;

318 
uöt16_t
 
	mts_∑ddög7
;

319 
uöt16_t
 
	mts_fs
;

320 
uöt16_t
 
	mts_∑ddög8
;

321 
uöt16_t
 
	mts_gs
;

322 
uöt16_t
 
	mts_∑ddög9
;

323 
uöt16_t
 
	mts_ldt
;

324 
uöt16_t
 
	mts_∑ddög10
;

325 
uöt16_t
 
	mts_t
;

326 
uöt16_t
 
	mts_iomb
;

330 
	sG©edesc
 {

331 
	mgd_off_15_0
 : 16;

332 
	mgd_£l
 : 16;

333 
	mgd_¨gs
 : 5;

334 
	mgd_rsv1
 : 3;

335 
	mgd_ty≥
 : 4;

336 
	mgd_s
 : 1;

337 
	mgd_d∂
 : 2;

338 
	mgd_p
 : 1;

339 
	mgd_off_31_16
 : 16;

358 
	#SETGATE
(
g©e
, 
i°øp
, 
£l
, 
off
, 
d∂
) \

360 (
g©e
).
gd_off_15_0
 = (
uöt32_t
Ë(
off
) & 0xffff; \

361 (
g©e
).
gd_£l
 = (
£l
); \

362 (
g©e
).
gd_¨gs
 = 0; \

363 (
g©e
).
gd_rsv1
 = 0; \

364 (
g©e
).
gd_ty≥
 = (
i°øp
Ë? 
STS_TG32
 : 
STS_IG32
; \

365 (
g©e
).
gd_s
 = 0; \

366 (
g©e
).
gd_d∂
 = (
d∂
); \

367 (
g©e
).
gd_p
 = 1; \

368 (
g©e
).
gd_off_31_16
 = (
uöt32_t
Ë(
off
) >> 16; \

369 }

	)

372 
	#SETCALLGATE
(
g©e
, 
£l
, 
off
, 
d∂
) \

374 (
g©e
).
gd_off_15_0
 = (
uöt32_t
Ë(
off
) & 0xffff; \

375 (
g©e
).
gd_£l
 = (
£l
); \

376 (
g©e
).
gd_¨gs
 = 0; \

377 (
g©e
).
gd_rsv1
 = 0; \

378 (
g©e
).
gd_ty≥
 = 
STS_CG32
; \

379 (
g©e
).
gd_s
 = 0; \

380 (
g©e
).
gd_d∂
 = (
d∂
); \

381 (
g©e
).
gd_p
 = 1; \

382 (
g©e
).
gd_off_31_16
 = (
uöt32_t
Ë(
off
) >> 16; \

383 }

	)

386 
	sP£udodesc
 {

387 
uöt16_t
 
	mpd_lim
;

388 
uöt32_t
 
	mpd_ba£
;

389 } 
__©åibuã__
 ((
∑cked
));

407 
	#KEY_HOME
 0xE0

	)

408 
	#KEY_END
 0xE1

	)

409 
	#KEY_UP
 0xE2

	)

410 
	#KEY_DN
 0xE3

	)

411 
	#KEY_LF
 0xE4

	)

412 
	#KEY_RT
 0xE5

	)

413 
	#KEY_PGUP
 0xE6

	)

414 
	#KEY_PGDN
 0xE7

	)

415 
	#KEY_INS
 0xE8

	)

416 
	#KEY_DEL
 0xE9

	)

421 
	#KBSTATP
 0x64

	)

422 
	#KBS_DIB
 0x01

	)

423 
	#KBS_IBF
 0x02

	)

424 
	#KBS_WARM
 0x04

	)

425 
	#KBS_OCMD
 0x08

	)

426 
	#KBS_NOSEC
 0x10

	)

427 
	#KBS_TERR
 0x20

	)

428 
	#KBS_RERR
 0x40

	)

429 
	#KBS_PERR
 0x80

	)

431 
	#KBCMDP
 0x64

	)

432 
	#KBC_RAMREAD
 0x20

	)

433 
	#KBC_RAMWRITE
 0x60

	)

434 
	#KBC_AUXDISABLE
 0xa7

	)

435 
	#KBC_AUXENABLE
 0xa8

	)

436 
	#KBC_AUXTEST
 0xa9

	)

437 
	#KBC_KBDECHO
 0xd2

	)

438 
	#KBC_AUXECHO
 0xd3

	)

439 
	#KBC_AUXWRITE
 0xd4

	)

440 
	#KBC_SELFTEST
 0xØ

	)

441 
	#KBC_KBDTEST
 0xab

	)

442 
	#KBC_KBDDISABLE
 0xad

	)

443 
	#KBC_KBDENABLE
 0x´

	)

444 
	#KBC_PULSE0
 0x„

	)

445 
	#KBC_PULSE1
 0xfd

	)

446 
	#KBC_PULSE2
 0xfb

	)

447 
	#KBC_PULSE3
 0xf7

	)

449 
	#KBDATAP
 0x60

	)

450 
	#KBOUTP
 0x60

	)

452 
	#K_RDCMDBYTE
 0x20

	)

453 
	#K_LDCMDBYTE
 0x60

	)

455 
	#KC8_TRANS
 0x40

	)

456 
	#KC8_MDISABLE
 0x20

	)

457 
	#KC8_KDISABLE
 0x10

	)

458 
	#KC8_IGNSEC
 0x08

	)

459 
	#KC8_CPU
 0x04

	)

460 
	#KC8_MENABLE
 0x02

	)

461 
	#KC8_KENABLE
 0x01

	)

462 
	#CMDBYTE
 (
KC8_TRANS
|
KC8_CPU
|
KC8_MENABLE
|
KC8_KENABLE
)

	)

465 
	#KBC_RESET
 0xFF

	)

466 
	#KBC_RESEND
 0xFE

	)

467 
	#KBC_SETDEFAULT
 0xF6

	)

468 
	#KBC_DISABLE
 0xF5

	)

469 
	#KBC_ENABLE
 0xF4

	)

470 
	#KBC_TYPEMATIC
 0xF3

	)

471 
	#KBC_SETTABLE
 0xF0

	)

472 
	#KBC_MODEIND
 0xED

	)

473 
	#KBC_ECHO
 0xEE

	)

476 
	#KBR_EXTENDED
 0xE0

	)

477 
	#KBR_RESEND
 0xFE

	)

478 
	#KBR_ACK
 0xFA

	)

479 
	#KBR_OVERRUN
 0x00

	)

480 
	#KBR_FAILURE
 0xFD

	)

481 
	#KBR_BREAK
 0xF0

	)

482 
	#KBR_RSTDONE
 0xAA

	)

483 
	#KBR_ECHO
 0xEE

	)

494 #i‚de‡
__ASSEMBLER__


497 
	mSYS_˝uts
 = 0,

498 
	mSYS_cgëc
,

499 
	mSYS_gëívid
,

500 
	mSYS_ív_de°roy
,

501 
	mSYS_∑ge_Æloc
,

502 
	mSYS_∑ge_m≠
,

503 
	mSYS_∑ge_unm≠
,

504 
	mSYS_exof‹k
,

505 
	mSYS_ív_£t_°©us
,

506 
	mSYS_ív_£t_å≠‰ame
,

507 
	mSYS_ív_£t_pgÁu…_upˇŒ
,

508 
	mSYS_yõld
,

509 
	mSYS_ùc_åy_£nd
,

510 
	mSYS_ùc_ªcv
,

511 
	mNSYSCALLS


	@wait.c

1 
	~<sy¶ib.h
>

5 
	$waô
(
ívid_t
 
ívid
)

7 c⁄° vﬁ©ûê
Env
 *
e
;

9 
e
 = &
ívs
[
	`ENVX
(
ívid
)];

10 
e
->
ív_id
 =
ívid
 &&É->
ív_°©us
 !
ENV_FREE
)

11 
	`sys_yõld
();

12 
	}
}

	@x86.h

1 #i‚de‡
__X86


2 
	#__X86


	)

4 
__sig√d
 
	töt8_t
;

5 
	tuöt8_t
;

6 
	töt16_t
;

7 
	tuöt16_t
;

8 
	töt32_t
;

9 
	tuöt32_t
;

10 
	töt64_t
;

11 
	tuöt64_t
;

12 
uöt32_t
 
	tsize_t
;

13 
uöt32_t
 
	t±e_t
;

14 
uöt32_t
 
	tpde_t
;

15 
öt32_t
 
	tívid_t
;

16 
öt32_t
 
	töçå_t
;

17 
uöt32_t
 
	tuöçå_t
;

18 
uöt32_t
 
	tphyßddr_t
;

19 
uöt32_t
 
	tsize_t
;

20 
öt32_t
 
	tssize_t
;

21 
öt32_t
 
	toff_t
;

23 
_Boﬁ
 
	tboﬁ
;

24 íum { 
	mÁl£
, 
	måue
 };

26 #i‚de‡
NULL


27 
	#NULL
 ((*Ë0)

	)

30 
__ölöe
 
	$bªakpoöt
(Ë
	`__©åibuã__
((
Æways_ölöe
));

31 
__ölöe
 
uöt8_t
 
	$öb
(
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

32 
__ölöe
 
	$ösb
(
p‹t
, *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

33 
__ölöe
 
uöt16_t
 
	$öw
(
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

34 
__ölöe
 
	$ösw
(
p‹t
, *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

35 
__ölöe
 
uöt32_t
 
	$öl
(
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

36 
__ölöe
 
	$ö¶
(
p‹t
, *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

37 
__ölöe
 
	$outb
(
p‹t
, 
uöt8_t
 
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

38 
__ölöe
 
	$outsb
(
p‹t
, c⁄° *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

39 
__ölöe
 
	$outw
(
p‹t
, 
uöt16_t
 
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

40 
__ölöe
 
	$outsw
(
p‹t
, c⁄° *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

41 
__ölöe
 
	$out¶
(
p‹t
, c⁄° *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

42 
__ölöe
 
	$oué
(
p‹t
, 
uöt32_t
 
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

43 
__ölöe
 
	$övÕg
(*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

44 
__ölöe
 
	$lidt
(*
p
Ë
	`__©åibuã__
((
Æways_ölöe
));

45 
__ölöe
 
	$Œdt
(
uöt16_t
 
£l
Ë
	`__©åibuã__
((
Æways_ölöe
));

46 
__ölöe
 
	$…r
(
uöt16_t
 
£l
Ë
	`__©åibuã__
((
Æways_ölöe
));

47 
__ölöe
 
	$l¸0
(
uöt32_t
 
vÆ
Ë
	`__©åibuã__
((
Æways_ölöe
));

48 
__ölöe
 
uöt32_t
 
	$r¸0
(Ë
	`__©åibuã__
((
Æways_ölöe
));

49 
__ölöe
 
uöt32_t
 
	$r¸2
(Ë
	`__©åibuã__
((
Æways_ölöe
));

50 
__ölöe
 
	$l¸3
(
uöt32_t
 
vÆ
Ë
	`__©åibuã__
((
Æways_ölöe
));

51 
__ölöe
 
uöt32_t
 
	$r¸3
(Ë
	`__©åibuã__
((
Æways_ölöe
));

52 
__ölöe
 
	$l¸4
(
uöt32_t
 
vÆ
Ë
	`__©åibuã__
((
Æways_ölöe
));

53 
__ölöe
 
uöt32_t
 
	$r¸4
(Ë
	`__©åibuã__
((
Æways_ölöe
));

54 
__ölöe
 
	$ébÊush
(Ë
	`__©åibuã__
((
Æways_ölöe
));

55 
__ölöe
 
uöt32_t
 
	$ªad_eÊags
(Ë
	`__©åibuã__
((
Æways_ölöe
));

56 
__ölöe
 
	$wrôe_eÊags
(
uöt32_t
 
eÊags
Ë
	`__©åibuã__
((
Æways_ölöe
));

57 
__ölöe
 
uöt32_t
 
	$ªad_ebp
(Ë
	`__©åibuã__
((
Æways_ölöe
));

58 
__ölöe
 
uöt32_t
 
	$ªad_e•
(Ë
	`__©åibuã__
((
Æways_ölöe
));

59 
__ölöe
 
	`˝uid
(
uöt32_t
 
öfo
, uöt32_à*
óxp
, uöt32_à*
ebxp
, uöt32_à*
ecxp
, uöt32_à*
edxp
);

60 
__ölöe
 
uöt64_t
 
	$ªad_tsc
(Ë
	`__©åibuã__
((
Æways_ölöe
));

62 
__ölöe
 

63 
	$bªakpoöt
()

65 
__asm
 
	`__vﬁ©ûe
("int3");

66 
	}
}

68 
__ölöe
 
uöt8_t


69 
	$öb
(
p‹t
)

71 
uöt8_t
 
d©a
;

72 
__asm
 
	`__vﬁ©ûe
("öb %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

73  
d©a
;

74 
	}
}

76 
__ölöe
 

77 
	$ösb
(
p‹t
, *
addr
, 
˙t
)

79 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\tinsb" :

80 "=D" (
addr
), "=c" (
˙t
) :

81 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

83 
	}
}

85 
__ölöe
 
uöt16_t


86 
	$öw
(
p‹t
)

88 
uöt16_t
 
d©a
;

89 
__asm
 
	`__vﬁ©ûe
("öw %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

90  
d©a
;

91 
	}
}

93 
__ölöe
 

94 
	$ösw
(
p‹t
, *
addr
, 
˙t
)

96 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\tinsw" :

97 "=D" (
addr
), "=c" (
˙t
) :

98 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

100 
	}
}

102 
__ölöe
 
uöt32_t


103 
	$öl
(
p‹t
)

105 
uöt32_t
 
d©a
;

106 
__asm
 
	`__vﬁ©ûe
("ö»%w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

107  
d©a
;

108 
	}
}

110 
__ölöe
 

111 
	$ö¶
(
p‹t
, *
addr
, 
˙t
)

113 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\tinsl" :

114 "=D" (
addr
), "=c" (
˙t
) :

115 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

117 
	}
}

119 
__ölöe
 

120 
	$outb
(
p‹t
, 
uöt8_t
 
d©a
)

122 
__asm
 
	`__vﬁ©ûe
("outb %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

123 
	}
}

125 
__ölöe
 

126 
	$outsb
(
p‹t
, c⁄° *
addr
, 
˙t
)

128 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\toutsb" :

129 "=S" (
addr
), "=c" (
˙t
) :

130 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

132 
	}
}

134 
__ölöe
 

135 
	$outw
(
p‹t
, 
uöt16_t
 
d©a
)

137 
__asm
 
	`__vﬁ©ûe
("outw %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

138 
	}
}

140 
__ölöe
 

141 
	$outsw
(
p‹t
, c⁄° *
addr
, 
˙t
)

143 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\toutsw" :

144 "=S" (
addr
), "=c" (
˙t
) :

145 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

147 
	}
}

149 
__ölöe
 

150 
	$out¶
(
p‹t
, c⁄° *
addr
, 
˙t
)

152 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\toutsl" :

153 "=S" (
addr
), "=c" (
˙t
) :

154 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

156 
	}
}

158 
__ölöe
 

159 
	$oué
(
p‹t
, 
uöt32_t
 
d©a
)

161 
__asm
 
	`__vﬁ©ûe
("oué %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

162 
	}
}

164 
__ölöe
 

165 
	$övÕg
(*
addr
)

167 
__asm
 
	`__vﬁ©ûe
("övÕg (%0)" : : "r" (
addr
) : "memory");

168 
	}
}

170 
__ölöe
 

171 
	$lidt
(*
p
)

173 
__asm
 
	`__vﬁ©ûe
("lidà(%0)" : : "r" (
p
));

174 
	}
}

176 
__ölöe
 

177 
	$lgdt
(*
p
)

179 
__asm
 
	`__vﬁ©ûe
("lgdà(%0)" : : "r" (
p
));

180 
	}
}

182 
__ölöe
 

183 
	$Œdt
(
uöt16_t
 
£l
)

185 
__asm
 
	`__vﬁ©ûe
("Œdà%0" : : "r" (
£l
));

186 
	}
}

188 
__ölöe
 

189 
	$…r
(
uöt16_t
 
£l
)

191 
__asm
 
	`__vﬁ©ûe
("…∏%0" : : "r" (
£l
));

192 
	}
}

194 
__ölöe
 

195 
	$l¸0
(
uöt32_t
 
vÆ
)

197 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸0" : : "r" (
vÆ
));

198 
	}
}

200 
__ölöe
 
uöt32_t


201 
	$r¸0
()

203 
uöt32_t
 
vÆ
;

204 
__asm
 
	`__vﬁ©ûe
("mov»%%¸0,%0" : "Ù" (
vÆ
));

205  
vÆ
;

206 
	}
}

208 
__ölöe
 
uöt32_t


209 
	$r¸2
()

211 
uöt32_t
 
vÆ
;

212 
__asm
 
	`__vﬁ©ûe
("mov»%%¸2,%0" : "Ù" (
vÆ
));

213  
vÆ
;

214 
	}
}

216 
__ölöe
 

217 
	$l¸3
(
uöt32_t
 
vÆ
)

219 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸3" : : "r" (
vÆ
));

220 
	}
}

222 
__ölöe
 
uöt32_t


223 
	$r¸3
()

225 
uöt32_t
 
vÆ
;

226 
__asm
 
	`__vﬁ©ûe
("mov»%%¸3,%0" : "Ù" (
vÆ
));

227  
vÆ
;

228 
	}
}

230 
__ölöe
 

231 
	$l¸4
(
uöt32_t
 
vÆ
)

233 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸4" : : "r" (
vÆ
));

234 
	}
}

236 
__ölöe
 
uöt32_t


237 
	$r¸4
()

239 
uöt32_t
 
¸4
;

240 
__asm
 
	`__vﬁ©ûe
("mov»%%¸4,%0" : "Ù" (
¸4
));

241  
¸4
;

242 
	}
}

244 
__ölöe
 

245 
	$ébÊush
()

247 
uöt32_t
 
¸3
;

248 
__asm
 
	`__vﬁ©ûe
("mov»%%¸3,%0" : "Ù" (
¸3
));

249 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸3" : : "r" (
¸3
));

250 
	}
}

252 
__ölöe
 
uöt32_t


253 
	$ªad_eÊags
()

255 
uöt32_t
 
eÊags
;

256 
__asm
 
	`__vﬁ©ûe
("pushÊ;Ö›»%0" : "Ù" (
eÊags
));

257  
eÊags
;

258 
	}
}

260 
__ölöe
 

261 
	$wrôe_eÊags
(
uöt32_t
 
eÊags
)

263 
__asm
 
	`__vﬁ©ûe
("push»%0;Ö›Ê" : : "r" (
eÊags
));

264 
	}
}

266 
__ölöe
 
uöt32_t


267 
	$ªad_ebp
()

269 
uöt32_t
 
ebp
;

270 
__asm
 
	`__vﬁ©ûe
("mov»%%ebp,%0" : "Ù" (
ebp
));

271  
ebp
;

272 
	}
}

274 
__ölöe
 
uöt32_t


275 
	$ªad_eù
()

277 
uöt32_t
 
eù
;

278 
__asm
 
	`__vﬁ©ûe
("ˇŒÇext; \
: \
 %0" : "Ù" (
eù
));

281  
eù
;

282 
	}
}

284 
__ölöe
 
uöt32_t


285 
	$ªad_e•
()

287 
uöt32_t
 
e•
;

288 
__asm
 
	`__vﬁ©ûe
("mov»%%e•,%0" : "Ù" (
e•
));

289  
e•
;

290 
	}
}

292 
__ölöe
 

293 
	$˝uid
(
uöt32_t
 
öfo
, uöt32_à*
óxp
, uöt32_à*
ebxp
, uöt32_à*
ecxp
, uöt32_à*
edxp
)

295 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

296 
asm
 volatile("cpuid"

297 : "˜" (
óx
), "=b" (
ebx
), "=c" (
ecx
), "=d" (
edx
)

298 : "a" (
öfo
));

299 i‡(
óxp
)

300 *
óxp
 = 
óx
;

301 i‡(
ebxp
)

302 *
ebxp
 = 
ebx
;

303 i‡(
ecxp
)

304 *
ecxp
 = 
ecx
;

305 i‡(
edxp
)

306 *
edxp
 = 
edx
;

307 
	}
}

309 
__ölöe
 
uöt64_t


310 
	$ªad_tsc
()

312 
uöt64_t
 
tsc
;

313 
__asm
 
	`__vﬁ©ûe
("rdtsc" : "=A" (
tsc
));

314  
tsc
;

315 
	}
}

317 
ölöe
 
uöt32_t


318 
	$xchg
(vﬁ©ûê
uöt32_t
 *
addr
, uöt32_à
√wvÆ
)

320 
uöt32_t
 
ªsu…
;

323 
asm
 volatile("lock; xchgl %0, %1" :

324 "+m" (*
addr
), "˜" (
ªsu…
) :

325 "1" (
√wvÆ
) :

327  
ªsu…
;

328 
	}
}

330 
__ölöe
 

331 
	$hÆt
()

333 
__asm
 
	`__vﬁ©ûe
("hlt");

334 
	}
}

	@
1
.
1
/usr/include
52
419
args.c
args.h
bootutil.h
console.c
console.h
damnfs.c
damnfs.h
elf.h
entrypgdir.c
env.c
env.h
error.h
exit.c
fd.c
fd.h
file.c
fork.c
ide.c
ide.h
init.c
initsh.c
ipc.c
libmain.c
main.c
monitor.c
monitor.h
pageref.c
pgfault.c
picirq.c
picirq.h
pipe.c
pmap.c
pmap.h
sched.c
sched.h
serv.c
sh.c
spawn.c
spinlock.c
spinlock.h
stdio.c
stdio.h
string.c
string.h
syscall.c
syslib.h
trap.c
trap.h
uconsole.c
util.h
wait.c
x86.h
